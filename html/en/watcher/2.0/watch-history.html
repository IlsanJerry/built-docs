<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Monitoring Watch Execution
        | Elasticsearch Watcher [2.0]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Watcher [2.0]" /><link rel="up" href="administering-watcher.html" title="Administering Watcher" /><link rel="prev" href="getting-watcher-statistics.html" title="Getting Watcher Statistics" /><link rel="next" href="managing-watches.html" title="Managing Watches" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Watcher/Reference/2.0" /><meta name="DC.subject" content="Watcher" /><meta name="DC.identifier" content="2.0" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">From version 5.0 onward, Watcher is part of X-Pack. For more information, see 
<a href=https://www.elastic.co/guide/en/elastic-stack-overview/current/xpack-alerting.html>
    Alerting on cluster and index events</a>. </div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Watcher
      [2.0]
    </a></span> » <span class="breadcrumb-link"><a href="administering-watcher.html">Administering Watcher</a></span> » <span class="breadcrumb-node">Monitoring Watch Execution</span></div><div class="navheader"><span class="prev"><a href="getting-watcher-statistics.html">
              « 
              Getting Watcher Statistics</a>
           
        </span><span class="next">
           
          <a href="managing-watches.html">Managing Watches
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="watch-history"></a>Monitoring Watch Execution</h2></div></div></div><p>Whenever a watch is triggered, a <code class="literal">watch_record</code> document is created and added to the watch history
index. A new history index is created daily with a name of the form <code class="literal">.watch_history-YYYY.MM.dd</code>.
You can search the watch history like any other Elasticsearch index or use Kibana to monitor and
visualize watch execution.</p><p>A watch record’s <code class="literal">_source</code> field contains all of the information about the watch execution:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">watch_id</code>       </span></dt><dd>The name of the watch that was triggered.</dd><dt><span class="term"><code class="literal">trigger_event</code>  </span></dt><dd>How the watch was triggered (<code class="literal">manual</code> or <code class="literal">schedule</code>) and the watch’s scheduled
time and actual trigger time.</dd><dt><span class="term"><code class="literal">input</code>          </span></dt><dd>The input type (<code class="literal">http</code>, <code class="literal">search</code>, or <code class="literal">simple</code>) and definition.</dd><dt><span class="term"><code class="literal">condition</code>      </span></dt><dd>The <code class="literal">condition</code> type (<code class="literal">always</code>, <code class="literal">never</code>, or <code class="literal">script</code>) and definition.</dd><dt><span class="term"><code class="literal">state</code>          </span></dt><dd>The state of the watch execution (<code class="literal">execution_not_needed</code>, <code class="literal">executed</code>,
<code class="literal">throttled</code>).</dd><dt><span class="term"><code class="literal">result</code>         </span></dt><dd>The results of each phase of the watch execution. Shows the input payload,
condition status, transform status (if defined), and actions status.</dd></dl></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>While you can perform read operations on the watch history and manage the daily indices as
        needed, you should never perform write operations on a watch history index. If you have
        Shield installed, we recommend only allowing users read access to the watch history index.</p></div></div><h4><a id="monitoring-watches"></a>Monitoring Watches with Kibana</h4><p>You can use Kibana to monitor the watch history and create visualizations of the watches that have
executed over time.</p><p>To monitor watches with Kibana:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Go to the Kibana <span class="strong strong"><strong>Settings &gt; Indices</strong></span> tab. For example,
<code class="literal">http://localhost:5601/#/settings/indices</code>.</li><li class="listitem">Enter <code class="literal">.watch_history*</code> in the <span class="strong strong"><strong>Index name or pattern</strong></span> field.</li><li class="listitem">Click in the <span class="strong strong"><strong>Time field name</strong></span> field and select <code class="literal">trigger_event.triggered_time</code>.</li><li class="listitem">Go to the <span class="strong strong"><strong>Discover</strong></span> tab to see the most recently executed watches.</li></ol></div><p>You can create visualizations and add them to a Kibana dashboard to track what
watches are being triggered and identify trends.</p><p>For example you could create a dashboard to:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">Track triggered watches over time, broken down by top watch.</li><li class="listitem">Identify top senders, priorities, and keywords for email actions.</li><li class="listitem">Identify top webhook targets and status codes.</li></ul></div><p><span class="inlinemediaobject"><img src="images/watcher-kibana-dashboard.png" alt="watcher kibana dashboard" /></span></p><h4><a id="searching-watch-history"></a>Searching the Watch History</h4><p>To get the watch history for a particular day, search that day’s watch history index:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET .watch_history-2015.05.11/_search
{
  "query" : { "match_all" : {}}
}</pre></div><div class="sense_widget" data-snippet="snippets/3.sense"></div><p>To get all of the watch records that reference a particular watch, search the
<code class="literal">watch_id</code> field:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET .watch_history*/_search
{
  "query" : { "match" : { "watch_id": "rss_watch" }}
}</pre></div><div class="sense_widget" data-snippet="snippets/4.sense"></div><p>To get all of the watch records for watches that were throttled, search the
<code class="literal">state</code> field.</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET .watch_history*/_search
{
  "query" : { "match" : { "state": "throttled" }}
}</pre></div><div class="sense_widget" data-snippet="snippets/5.sense"></div><p>To get a date histogram over all triggered watches within a particular
time range.</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET .watch_history*/_search?size=0
{
  "query": {
    "filtered": {
      "query": {
        "match_all": {}
      },
      "filter": {
        "range": {
          "trigger_event.triggered_time": {
            "gte": 1430438400000,
            "lte": 1431820800000
          }
        }
      }
    }
  },
  "aggs": {
    "records_per_minute": {
      "date_histogram": {
        "field": "trigger_event.triggered_time",
        "interval": "1m",
        "min_doc_count": 0,
        "extended_bounds": {
          "min": 1430438400000,
          "max": 1431820800000
        }
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/6.sense"></div><h4><a id="managing-watch-history"></a>Managing Watch History Indexes</h4><p>You should establish a policy for how long you need to keep your watch history indexes. For
example, you might simply delete the daily history indexes after 30 days. If you need to preserve
the history but don’t need to maintain immediate access to it, you can close the index or take a
snapshot and then delete it.</p><p><a class="ulink" href="http://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html" target="_top">Elasticsearch Curator</a>
provides a convenient CLI for managing time-series indices.</p><p>You can also set up a watch to manage your watch history indexes. For example, the following watch
that runs daily and uses a webhook action to delete history indexes older than seven days.</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">PUT _watcher/watch/manage_history
{
  "metadata": {
    "keep_history_days": 7
  },
  "trigger": {
    "schedule": { "daily": { "at" : "00:01" }}
  },
  "input": {
    "simple": {}
  },
  "condition": {
    "always": {}
  },
  "transform": {
    "script" : "return [ indexToDelete : '/.watch_history-' + ctx.execution_time.minusDays(ctx.metadata.keep_history_days + 1).toString('yyyy.MM.dd') ]"
  },
  "actions": {
    "delete_old_index": {
      "webhook": {
        "method": "DELETE",
        "host": "localhost",
        "port": 9200,
        "path": "{{ctx.payload.indexToDelete}}"
      }
    }
  }
}</pre></div><div class="sense_widget" data-snippet="snippets/7.sense"></div></div><div class="navfooter"><span class="prev"><a href="getting-watcher-statistics.html">
              « 
              Getting Watcher Statistics</a>
           
        </span><span class="next">
           
          <a href="managing-watches.html">Managing Watches
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
