<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Automatic setup with apm-agent-attach-standalone.jar
        | APM Java Agent Reference [1.x]
      | Elastic
    </title><link rel="home" href="index.html" title="APM Java Agent Reference [1.x]" /><link rel="up" href="setup.html" title="Set up" /><link rel="prev" href="setup-javaagent.html" title="Manual setup with -javaagent flag" /><link rel="next" href="setup-attach-api.html" title="Programmatic API setup to self-attach" /><meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x" /><meta name="DC.subject" content="APM" /><meta name="DC.identifier" content="1.x" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="setup.html">Set up</a></span> » <span class="breadcrumb-node">Automatic setup with <code class="literal">apm-agent-attach-standalone.jar</code></span></div><div class="navheader"><span class="prev"><a href="setup-javaagent.html">
              « 
              Manual setup with <code class="literal">-javaagent</code> flag</a>
           
        </span><span class="next">
           
          <a href="setup-attach-api.html">Programmatic API setup to self-attach
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="setup-attach-cli"></a>Automatic setup with <code class="literal">apm-agent-attach-standalone.jar</code><a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This installation method is experimental.</p></div></div><p>You can use the attacher as a standalone application on the command line or include it in your application to programmatically attach to the current JVM.</p><p>This installation method does not require you to alter the configuration of your application server and can be used to conveniently instrument all JVMs on a particular host.</p><p>The <code class="literal">apm-agent-attach-standalone.jar</code> is a small Java program which attaches the Elastic APM Java agent to a specific JVM or to all JVMs of the same host it runs on.</p><h4><a id="setup-attach-cli-supported-environments"></a>Supported environments<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The attachment is supported on Windows,
Unix and Solaris operating systems on HotSpot-based JVMs (like OpenJDK and Oracle JDK) and OpenJ9.</p><p>Some flags, like <code class="literal">--include</code> and <code class="literal">--exclude</code> require the <code class="literal">jps</code> command to be installed,
which is part of the JDK distribution and does not typically come with the JRE distribution.</p><h4><a id="setup-attach-cli-caveats"></a>Caveats<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The OS user executing <code class="literal">apm-agent-attach-standalone.jar</code> and the OS user of the application(s) to be monitored (the JVMs to attach to) has to be the same.</p><p>When attaching to a J9 VM, you have to explicitly set the <code class="literal">--pid &lt;pid&gt;</code> argument, or have <code class="literal">jps</code> installed.</p><p>Currently, this does not work in combination with OSGi containers (which includes most application servers).
The symptom is that there will be a lot of exceptions like this: <code class="literal">java.lang.NoClassDefFoundError: co/elastic/apm/agent/servlet/ServletApiAdvice</code>.</p><h4><a id="setup-attach-cli-download"></a>Download<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>You can download the attach program from maven central:
<a class="ulink" href="https://search.maven.org/search?q=g:co.elastic.apm%20AND%20a:apm-agent-attach" target="_top">maven central</a></p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>As of version 1.9.0, you will have to download the <code class="literal">standalone</code> jar instead of the normal jar distribution.</p></div></div><h4><a id="setup-attach-cli-usage"></a>Usage<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><h5><a id="setup-attach-cli-usage-pid"></a>Attach to a JVM with a specific PID<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Attaches the agent to a JVM with a specific process ID.
Optionally, you can pass in arguments to configure the agent.
See <a class="xref" href="setup-attach-cli.html#setup-attach-cli-usage-options" title="Options">Options</a> for the format of the agent arguments.</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid &lt;pid&gt; [--args &lt;agent_arguments&gt;]</pre></div><p>Example: The following command attaches the agent to the JVM with the PID 42 and exits.
Additionally, it applies some <a class="link" href="configuration.html" title="Configuration">configuration options</a>.</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid 42 \
    --args 'service_name=my-cool-service;server_urls=http://localhost:8200'</pre></div><h5><a id="setup-attach-cli-usage-filtered"></a>Attach to a filtered set of JVMs on a certain host<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Attaches the agent to all matching JVMs on the host which confirm to the optional include and exclude filters.</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar [-include &lt;include_pattern&gt;...]
       [-exclude &lt;exclude_pattern&gt;...] [--continuous]
       [--args &lt;agent_arguments&gt; | --args-provider &lt;args_provider_script&gt;]</pre></div><p>Example: The following command attaches the agent to all JVMs whose main class contains <code class="literal">MyApplication</code> or which are started from a jar file named <code class="literal">my-application.jar</code>.
It also makes the attacher run continuously so that it attaches the agent on starting JVMs which match the include pattern.
Additionally, it applies some <a class="link" href="configuration.html" title="Configuration">configuration options</a>.</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar \
    --include '.*MyApplication.*' '.*/my-application.jar' \
    --continuous \
    --args 'service_name=my-cool-service;server_urls=http://localhost:8200'</pre></div><h5><a id="setup-attach-cli-usage-list"></a>List running JVMs<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Lists all currently running JVMs, including their PID and their main class name or the path to their jar file.</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --list</pre></div><h5><a id="setup-attach-cli-usage-options"></a>Options<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong strong"><strong>-l, --list</strong></span></span></dt><dd>Lists all running JVMs. Same output as <code class="literal">jps -l</code>.</dd><dt><span class="term"><span class="strong strong"><strong>-p, --pid &lt;pid&gt;</strong></span></span></dt><dd><p class="simpara">PID of the JVM to attach. If not provided, attaches to all currently running JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--continuous</code>, <code class="literal">--exclude</code>, <code class="literal">--include</code> and <code class="literal">--args-provider</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-c, --continuous</strong></span></span></dt><dd><p class="simpara">If provided, this program continuously runs and attaches to all running and starting JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--pid</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-e, --exclude &lt;exclude_pattern&gt;…​</strong></span></span></dt><dd><p class="simpara">A list of regular expressions of fully qualified main class names or paths to JARs of applications the java agent should not be attached to.
(Matches the output of <code class="literal">jps -l</code>)</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-i, --include &lt;include_pattern&gt;…​</strong></span></span></dt><dd><p class="simpara">A list of regular expressions of fully qualified main class names or paths to JARs of applications the java agent should be attached to.
(Matches the output of <code class="literal">jps -l</code>)</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-a, --args &lt;agent_arguments&gt;</strong></span></span></dt><dd><p class="simpara">If set, the arguments are used to configure the agent on the attached JVM (agentArguments of agentmain).</p><p class="simpara">The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--args-provider</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-C --config &lt;key=value&gt;…​</strong></span></span></dt><dd><p class="simpara">This repeatable option sets one agent configuration option.</p><p class="simpara">Example: <code class="literal">--config server_urls=http://localhost:8200,http://localhost:8201</code></p></dd><dt><span class="term"><span class="strong strong"><strong>-A, --args-provider &lt;args_provider_script&gt;</strong></span></span></dt><dd><p class="simpara">The name of a program which is called when a new JVM starts up.
The program gets the pid and the main class name or path to the JAR file as an argument
and returns an arg string which is used to configure the agent on the attached JVM (agentArguments of agentmain).
When returning a non-zero status code from this program, the agent will not be attached to the starting JVM.</p><p class="simpara">The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This option cannot be used in conjunction with <code class="literal">--pid</code> and <code class="literal">--args</code></p></div></div></dd></dl></div><h4><a id="setup-attach-cli-docker"></a>Docker<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Use this script to automatically attach to all docker containers running on a host.
This script does not return but continuously listens for starting containers which it also attaches to.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>This script is experimental and might not work with all containers.
Especially the <code class="literal">jq --raw-output .[0].Config.Cmd[0]) == java</code> might vary.</p></div></div><p><strong>attach.sh. </strong>
</p><div class="pre_wrapper lang-bash"><pre class="programlisting prettyprint lang-bash">#!/usr/bin/env bash
set -ex

attach () {
    # only attempt attachment if this looks like a java container
    if [[ $(docker inspect ${container_id} | jq --raw-output .[0].Config.Cmd[0]) == java ]]
    then
        echo attaching to $(docker ps --no-trunc | grep ${container_id})
        docker cp ./apm-agent-attach-*-standalone.jar ${container_id}:/apm-agent-attach-standalone.jar
        docker exec ${container_id} java -jar /apm-agent-attach-standalone.jar --config
    fi
}

# attach to running containers
for container_id in $(docker ps --quiet --no-trunc) ; do
    attach
done

# listen for starting containers and attach to those
docker events --filter 'event=start' --format '{{.ID}}' |
while IFS= read -r container_id
do
    attach
done</pre></div><p>
</p><h4><a id="setup-attach-cli-troubleshooting"></a>Troubleshooting<a href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>If you get a message like <code class="literal">no main manifest attribute, in apm-agent-attach.jar</code>,
you are using the wrong artifact.
Use the one which ends in <code class="literal">-standalone.jar</code>.</p></div><div class="navfooter"><span class="prev"><a href="setup-javaagent.html">
              « 
              Manual setup with <code class="literal">-javaagent</code> flag</a>
           
        </span><span class="next">
           
          <a href="setup-attach-api.html">Programmatic API setup to self-attach
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
