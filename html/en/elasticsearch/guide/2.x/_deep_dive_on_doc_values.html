<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Deep Dive on Doc Values
        | Elasticsearch: The Definitive Guide [2.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [2.x]" /><link rel="up" href="docvalues-and-fielddata.html" title="Doc Values and Fielddata" /><link rel="prev" href="docvalues.html" title="Doc Values" /><link rel="next" href="aggregations-and-analysis.html" title="Aggregations and Analysis" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/2.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="2.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <!-- Elastic APM -->
    <!--
    <script src="https://www.elastic.co/static/js/elastic-apm-js-base.umd.min.2.2.0.js"></script>
    <script type="text/javascript">
      var elasticApm = init({
        serviceName: 'elastic-co-frontend',
        serverUrl: 'https://3ddd1ee09cc242c4b169d36f5a2b8b77.apm.us-west1.gcp.cloud.es.io:443',
        stackTraceLimit: 5,
        serviceVersion: '1.0.0'
      })
    
      var pageLoadName
      var pathname = window.location.pathname.replace(/\/es|\/pt|\/jp|\/pt|\/fr|\/kr|\/cn|\/de/g, '')
      var parts = pathname.split('/');
    
      if (parts.length && parts[1] === 'blog') {
        if (parts.length === 2) {
          pageLoadName =  '/blog';
        }
        else if (parts[2] === 'category') {
          pageLoadName =  '/blog/category';
        }
        else if (parts[2] === 'archive') {
          pageLoadName =  '/blog/archive';
        }
        else {
          pageLoadName =  '/blog/detail';
        }
      }
      else if (parts.length && parts[1] === 'elasticon') {
        if (parts.length === 2) {
          pageLoadName =  '/elasticon';
        }
        else if (parts.length === 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/overview';
        }
        else if (parts.length > 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/video';
        }
      }
      else if (parts.length && parts[1] === 'guide') {
        pageLoadName =  '/guide';
      }
      else if (parts.length === 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos';
      }
      else if (parts.length > 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos/detail';
      }
      else if (parts.length > 2 && parts[1] === 'webinars') {
        pageLoadName =  '/webinars/detail';
      }
      else {
        pageLoadName =  window.location.pathname;
      }
    
      console.log('apm pageLoadName:', pageLoadName, parts)
      elasticApm.setTags({env:"production"});
      elasticApm.setInitialPageLoadName(pageLoadName);
    </script>
    -->

    <!-- Header Section -->
    
    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 2.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [2.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="docvalues-and-fielddata.html">Doc Values and Fielddata</a></span> » <span class="breadcrumb-node">Deep Dive on Doc Values</span></div><div class="navheader"><span class="prev"><a href="docvalues.html">
              « 
              Doc Values</a>
           
        </span><span class="next">
           
          <a href="aggregations-and-analysis.html">Aggregations and Analysis
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_deep_dive_on_doc_values"></a>Deep Dive on Doc Values<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/300_Aggregations/93_technical_docvalues.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The last section opened by saying doc values are <span class="emphasis"><em>"fast, efficient and memory-friendly"</em></span>.
Those are some nice marketing buzzwords, but how do doc values actually work?</p><p>Doc values are generated at index-time, alongside the creation of the inverted index.
That means doc values are generated on a per-segment basis and are immutable, just like
the inverted index used for search. And, like the inverted index, doc values are serialized
to disk.  This is important to performance and scalability.</p><p>By serializing a persistent data structure to disk, we can rely on the OS’s file
system cache to manage memory instead of retaining structures on the JVM heap.
In situations where the "working set" of data is smaller than the available
memory, the OS will naturally keep the doc values resident in memory.  This gives
the same performance profile as on-heap data structures.</p><p>But when your working set is much larger than available memory, the OS will begin
paging the doc values on/off disk as required.  This will obviously be slower
than an entirely memory-resident data structure, but it has the advantage of scaling
well beyond the server’s memory capacity.  If these data structures were
purely on-heap, the only option is to crash with an OutOfMemory exception (or implement
a paging scheme just like the OS).</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>Because doc values are not managed by the JVM, Elasticsearch servers can be
configured with a much smaller heap.  This gives more memory to the OS for caching.
It also has the benefit of letting the JVM’s garbage collector work with a smaller
heap, which will result in faster and more efficient collection cycles.</p><p>Traditionally, the recommendation has been to dedicate 50% of the machine’s memory
to the JVM heap.  With the introduction of doc values, this recommendation is starting
to slide.  Consider giving far less to the heap, perhaps 4-16gb on a 64gb machine,
instead of the full 32gb previously recommended.</p><p>For a more detailed discussion, see <a class="xref" href="heap-sizing.html" title="Heap: Sizing and Swapping">Heap: Sizing and Swapping</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_column_store_compression"></a>Column-store compression<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/300_Aggregations/93_technical_docvalues.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>At a high level, doc values are essentially a serialized <span class="emphasis"><em>column-store</em></span>.  As we
discussed in the last section, column-stores excel at certain operations because
the data is naturally laid out in a fashion that is amenable to those queries.</p><p>But they also excel at compressing data, particularly numbers.  This is important for both saving space
on disk <span class="emphasis"><em>and</em></span> for faster access.  Modern CPU’s are many orders of magnitude faster
than disk drives (although the gap is narrowing quickly with upcoming NVMe drives).  That means
it is often advantageous to minimize the amount of data that must be read from disk,
even if it requires extra CPU cycles to decompress.</p><p>To see how it can help compression, take this set of doc values for a numeric field:</p><pre class="literallayout">Doc      Terms
-----------------------------------------------------------------
Doc_1 | 100
Doc_2 | 1000
Doc_3 | 1500
Doc_4 | 1200
Doc_5 | 300
Doc_6 | 1900
Doc_7 | 4200
-----------------------------------------------------------------</pre><p>The column-stride layout means we have a contiguous block of numbers:
<code class="literal">[100,1000,1500,1200,300,1900,4200]</code>.  Because we know they are all numbers
(instead of a heterogeneous collection like you’d see in a document or row)
values can be packed tightly together with uniform offsets.</p><p>Further, there are a variety of compression tricks we can apply to these numbers.
You’ll notice that each of the above numbers are a multiple of 100.  Doc values
detect when all the values in a segment share a <span class="emphasis"><em>greatest common divisor</em></span> and use
that to compress the values further.</p><p>If we save <code class="literal">100</code> as the divisor for this segment, we can divide each number by 100
to get:  <code class="literal">[1,10,15,12,3,19,42]</code>.  Now that the numbers are smaller, they require
fewer bits to store and we’ve reduced the size on-disk.</p><p>Doc values use several tricks like this.  In order, the following compression
schemes are checked:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
If all values are identical (or missing), set a flag and record the value
</li><li class="listitem">
If there are fewer than 256 values, a simple table encoding is used
</li><li class="listitem">
If there are &gt; 256 values, check to see if there is a common divisor
</li><li class="listitem">
If there is no common divisor, encode everything as an offset from the smallest
value
</li></ol></div><p>You’ll note that these compression schemes are not "traditional" general purpose
compression like DEFLATE or LZ4.  Because the structure of column-stores are
rigid and well-defined, we can achieve higher compression by using specialized
schemes rather than the more general compression algorithms like LZ4.</p><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>You may be thinking <span class="emphasis"><em>"Well that’s great for numbers, but what about strings?"</em></span>
Strings are encoded similarly, with the help of an ordinal table.  The
strings are de-duplicated and sorted into a table, assigned an ID, and then those
ID’s are used as numeric doc values.  Which means strings enjoy many of the same
compression benefits that numerics do.</p><p>The ordinal table itself has some compression tricks, such as using fixed, variable
or prefix-encoded strings.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_disabling_doc_values"></a>Disabling Doc Values<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/300_Aggregations/93_technical_docvalues.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Doc values are enabled by default for all fields <span class="emphasis"><em>except</em></span> analyzed strings.  That means
all numerics, geo_points, dates, IPs and <code class="literal">not_analyzed</code> strings.</p><p>Analyzed strings are not able to use doc values at this time; the analysis process
generates many tokens and does not work efficiently with doc values.  We’ll discuss
using analyzed strings for aggregations in <a class="xref" href="aggregations-and-analysis.html" title="Aggregations and Analysis">Aggregations and Analysis</a>.</p><p>Because doc values are on by default, you have the option to aggregate and sort
on most fields in your dataset.  But what if you know you will <span class="emphasis"><em>never</em></span> aggregate,
sort or script on a certain field?</p><p>While rare, these circumstances do arise and you may wish to disable doc values
on that particular field.  This will save you some disk space (since the doc values
are not being serialized to disk anymore) and may increase indexing speed slightly
(since the doc values don’t need to be generated).</p><p>To disable doc values, set <code class="literal">doc_values: false</code> in the field’s mapping.  For example,
here we create a new index where doc values are disabled for the <code class="literal">"session_id"</code> field:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">PUT my_index
{
  "mappings": {
    "my_type": {
      "properties": {
        "session_id": {
          "type":       "string",
          "index":      "not_analyzed",
          "doc_values": false <a id="CO216-1"></a><i class="conum" data-value="1"></i>
        }
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO216-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
By setting <code class="literal">doc_values: false</code>, this field will not be usable in aggregations, sorts
or scripts
</p></td></tr></table></div><p>It is possible to configure the inverse relationship too: make a field available
for aggregations via doc values, but make it unavailable for normal search by disabling
the inverted index.  For example:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">PUT my_index
{
  "mappings": {
    "my_type": {
      "properties": {
        "customer_token": {
          "type":       "string",
          "index":      "not_analyzed",
          "doc_values": true, <a id="CO217-1"></a><i class="conum" data-value="1"></i>
          "index": "no" <a id="CO217-2"></a><i class="conum" data-value="2"></i>
        }
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO217-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
Doc values are enabled to allow aggregations
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO217-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
Indexing is disabled, which makes the field unavailable to queries/searches
</p></td></tr></table></div><p>By setting <code class="literal">doc_values: true</code> and <code class="literal">index: no</code>, we generate a field which can <span class="emphasis"><em>only</em></span>
be used in aggregations/sorts/scripts.  This is admittedly a very rare requirement,
but sometimes useful.</p></div></div><div class="navfooter"><span class="prev"><a href="docvalues.html">
              « 
              Doc Values</a>
           
        </span><span class="next">
           
          <a href="aggregations-and-analysis.html">Aggregations and Analysis
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>
      </section>
    </div>

    
<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>

<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
