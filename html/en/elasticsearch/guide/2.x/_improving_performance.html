<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Improving Performance
        | Elasticsearch: The Definitive Guide [2.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [2.x]" /><link rel="up" href="proximity-matching.html" title="Proximity Matching" /><link rel="prev" href="proximity-relevance.html" title="Proximity for Relevance" /><link rel="next" href="shingles.html" title="Finding Associated Words" /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/2.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="2.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 2.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [2.x]
    </a></span> » <span class="breadcrumb-link"><a href="search-in-depth.html">Search in Depth</a></span> » <span class="breadcrumb-link"><a href="proximity-matching.html">Proximity Matching</a></span> » <span class="breadcrumb-node">Improving Performance</span></div><div class="navheader"><span class="prev"><a href="proximity-relevance.html">
              « 
              Proximity for Relevance</a>
           
        </span><span class="next">
           
          <a href="shingles.html">Finding Associated Words
               »
            </a></span></div><div class="pagebreak-before section"><div class="titlepage"><div><div><h2 class="title"><a id="_improving_performance"></a>Improving Performance<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/120_Proximity_Matching/30_Performance.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>Phrase and proximity queries are more <a id="id-1.5.6.15.2.1" class="indexterm"></a>
<a id="id-1.5.6.15.2.2" class="indexterm"></a><a id="id-1.5.6.15.2.3" class="indexterm"></a>
<a id="id-1.5.6.15.2.4" class="indexterm"></a>expensive than simple <code class="literal">match</code> queries.
Whereas a <code class="literal">match</code> query just has to look up terms in the inverted index, a
<code class="literal">match_phrase</code> query has to calculate and compare the positions of multiple
possibly repeated terms.</p><p>The <a class="ulink" href="http://people.apache.org/~mikemccand/lucenebench/" target="_top">Lucene nightly
benchmarks</a> show that a simple <code class="literal">term</code> query is about 10 times as fast as a
phrase query, and about 20 times as fast as a proximity query (a phrase query
with <code class="literal">slop</code>). And of course, this cost is paid at search time instead of at index time.</p><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>Usually the extra cost of phrase queries is not as scary as these numbers
suggest. Really, the difference in performance is a testimony to just how fast
a simple <code class="literal">term</code> query is.  Phrase queries on typical full-text data usually
complete within a few milliseconds, and are perfectly usable in practice, even
on a busy cluster.</p><p>In certain pathological cases, phrase queries can be costly, but this is
unusual.  An example of a pathological case is DNA sequencing, where there are
many many identical terms repeated in many positions. Using higher <code class="literal">slop</code>
values in this case results in a huge growth in the number of position
calculations.</p></div></div><p>So what can we do to limit the performance cost of phrase and proximity
queries? One useful approach is to reduce the total number of documents that
need to be examined by the phrase query.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rescore-api"></a>Rescoring Results<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/120_Proximity_Matching/30_Performance.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>In <a class="link" href="proximity-relevance.html" title="Proximity for Relevance">the preceding section</a>, we discussed using proximity
queries just for relevance purposes, not to include or exclude results from
the result set. <a id="id-1.5.6.15.6.2.2" class="indexterm"></a>
<a id="id-1.5.6.15.6.2.3" class="indexterm"></a> A query may match millions of results, but chances are that
our users are interested in only the first few pages of results.</p><p>A simple <code class="literal">match</code> query will already have ranked documents that contain all
search terms near the top of the list. Really, we just want to rerank the <span class="emphasis"><em>top
results</em></span> to give an extra relevance bump to those documents that also match the
phrase query.</p><p>The <code class="literal">search</code> API supports exactly this functionality via <span class="emphasis"><em>rescoring</em></span>.<a id="id-1.5.6.15.6.4.3" class="indexterm"></a> The
rescore phase allows you to apply a more expensive scoring algorithm—like a
<code class="literal">phrase</code> query—to just the top <code class="literal">K</code> results from each shard. These top
results are then resorted according to their new scores.</p><p>The request looks like this:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /my_index/my_type/_search
{
    "query": {
        "match": {  <a id="CO87-1"></a><i class="conum" data-value="1"></i>
            "title": {
                "query":                "quick brown fox",
                "minimum_should_match": "30%"
            }
        }
    },
    "rescore": {
        "window_size": 50, <a id="CO87-2"></a><i class="conum" data-value="2"></i>
        "query": {         <a id="CO87-3"></a><i class="conum" data-value="3"></i>
            "rescore_query": {
                "match_phrase": {
                    "title": {
                        "query": "quick brown fox",
                        "slop":  50
                    }
                }
            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/120_Proximity_Matching/30_Performance.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO87-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">match</code> query decides which results will be included in the final
    result set and ranks results according to TF/IDF.<a id="id-1.5.6.15.6.8.1.1.2" class="indexterm"></a>
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO87-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">window_size</code> is the number of top results to rescore, per shard.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO87-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
The only rescoring algorithm currently supported is another query, but
    there are plans to add more algorithms later.
</p></td></tr></table></div></div></div><div class="navfooter"><span class="prev"><a href="proximity-relevance.html">
              « 
              Proximity for Relevance</a>
           
        </span><span class="next">
           
          <a href="shingles.html">Finding Associated Words
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
