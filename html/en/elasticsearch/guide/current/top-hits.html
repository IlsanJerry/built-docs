<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Field Collapsing
        | Elasticsearch: The Definitive Guide [2.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [2.x]" /><link rel="up" href="relations.html" title="Handling Relationships" /><link rel="prev" href="denormalization.html" title="Denormalizing Your Data" /><link rel="next" href="denormalization-concurrency.html" title="Denormalization and Concurrency" /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/2.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="2.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 2.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [2.x]
    </a></span> » <span class="breadcrumb-link"><a href="modeling-your-data.html">Modeling Your Data</a></span> » <span class="breadcrumb-link"><a href="relations.html">Handling Relationships</a></span> » <span class="breadcrumb-node">Field Collapsing</span></div><div class="navheader"><span class="prev"><a href="denormalization.html">
              « 
              Denormalizing Your Data</a>
           
        </span><span class="next">
           
          <a href="denormalization-concurrency.html">Denormalization and Concurrency
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="top-hits"></a>Field Collapsing<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/2.x/400_Relationships/22_Top_hits.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>A common requirement is the need to present search results grouped by a particular
field. <a id="id-1.9.3.15.2.1" class="indexterm"></a><a id="id-1.9.3.15.2.2" class="indexterm"></a>
<a id="id-1.9.3.15.2.3" class="indexterm"></a>We might want to return the most relevant blog posts <span class="emphasis"><em>grouped</em></span> by the
user’s name. <a id="id-1.9.3.15.2.5" class="indexterm"></a><a id="id-1.9.3.15.2.6" class="indexterm"></a>
<a id="id-1.9.3.15.2.7" class="indexterm"></a> Grouping by name implies the need for a <code class="literal">terms</code> aggregation.  To
be able to group on the user’s <span class="emphasis"><em>whole</em></span> name, the name field should be
available in its original <code class="literal">not_analyzed</code> form, as explained in
<a class="xref" href="aggregations-and-analysis.html" title="Aggregations and Analysis">Aggregations and Analysis</a>:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">PUT /my_index/_mapping/blogpost
{
  "properties": {
    "user": {
      "properties": {
        "name": { <a id="CO252-1"></a><i class="conum" data-value="1"></i>
          "type": "string",
          "fields": {
            "raw": { <a id="CO252-2"></a><i class="conum" data-value="2"></i>
              "type":  "string",
              "index": "not_analyzed"
            }
          }
        }
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO252-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">user.name</code> field will be used for full-text search.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO252-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">user.name.raw</code> field will be used for grouping with the <code class="literal">terms</code>
    aggregation.
</p></td></tr></table></div><p>Then add some data:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">PUT /my_index/user/1
{
  "name": "John Smith",
  "email": "john@smith.com",
  "dob": "1970/10/24"
}

PUT /my_index/blogpost/2
{
  "title": "Relationships",
  "body": "It's complicated...",
  "user": {
    "id": 1,
    "name": "John Smith"
  }
}

PUT /my_index/user/3
{
  "name": "Alice John",
  "email": "alice@john.com",
  "dob": "1979/01/04"
}

PUT /my_index/blogpost/4
{
  "title": "Relationships are cool",
  "body": "It's not complicated at all...",
  "user": {
    "id": 3,
    "name": "Alice John"
  }
}</pre></div><p>Now we can run a query looking for blog posts about <code class="literal">relationships</code>, by users
called <code class="literal">John</code>, and group the results by user, thanks to the
<a class="ulink" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-metrics-top-hits-aggregation.html" target="_top"><code class="literal">top_hits</code> aggregation</a>:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">GET /my_index/blogpost/_search
{
  "size" : 0, <a id="CO253-1"></a><i class="conum" data-value="1"></i>
  "query": { <a id="CO253-2"></a><i class="conum" data-value="2"></i>
    "bool": {
      "must": [
        { "match": { "title":     "relationships" }},
        { "match": { "user.name": "John"          }}
      ]
    }
  },
  "aggs": {
    "users": {
      "terms": {
        "field":   "user.name.raw",      <a id="CO253-3"></a><i class="conum" data-value="3"></i>
        "order": { "top_score": "desc" } <a id="CO253-4"></a><i class="conum" data-value="4"></i>
      },
      "aggs": {
        "top_score": { "max":      { "script":  "_score"           }}, <a id="CO253-5"></a><i class="conum" data-value="5"></i>
        "blogposts": { "top_hits": { "_source": "title", "size": 5 }}  <a id="CO253-6"></a><i class="conum" data-value="6"></i>
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO253-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The blog posts that we are interested in are returned under the
    <code class="literal">blogposts</code> aggregation, so we can disable the usual search <code class="literal">hits</code> by
    setting the <code class="literal">size</code> to 0.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO253-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">query</code> returns blog posts about <code class="literal">relationships</code> by users named <code class="literal">John</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO253-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">terms</code> aggregation creates a bucket for each <code class="literal">user.name.raw</code> value.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO253-4"><i class="conum" data-value="4"></i></a> <a href="#CO253-5"><i class="conum" data-value="5"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">top_score</code> aggregation orders the terms in the <code class="literal">users</code> aggregation
    by the top-scoring document in each bucket.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO253-6"><i class="conum" data-value="6"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">top_hits</code> aggregation returns just the <code class="literal">title</code> field of the five most
    relevant blog posts for each user.
</p></td></tr></table></div><p>The abbreviated response is shown here:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">...
"hits": {
  "total":     2,
  "max_score": 0,
  "hits":      [] <a id="CO254-1"></a><i class="conum" data-value="1"></i>
},
"aggregations": {
  "users": {
     "buckets": [
        {
           "key":       "John Smith", <a id="CO254-2"></a><i class="conum" data-value="2"></i>
           "doc_count": 1,
           "blogposts": {
              "hits": { <a id="CO254-3"></a><i class="conum" data-value="3"></i>
                 "total":     1,
                 "max_score": 0.35258877,
                 "hits": [
                    {
                       "_index": "my_index",
                       "_type":  "blogpost",
                       "_id":    "2",
                       "_score": 0.35258877,
                       "_source": {
                          "title": "Relationships"
                       }
                    }
                 ]
              }
           },
           "top_score": { <a id="CO254-4"></a><i class="conum" data-value="4"></i>
              "value": 0.3525887727737427
           }
        },
...</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO254-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">hits</code> array is empty because we set <code class="literal">size</code> to 0.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO254-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
There is a bucket for each user who appeared in the top results.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO254-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
Under each user bucket there is a <code class="literal">blogposts.hits</code> array containing
    the top results for that user.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO254-4"><i class="conum" data-value="4"></i></a> </p></td><td valign="top" align="left"><p>
The user buckets are sorted by the user’s most relevant blog post.
</p></td></tr></table></div><p>Using the <code class="literal">top_hits</code> aggregation is the<a id="id-1.9.3.15.13.2" class="indexterm"></a> equivalent of running a query to
return the names of the users with the most relevant blog posts, and then running
the same query for each user, to get their best blog posts. But it is much more
efficient.</p><p>The top hits returned in each bucket are the result of running a light
<span class="emphasis"><em>mini-query</em></span> based on the original main query.  The mini-query supports the
usual features that you would expect from search such as highlighting and
pagination.</p></div><div class="navfooter"><span class="prev"><a href="denormalization.html">
              « 
              Denormalizing Your Data</a>
           
        </span><span class="next">
           
          <a href="denormalization-concurrency.html">Denormalization and Concurrency
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
