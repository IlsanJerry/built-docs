<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Adding a Metric to the Mix
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="_aggregation_test_drive.html" title="Aggregation Test-Drive" /><link rel="prev" href="_aggregation_test_drive.html" title="Aggregation Test-Drive" /><link rel="next" href="_buckets_inside_buckets.html" title="Buckets Inside Buckets" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="1.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="_aggregation_test_drive.html">Aggregation Test-Drive</a></span> » <span class="breadcrumb-node">Adding a Metric to the Mix</span></div><div class="navheader"><span class="prev"><a href="_aggregation_test_drive.html">
              « 
              Aggregation Test-Drive</a>
           
        </span><span class="next">
           
          <a href="_buckets_inside_buckets.html">Buckets Inside Buckets
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_adding_a_metric_to_the_mix"></a>Adding a Metric to the Mix<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/21_add_metric.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The previous example told us the number of documents in each bucket, which is
useful.  <a id="id-1.7.4.22.2.1" class="indexterm"></a>
<a id="id-1.7.4.22.2.2" class="indexterm"></a>
<a id="id-1.7.4.22.2.3" class="indexterm"></a>But often, our applications require more-sophisticated metrics about
the documents.<a id="id-1.7.4.22.2.4" class="indexterm"></a>
<a id="id-1.7.4.22.2.5" class="indexterm"></a> For example, what is the average price of cars in each bucket?</p><p>To get this information, we need to tell Elasticsearch which metrics to calculate,
and on which fields. <a id="id-1.7.4.22.3.1" class="indexterm"></a>
<a id="id-1.7.4.22.3.2" class="indexterm"></a> This requires <span class="emphasis"><em>nesting</em></span> metrics inside the buckets.
Metrics will calculate mathematical statistics based on the values of documents
within a bucket.</p><p>Let’s go ahead and add <a id="id-1.7.4.22.4.1" class="indexterm"></a>an <code class="literal">average</code> metric to our car example:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
   "aggs": {
      "colors": {
         "terms": {
            "field": "color"
         },
         "aggs": { <a id="CO187-1"></a><i class="conum" data-value="1"></i>
            "avg_price": { <a id="CO187-2"></a><i class="conum" data-value="2"></i>
               "avg": {
                  "field": "price" <a id="CO187-3"></a><i class="conum" data-value="3"></i>
               }
            }
         }
      }
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/20_basic_example.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
We add a new <code class="literal">aggs</code> level to hold the metric.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
We then give the metric a name: <code class="literal">avg_price</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
And finally, we define it as an <code class="literal">avg</code> metric over the <code class="literal">price</code> field.
</p></td></tr></table></div><p>As you can see, we took the previous example and tacked on a new <code class="literal">aggs</code> level.
This new aggregation level allows us to nest the <code class="literal">avg</code> metric inside the
<code class="literal">terms</code> bucket.  Effectively, this means we will generate an average for each
color.</p><p>Just like the <code class="literal">colors</code> example, we need to name our metric (<code class="literal">avg_price</code>) so we
can retrieve the values later.  Finally, we specify the metric itself (<code class="literal">avg</code>)
and what field we want the average to be calculated on (<code class="literal">price</code>):</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "avg_price": { <a id="CO188-1"></a><i class="conum" data-value="1"></i>
                  "value": 32500
               }
            },
            {
               "key": "blue",
               "doc_count": 2,
               "avg_price": {
                  "value": 20000
               }
            },
            {
               "key": "green",
               "doc_count": 2,
               "avg_price": {
                  "value": 21000
               }
            }
         ]
      }
   }
...
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO188-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
New <code class="literal">avg_price</code> element in response
</p></td></tr></table></div><p>Although the response has changed minimally, the data we get out of it has grown
substantially.  Before, we knew there were four red cars.  Now we know that the
average price of red cars is $32,500.  This is something that you can plug directly
into reports or graphs.</p></div><div class="navfooter"><span class="prev"><a href="_aggregation_test_drive.html">
              « 
              Aggregation Test-Drive</a>
           
        </span><span class="next">
           
          <a href="_buckets_inside_buckets.html">Buckets Inside Buckets
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>
      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>

<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
