<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Scoping Aggregations
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="aggregations.html" title="Aggregations" /><link rel="prev" href="_the_sky_8217_s_the_limit.html" title="The Sky’s the Limit" /><link rel="next" href="_filtering_queries_and_aggregations.html" title="Filtering Queries and Aggregations" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="1.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-node">Scoping Aggregations</span></div><div class="navheader"><span class="prev"><a href="_the_sky_8217_s_the_limit.html">
              « 
              The Sky’s the Limit</a>
           
        </span><span class="next">
           
          <a href="_filtering_queries_and_aggregations.html">Filtering Queries and Aggregations
               »
            </a></span></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_scoping_aggregations"></a>Scoping Aggregations<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/40_scope.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>With all of the aggregation examples given so far, you may have noticed that we
omitted a <code class="literal">query</code> from the search request. <a id="id-1.7.7.2.2" class="indexterm"></a>
<a id="id-1.7.7.2.3" class="indexterm"></a><a id="id-1.7.7.2.4" class="indexterm"></a>
<a id="id-1.7.7.2.5" class="indexterm"></a> The entire request was
simply an aggregation.</p><p>Aggregations can be run at the same time as search requests, but you need to
understand a new concept: <span class="emphasis"><em>scope</em></span>. <a id="id-1.7.7.3.2" class="indexterm"></a> By default, aggregations operate in the same
scope as the query.  Put another way, aggregations are calculated on the set of
documents that match your query.</p><p>Let’s look at one of our first aggregation examples:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
    "aggs" : {
        "colors" : {
            "terms" : {
              "field" : "color"
            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/40_scope.json"></div><p>You can see that the aggregation is in isolation.  In reality, Elasticsearch
assumes "no query specified" is equivalent to "query all documents." The preceding
query is internally translated as follows:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
    "query" : {
        "match_all" : {}
    },
    "aggs" : {
        "colors" : {
            "terms" : {
              "field" : "color"
            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/40_scope.json"></div><p>The aggregation always operates in the scope of the query, so an isolated
aggregation really operates in the scope of <a id="id-1.7.7.10.1" class="indexterm"></a>
<a id="id-1.7.7.10.2" class="indexterm"></a>a <code class="literal">match_all</code> query—that is to say,
all documents.</p><p>Once armed with the knowledge of scoping, we can start to customize
aggregations even further.  All of our previous examples calculated statistics
about <span class="emphasis"><em>all</em></span> of the data: top-selling cars, average price of all cars, most sales
per month, and so forth.</p><p>With scope, we can ask questions such as "How many colors are Ford cars are
available in?"  We do this by simply adding a query to the request (in this case
a <code class="literal">match</code> query):</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /cars/transactions/_search  <a id="CO197-1"></a><i class="conum" data-value="1"></i>
{
    "query" : {
        "match" : {
            "make" : "ford"
        }
    },
    "aggs" : {
        "colors" : {
            "terms" : {
              "field" : "color"
            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/40_scope.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO197-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
We are omitting <code class="literal">search_type=count</code> so<a id="id-1.7.7.15.1.1.2" class="indexterm"></a>
<a id="id-1.7.7.15.1.1.3" class="indexterm"></a> that search hits are returned too.
</p></td></tr></table></div><p>By omitting the <code class="literal">search_type=count</code> this time, we can see both the search
results and the aggregation results:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
...
   "hits": {
      "total": 2,
      "max_score": 1.6931472,
      "hits": [
         {
            "_source": {
               "price": 25000,
               "color": "blue",
               "make": "ford",
               "sold": "2014-02-12"
            }
         },
         {
            "_source": {
               "price": 30000,
               "color": "green",
               "make": "ford",
               "sold": "2014-05-18"
            }
         }
      ]
   },
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "blue",
               "doc_count": 1
            },
            {
               "key": "green",
               "doc_count": 1
            }
         ]
      }
   }
}</pre></div><p>This may seem trivial, but it is the key to advanced and powerful dashboards.
You can transform any static dashboard into a real-time data exploration device
by adding a search bar.<a id="id-1.7.7.18.1" class="indexterm"></a>
<a id="id-1.7.7.18.2" class="indexterm"></a>  This allows the user to search for terms and see all
of the graphs (which are powered by aggregations, and thus scoped to the query)
update in real time.  Try that with Hadoop!</p><h3><a id="_global_bucket"></a>Global Bucket<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/40_scope.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>You’ll often want your aggregation to be scoped to your query.  But sometimes
you’ll want to search for a subset of data, but aggregate across <span class="emphasis"><em>all</em></span> of
your data.<a id="id-1.7.7.20.2" class="indexterm"></a>
<a id="id-1.7.7.20.3" class="indexterm"></a>
<a id="id-1.7.7.20.4" class="indexterm"></a><a id="id-1.7.7.20.5" class="indexterm"></a>
<a id="id-1.7.7.20.6" class="indexterm"></a></p><p>For example, say you want to know the average price of Ford cars compared to the
average price of <span class="emphasis"><em>all</em></span> cars. We can use a regular aggregation (scoped to the query)
to get the first piece of information.  The second piece of information can be
obtained by using<a id="id-1.7.7.21.2" class="indexterm"></a>
<a id="id-1.7.7.21.3" class="indexterm"></a><a id="id-1.7.7.21.4" class="indexterm"></a> a <code class="literal">global</code> bucket.</p><p>The <code class="literal">global</code> bucket will contain <span class="emphasis"><em>all</em></span> of your documents, regardless of the query
scope; it bypasses the scope completely.  Because it is a bucket, you can nest
aggregations inside it as usual:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
    "query" : {
        "match" : {
            "make" : "ford"
        }
    },
    "aggs" : {
        "single_avg_price": {
            "avg" : { "field" : "price" } <a id="CO198-1"></a><i class="conum" data-value="1"></i>
        },
        "all": {
            "global" : {}, <a id="CO198-2"></a><i class="conum" data-value="2"></i>
            "aggs" : {
                "avg_price": {
                    "avg" : { "field" : "price" } <a id="CO198-3"></a><i class="conum" data-value="3"></i>
                }

            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/40_scope.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO198-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
This aggregation operates in the query scope (for example, all docs matching <code class="literal">ford</code>)
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO198-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">global</code> bucket has no parameters.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO198-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
This aggregation operates on the all documents, regardless of the make.
</p></td></tr></table></div><p>The <code class="literal">single_avg_price</code> metric calculation is based on all documents that fall under the
query scope—all <code class="literal">ford</code> cars.  The <code class="literal">avg_price</code> metric is nested under a
<code class="literal">global</code> bucket, which means it ignores scoping entirely and calculates on
all the documents.  The average returned for that aggregation represents
the average price of all cars.</p><p>If you’ve made it this far in the book, you’ll recognize the mantra: use a filter
wherever you can.  The same applies to aggregations, and in the next chapter
we show you how to filter an aggregation instead of just limiting the query
scope.<a id="id-1.7.7.27.1" class="indexterm"></a></p></div><div class="navfooter"><span class="prev"><a href="_the_sky_8217_s_the_limit.html">
              « 
              The Sky’s the Limit</a>
           
        </span><span class="next">
           
          <a href="_filtering_queries_and_aggregations.html">Filtering Queries and Aggregations
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
