<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Combining Queries with Filters
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="full-body-search.html" title="Full-Body Search" /><link rel="prev" href="_most_important_queries_and_filters.html" title="Most Important Queries and Filters" /><link rel="next" href="_validating_queries.html" title="Validating Queries" /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="1.x" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="getting-started.html">Getting Started</a></span> » <span class="breadcrumb-link"><a href="full-body-search.html">Full-Body Search</a></span> » <span class="breadcrumb-node">Combining Queries with Filters</span></div><div class="navheader"><span class="prev"><a href="_most_important_queries_and_filters.html">
              « 
              Most Important Queries and Filters</a>
           
        </span><span class="next">
           
          <a href="_validating_queries.html">Validating Queries
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_combining_queries_with_filters"></a>Combining Queries with Filters<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/054_Query_DSL/75_Queries_with_filters.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>Queries can be used in <span class="emphasis"><em>query context</em></span>, and filters can be used
in <span class="emphasis"><em>filter context</em></span>. <a id="id-1.4.9.8.2.3" class="indexterm"></a><a id="id-1.4.9.8.2.4" class="indexterm"></a> Throughout the Elasticsearch API, you will see parameters
with <code class="literal">query</code> or <code class="literal">filter</code> in the name.  These
expect a single argument containing either a single query or filter clause
respectively. In other words, they establish the
outer <span class="emphasis"><em>context</em></span> as query context or filter context.</p><p>Compound query clauses can wrap other query clauses, and compound
filter clauses can wrap other filter clauses. However, it is often
useful to apply a filter to a query or, less frequently, to use a full-text query as a filter.</p><p>To do this, there are dedicated query clauses that wrap filter clauses, and
vice versa, thus allowing us to switch from one context to another. It is
important to choose the correct combination of query and filter clauses
to achieve your goal in the most efficient way.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="filtered-query"></a>Filtering a Query<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/054_Query_DSL/75_Queries_with_filters.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Let’s say we have<a id="id-1.4.9.8.5.2.1" class="indexterm"></a><a id="id-1.4.9.8.5.2.2" class="indexterm"></a> this query:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{ "match": { "email": "business opportunity" }}</pre></div><p>We want to combine it with the following <code class="literal">term</code> filter, which will
match only documents that are in our inbox:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{ "term": { "folder": "inbox" }}</pre></div><p>The <code class="literal">search</code> API accepts only a single <code class="literal">query</code> parameter, so we need
to wrap the query and the filter in another query, called the <code class="literal">filtered</code>
query:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
    "filtered": {
        "query":  { "match": { "email": "business opportunity" }},
        "filter": { "term":  { "folder": "inbox" }}
    }
}</pre></div><p>We can now pass this query to the <code class="literal">query</code> parameter of the <code class="literal">search</code> API:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET /_search
{
    "query": {
        "filtered": {
            "query":  { "match": { "email": "business opportunity" }},
            "filter": { "term": { "folder": "inbox" }}
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/054_Query_DSL/75_Filtered_query.json"></div></div><div class="pagebreak-before section"><div class="titlepage"><div><div><h3 class="title"><a id="_just_a_filter"></a>Just a Filter<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/054_Query_DSL/75_Queries_with_filters.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>While in query context, if <a id="id-1.4.9.8.6.2.1" class="indexterm"></a><a id="id-1.4.9.8.6.2.2" class="indexterm"></a>you need to use a filter without a query (for
instance, to match all emails in the inbox), you can just omit the
query:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET /_search
{
    "query": {
        "filtered": {
            "filter":   { "term": { "folder": "inbox" }}
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/054_Query_DSL/75_Filtered_query.json"></div><p>If a query is not specified it defaults to using the <code class="literal">match_all</code> query, so
the preceding query is equivalent to the following:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">GET /_search
{
    "query": {
        "filtered": {
            "query":    { "match_all": {}},
            "filter":   { "term": { "folder": "inbox" }}
        }
    }
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_a_query_as_a_filter"></a>A Query as a Filter<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/054_Query_DSL/75_Queries_with_filters.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Occasionally, you will want to use a query while you are in filter context.
This can be achieved with the <code class="literal">query</code> filter, which <a id="id-1.4.9.8.7.2.2" class="indexterm"></a><a id="id-1.4.9.8.7.2.3" class="indexterm"></a>just wraps a query. The following
example shows one way we could exclude emails that look like spam:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET /_search
{
    "query": {
        "filtered": {
            "filter":   {
                "bool": {
                    "must":     { "term":  { "folder": "inbox" }},
                    "must_not": {
                        "query": { <a id="CO21-1"></a><i class="conum" data-value="1"></i>
                            "match": { "email": "urgent business proposal" }
                        }
                    }
                }
            }
        }
    }
}</pre></div><div class="sense_widget" data-snippet="snippets/054_Query_DSL/75_Filtered_query.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO21-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>Note the <code class="literal">query</code> filter, which is allowing us to use the <code class="literal">match</code> <span class="emphasis"><em>query</em></span>
inside a <code class="literal">bool</code> <span class="emphasis"><em>filter</em></span>.</p></td></tr></table></div><div class="note admon"><div class="icon"></div><div class="admon_content"><p>You seldom need to use a query as a filter, but we have included it for
completeness' sake.  The only time you may need it is when you need to use
full-text matching while in filter context.</p></div></div></div></div><div class="navfooter"><span class="prev"><a href="_most_important_queries_and_filters.html">
              « 
              Most Important Queries and Filters</a>
           
        </span><span class="next">
           
          <a href="_validating_queries.html">Validating Queries
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=default&elektra=docs&storm=top-video">Elasticsearch Service: Free Trial</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
