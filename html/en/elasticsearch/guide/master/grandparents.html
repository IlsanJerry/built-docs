<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Grandparents and Grandchildren
        | Elasticsearch: The Definitive Guide [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [master]" /><link rel="up" href="parent-child.html" title="Parent-Child Relationship" /><link rel="prev" href="children-agg.html" title="Children Aggregation" /><link rel="next" href="parent-child-performance.html" title="Practical Considerations" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/master" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="master" /><meta name="robots" content="noindex,nofollow" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <!-- Elastic APM -->
    <!--
    <script src="https://www.elastic.co/static/js/elastic-apm-js-base.umd.min.2.2.0.js"></script>
    <script type="text/javascript">
      var elasticApm = init({
        serviceName: 'elastic-co-frontend',
        serverUrl: 'https://3ddd1ee09cc242c4b169d36f5a2b8b77.apm.us-west1.gcp.cloud.es.io:443',
        stackTraceLimit: 5,
        serviceVersion: '1.0.0'
      })
    
      var pageLoadName
      var pathname = window.location.pathname.replace(/\/es|\/pt|\/jp|\/pt|\/fr|\/kr|\/cn|\/de/g, '')
      var parts = pathname.split('/');
    
      if (parts.length && parts[1] === 'blog') {
        if (parts.length === 2) {
          pageLoadName =  '/blog';
        }
        else if (parts[2] === 'category') {
          pageLoadName =  '/blog/category';
        }
        else if (parts[2] === 'archive') {
          pageLoadName =  '/blog/archive';
        }
        else {
          pageLoadName =  '/blog/detail';
        }
      }
      else if (parts.length && parts[1] === 'elasticon') {
        if (parts.length === 2) {
          pageLoadName =  '/elasticon';
        }
        else if (parts.length === 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/overview';
        }
        else if (parts.length > 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/video';
        }
      }
      else if (parts.length && parts[1] === 'guide') {
        pageLoadName =  '/guide';
      }
      else if (parts.length === 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos';
      }
      else if (parts.length > 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos/detail';
      }
      else if (parts.length > 2 && parts[1] === 'webinars') {
        pageLoadName =  '/webinars/detail';
      }
      else {
        pageLoadName =  window.location.pathname;
      }
    
      console.log('apm pageLoadName:', pageLoadName, parts)
      elasticApm.setTags({env:"production"});
      elasticApm.setInitialPageLoadName(pageLoadName);
    </script>
    -->

    <!-- Header Section -->
    
    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">This information may not apply to the latest version of Elasticsearch.
For the most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="modeling-your-data.html">Modeling Your Data</a></span> » <span class="breadcrumb-link"><a href="parent-child.html">Parent-Child Relationship</a></span> » <span class="breadcrumb-node">Grandparents and Grandchildren</span></div><div class="navheader"><span class="prev"><a href="children-agg.html">
              « 
              Children Aggregation</a>
           
        </span><span class="next">
           
          <a href="parent-child-performance.html">Practical Considerations
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="grandparents"></a>Grandparents and Grandchildren<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/404_Parent_Child/65_Grandparents.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The parent-child relationship can extend across more than one generation—grandchildren can <a id="id-1.9.5.12.2.1" class="indexterm"></a>
<a id="id-1.9.5.12.2.2" class="indexterm"></a><a id="id-1.9.5.12.2.3" class="indexterm"></a>have grandparents—but it requires an extra step to ensure
that documents from all generations are indexed on the same shard.</p><p>Let’s change our previous example to make the <code class="literal">country</code> type a parent of the
<code class="literal">branch</code> type:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">PUT /company
{
  "mappings": {
    "country": {},
    "branch": {
      "_parent": {
        "type": "country" <a id="CO284-1"></a><i class="conum" data-value="1"></i>
      }
    },
    "employee": {
      "_parent": {
        "type": "branch" <a id="CO284-2"></a><i class="conum" data-value="2"></i>
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO284-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
<code class="literal">branch</code> is a child of <code class="literal">country</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO284-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
<code class="literal">employee</code> is a child of <code class="literal">branch</code>.
</p></td></tr></table></div><p>Countries and branches have a simple parent-child relationship, so we use the
same process as we used in <a class="xref" href="indexing-parent-child.html" title="Indexing Parents and Children">Indexing Parents and Children</a>:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">POST /company/country/_bulk
{ "index": { "_id": "uk" }}
{ "name": "UK" }
{ "index": { "_id": "france" }}
{ "name": "France" }

POST /company/branch/_bulk
{ "index": { "_id": "london", "parent": "uk" }}
{ "name": "London Westmintster" }
{ "index": { "_id": "liverpool", "parent": "uk" }}
{ "name": "Liverpool Central" }
{ "index": { "_id": "paris", "parent": "france" }}
{ "name": "Champs Élysées" }</pre></div><p>The <code class="literal">parent</code> ID has ensured that each <code class="literal">branch</code> document is routed to the same
shard as its parent <code class="literal">country</code> document.  However, look what would happen if we
were to use the same technique with the <code class="literal">employee</code> grandchildren:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">PUT /company/employee/1?parent=london
{
  "name":  "Alice Smith",
  "dob":   "1970-10-24",
  "hobby": "hiking"
}</pre></div><p>The shard routing of the employee document would be decided by the parent ID—<code class="literal">london</code>—but the <code class="literal">london</code> document was routed to a shard by <span class="emphasis"><em>its own</em></span>
parent ID—<code class="literal">uk</code>.  It is very likely that the grandchild would end up on
a different shard from its parent and grandparent, which would prevent the
same-shard parent-child mapping from functioning.</p><p>Instead, we need to add an extra <code class="literal">routing</code> parameter, set to the ID of the
grandparent, to ensure that all three generations are indexed on the same
shard.  The indexing request should look like this:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">PUT /company/employee/1?parent=london&amp;routing=uk <a id="CO285-1"></a><i class="conum" data-value="1"></i>
{
  "name":  "Alice Smith",
  "dob":   "1970-10-24",
  "hobby": "hiking"
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO285-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">routing</code> value overrides the <code class="literal">parent</code> value.
</p></td></tr></table></div><p>The <code class="literal">parent</code> parameter is still used to link the employee document with its
parent, but the <code class="literal">routing</code> parameter ensures that it is stored on the same
shard as its parent and grandparent. The <code class="literal">routing</code> value needs to be provided
for all single-document requests.</p><p>Querying and aggregating across generations works, as long as you step through
each generation. For instance, to find countries where employees enjoy hiking,
we need to join countries with branches, and branches with employees:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">GET /company/country/_search
{
  "query": {
    "has_child": {
      "type": "branch",
      "query": {
        "has_child": {
          "type": "employee",
          "query": {
            "match": {
              "hobby": "hiking"
            }
          }
        }
      }
    }
  }
}</pre></div></div><div class="navfooter"><span class="prev"><a href="children-agg.html">
              « 
              Children Aggregation</a>
           
        </span><span class="next">
           
          <a href="parent-child-performance.html">Practical Considerations
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>
      </section>
    </div>

    
<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>

<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
