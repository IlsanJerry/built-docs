<!DOCTYPE html>
<html lang="en-us">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Percolate Query
        | Elasticsearch Reference [5.0]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [5.0]" /><link rel="up" href="specialized-queries.html" title="Specialized queries" /><link rel="prev" href="query-dsl-script-query.html" title="Script Query" /><link rel="next" href="span-queries.html" title="Span queries" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/5.0" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="5.0" />
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <!-- DC tags section -->
    <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/" >
    <link rel="schema.DCTERMS" href="http://purl.org/dc/terms/" >
    
    <!-- end DC tags -->
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/jquery.cookie.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript">
      // -------------------- set language based on browser language --------------------
      var lang = '/'+(navigator.language || navigator.userLanguage).slice(0,2)+'/',
      locales = {
        '/en':'/',
        '/de/': '/de/',
        '/fr/': '/fr/',
        '/ja/':'/jp/',
        '/ko/':'/kr/',
        '/zh/':'/cn/',
        '/es/': '/es/'
      },
      localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}',
      currentlocale = JSON.parse(localeUrl).relative_url_prefix;

      if($.cookie("is_lang_detected") == undefined){
        if(locales[lang] != undefined && locales[lang] != currentlocale){
          locale_lang_url = locales[lang] + window.location.pathname.slice(1,window.location.pathname.length);
          $.cookie("is_lang_detected",true ,{ path: '/'});
          window.location = locale_lang_url;
        }
      }
            
      // --------------------- end of set language based on browser language -----------------
    </script>
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  

</head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <!-- Elastic APM -->
    <!--
    <script src="https://www.elastic.co/static/js/elastic-apm-js-base.umd.min.2.2.0.js"></script>
    <script type="text/javascript">
      var elasticApm = init({
        serviceName: 'elastic-co-frontend',
        serverUrl: 'https://3ddd1ee09cc242c4b169d36f5a2b8b77.apm.us-west1.gcp.cloud.es.io:443',
        stackTraceLimit: 5,
        serviceVersion: '1.0.0'
      })
    
      var pageLoadName
      var pathname = window.location.pathname.replace(/\/es|\/pt|\/jp|\/pt|\/fr|\/kr|\/cn|\/de/g, '')
      var parts = pathname.split('/');
    
      if (parts.length && parts[1] === 'blog') {
        if (parts.length === 2) {
          pageLoadName =  '/blog';
        }
        else if (parts[2] === 'category') {
          pageLoadName =  '/blog/category';
        }
        else if (parts[2] === 'archive') {
          pageLoadName =  '/blog/archive';
        }
        else {
          pageLoadName =  '/blog/detail';
        }
      }
      else if (parts.length && parts[1] === 'elasticon') {
        if (parts.length === 2) {
          pageLoadName =  '/elasticon';
        }
        else if (parts.length === 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/overview';
        }
        else if (parts.length > 5 && (parts[2] === 'conf' || parts[2] === 'tour')) {
          pageLoadName =  '/elasticon/video';
        }
      }
      else if (parts.length && parts[1] === 'guide') {
        pageLoadName =  '/guide';
      }
      else if (parts.length === 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos';
      }
      else if (parts.length > 2 && parts[1] === 'videos') {
        pageLoadName =  '/videos/detail';
      }
      else if (parts.length > 2 && parts[1] === 'webinars') {
        pageLoadName =  '/webinars/detail';
      }
      else {
        pageLoadName =  window.location.pathname;
      }
    
      console.log('apm pageLoadName:', pageLoadName, parts)
      elasticApm.setTags({env:"production"});
      elasticApm.setInitialPageLoadName(pageLoadName);
    </script>
    -->

    <!-- Header Section -->
    
    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" type="text/css" href="/static/css/horizon-swiper.min.css">

    <style> 
      .m-shortcuts li a.m-search {
        background: url("/assets/blt7b9c4fe6528dc4ef/m-search-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}

      .m-shortcuts li a.m-docs {
        background: url("/assets/blt44d8b7530a76d01c/m-guide-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}

      .m-shortcuts li a.m-contact {
        background: url("/assets/blt878040795c9d083b/m-contact-icon.png") no-repeat scroll center center rgba(0, 0, 0, 0);
        background-size: contain;}
    </style>

    <script type="text/javascript" src="/static/js/horizon-swiper.min.js"></script>

    <script type="text/javascript">
      $(document).ready( function(){
        // if($('#scrollable-pane li').length > 3){
          $('.horizon-swiper').horizonSwiper({
            showItems: 3,
            arrows: true
          }); 
        // }
        
        $('.navbar-toggle').on('click', function(){
          $('.mobile-navigation, .menu-open').hide();
          $('.navigation-wrapper').addClass('mobile-navigation');
          $('.navbar').addClass('menu-open');
          $('.menu-close').show();
        });
        $('.menu-close').on('click', function(){
          $('.navigation-wrapper').removeClass('mobile-navigation');
          $('.navbar').removeClass('menu-open');
          $('.menu-close').hide();
        });
    
        var active_url = "";
    
        $(".navbar-mobile-header-icon").click(function(index){
          $('.navigation-wrapper').toggleClass('menu-overlay');
          $(this).toggleClass("navbar-mobile-header-icon-click navbar-mobile-header-icon-out");
          $(".mobile-inner-nav").slideToggle(500);
          $(".mobile-inner-nav .navbar-nav a").each(function( index ) {
            $(this).css({'animation-delay': (index/25)+'0.4s'});
          });
        });
    
        $('.dropdown-btn').on('click', function(e){
          e.preventDefault();
          setDropdown();
        });
        
        function setDropdown() {
          $('#myDropdown').slideToggle();
        }
    
        $('body').on('click', function(event){
          if (!event.target.matches('.dropdown-btn')) {
    
            var dropdowns = $(".dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
              }
            }
          }
        });
    
      });
      $(window).resize(function () {
        $('.horizon-swiper').horizonSwiper({
          showItems: 3,
          arrows: true
        });
      });
    </script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">   

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <!-- start body -->
                
            <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
            <!-- start body -->
<div class="page_header">You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [5.0]
    </a></span> » <span class="breadcrumb-link"><a href="query-dsl.html">Query DSL</a></span> » <span class="breadcrumb-link"><a href="specialized-queries.html">Specialized queries</a></span> » <span class="breadcrumb-node">Percolate Query</span></div><div class="navheader"><span class="prev"><a href="query-dsl-script-query.html">
              « 
              Script Query</a>
           
        </span><span class="next">
           
          <a href="span-queries.html">Span queries
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="query-dsl-percolate-query"></a>Percolate Query<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The <code class="literal">percolate</code> query can be used to match queries
stored in an index. The <code class="literal">percolate</code> query itself
contains the document that will be used as query
to match with the stored queries.</p><h3><a id="_sample_usage"></a>Sample Usage<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>Create an index with two mappings:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /my-index
{
    "mappings": {
        "doctype": {
            "properties": {
                "message": {
                    "type": "text"
                }
            }
        },
        "queries": {
            "properties": {
                "query": {
                    "type": "percolator"
                }
            }
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/530.console"></div><p>The <code class="literal">doctype</code> mapping is the mapping used to preprocess
the document defined in the <code class="literal">percolator</code> query before it
gets indexed into a temporary index.</p><p>The <code class="literal">queries</code> mapping is the mapping used for indexing
the query documents. The <code class="literal">query</code> field will hold a json
object that represents an actual Elasticsearch query. The
<code class="literal">query</code> field has been configured to use the
<a class="link" href="percolator.html" title="Percolator type">percolator field type</a>. This field type understands
the query dsl and stored the query in such a way that it
can be used later on to match documents defined on the <code class="literal">percolate</code> query.</p><p>Register a query in the percolator:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /my-index/queries/1?refresh
{
    "query" : {
        "match" : {
            "message" : "bonsai tree"
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/531.console"></div><p>Match a document to the registered percolator queries:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">GET /my-index/_search
{
    "query" : {
        "percolate" : {
            "field" : "query",
            "document_type" : "doctype",
            "document" : {
                "message" : "A new bonsai tree in the office"
            }
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/532.console"></div><p>The above request will yield the following response:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
  "took": 13,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "failed": 0
  },
  "hits": {
    "total": 1,
    "max_score": 0.5716521,
    "hits": [
      { <a id="CO164-1"></a><i class="conum" data-value="1"></i>
        "_index": "my-index",
        "_type": "queries",
        "_id": "1",
        "_score": 0.5716521,
        "_source": {
          "query": {
            "match": {
              "message": "bonsai tree"
            }
          }
        }
      }
    ]
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO164-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>The query with id <code class="literal">1</code> matches our document.</p></td></tr></table></div><h4><a id="_parameters_9"></a>Parameters<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The following parameters are required when percolating a document:</p><div class="informaltable"><table cellpadding="4px" border="0"><colgroup><col /><col /></colgroup><tbody valign="top"><tr><td valign="top">
<p><code class="literal">field</code></p>
</td><td valign="top">
<p>The field of type <code class="literal">percolator</code> and that holds the indexed queries. This is a required parameter.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">document_type</code></p>
</td><td valign="top">
<p>The type / mapping of the document being percolated. This is a required parameter.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">document</code></p>
</td><td valign="top">
<p>The source of the document being percolated.</p>
</td></tr></tbody></table></div><p>Instead of specifying the source of the document being percolated, the source can also be retrieved from an already
stored document. The <code class="literal">percolate</code> query will then internally execute a get request to fetch that document.</p><p>In that case the <code class="literal">document</code> parameter can be substituted with the following parameters:</p><div class="informaltable"><table cellpadding="4px" border="0"><colgroup><col /><col /></colgroup><tbody valign="top"><tr><td valign="top">
<p><code class="literal">index</code></p>
</td><td valign="top">
<p>The index the document resides in. This is a required parameter.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">type</code></p>
</td><td valign="top">
<p>The type of the document to fetch. This is a required parameter.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">id</code></p>
</td><td valign="top">
<p>The id of the document to fetch. This is a required parameter.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">routing</code></p>
</td><td valign="top">
<p>Optionally, routing to be used to fetch document to percolate.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">preference</code></p>
</td><td valign="top">
<p>Optionally, preference to be used to fetch document to percolate.</p>
</td></tr><tr><td valign="top">
<p><code class="literal">version</code></p>
</td><td valign="top">
<p>Optionally, the expected version of the document to be fetched.</p>
</td></tr></tbody></table></div><h4><a id="_percolating_an_existing_document"></a>Percolating an Existing Document<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>In order to percolate a newly indexed document, the <code class="literal">percolate</code> query can be used. Based on the response
from an index request, the <code class="literal">_id</code> and other meta information can be used to immediately percolate the newly added
document.</p><h5><a id="_example_2"></a>Example<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Based on the previous example.</p><p>Index the document we want to percolate:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /my-index/message/1
{
  "message" : "A new bonsai tree in the office"
}</pre></div><div class="console_widget" data-snippet="snippets/533.console"></div><p>Index response:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
  "_index": "my-index",
  "_type": "message",
  "_id": "1",
  "_version": 1,
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "created": true,
  "result": "created"
}</pre></div><p>Percolating an existing document, using the index response as basis to build to new search request:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">GET /my-index/_search
{
    "query" : {
        "percolate" : {
            "field": "query",
            "document_type" : "doctype",
            "index" : "my-index",
            "type" : "message",
            "id" : "1",
            "version" : 1 <a id="CO165-1"></a><i class="conum" data-value="1"></i>
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/534.console"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO165-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>The version is optional, but useful in certain cases. We can then ensure that we are try to percolate
the document we just have indexed. A change may be made after we have indexed, and if that is the
case the then the search request would fail with a version conflict error.</p></td></tr></table></div><p>The search response returned is identical as in the previous example.</p><h4><a id="_percolate_query_and_highlighting"></a>Percolate query and highlighting<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The <code class="literal">percolate</code> query is handled in a special way when it comes to highlighting. The queries hits are used
to highlight the document that is provided in the <code class="literal">percolate</code> query. Whereas with regular highlighting the query in
the search request is used to highlight the hits.</p><h5><a id="_example_3"></a>Example<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>This example is based on the mapping of the first example.</p><p>Save a query:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /my-index/queries/1?refresh
{
    "query" : {
        "match" : {
            "message" : "brown fox"
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/535.console"></div><p>Save another query:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /my-index/queries/2?refresh
{
    "query" : {
        "match" : {
            "message" : "lazy dog"
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/536.console"></div><p>Execute a search request with the <code class="literal">percolate</code> query and highlighting enabled:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">GET /my-index/_search
{
    "query" : {
        "percolate" : {
            "field": "query",
            "document_type" : "doctype",
            "document" : {
                "message" : "The quick brown fox jumps over the lazy dog"
            }
        }
    },
    "highlight": {
      "fields": {
        "message": {}
      }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/537.console"></div><p>This will yield the following response.</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
  "took": 7,
  "timed_out": false,
  "_shards": {
    "total": 5,
    "successful": 5,
    "failed": 0
  },
  "hits": {
    "total": 2,
    "max_score": 0.5446649,
    "hits": [
      {
        "_index": "my-index",
        "_type": "queries",
        "_id": "2",
        "_score": 0.5446649,
        "_source": {
          "query": {
            "match": {
              "message": "lazy dog"
            }
          }
        },
        "highlight": {
          "message": [
            "The quick brown fox jumps over the &lt;em&gt;lazy&lt;/em&gt; &lt;em&gt;dog&lt;/em&gt;" <a id="CO166-1"></a><i class="conum" data-value="1"></i>
          ]
        }
      },
      {
        "_index": "my-index",
        "_type": "queries",
        "_id": "1",
        "_score": 0.5446649,
        "_source": {
          "query": {
            "match": {
              "message": "brown fox"
            }
          }
        },
        "highlight": {
          "message": [
            "The quick &lt;em&gt;brown&lt;/em&gt; &lt;em&gt;fox&lt;/em&gt; jumps over the lazy dog" <a id="CO166-2"></a><i class="conum" data-value="2"></i>
          ]
        }
      }
    ]
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO166-1"><i class="conum" data-value="1"></i></a> <a href="#CO166-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>The terms from each query have been highlighted in the document.</p></td></tr></table></div><p>Instead of the query in the search request highlighting the percolator hits, the percolator queries are highlighting
the document defined in the <code class="literal">percolate</code> query.</p><h4><a id="_how_it_works_under_the_hood"></a>How it Works Under the Hood<a href="https://github.com/elastic/elasticsearch/edit/5.0/docs/reference/query-dsl/percolate-query.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>When indexing a document into an index that has the <a class="link" href="percolator.html" title="Percolator type">percolator field type</a> mapping configured, the query
part of the documents gets parsed into a Lucene query and are stored into the Lucene index. A binary representation
of the query gets stored, but also the query’s terms are analyzed and stored into an indexed field.</p><p>At search time, the document specified in the request gets parsed into a Lucene document and is stored in a in-memory
temporary Lucene index. This in-memory index can just hold this one document and it is optimized for that. After this
a special query is build based on the terms in the in-memory index that select candidate percolator queries based on
their indexed query terms. These queries are then evaluated by the in-memory index if they actually match.</p><p>The selecting of candidate percolator queries matches is an important performance optimization during the execution
of the <code class="literal">percolate</code> query as it can significantly reduce the number of candidate matches the in-memory index needs to
evaluate. The reason the <code class="literal">percolate</code> query can do this is because during indexing of the percolator queries the query
terms are being extracted and indexed with the percolator query. Unfortunately the percolator cannot extract terms from
all queries (for example the <code class="literal">wildcard</code> or <code class="literal">geo_shape</code> query) and as a result of that in certain cases the percolator
can’t do the selecting optimization (for example if an unsupported query is defined in a required clause of a boolean query
or the unsupported query is the only query in the percolator document).  These queries are marked by the percolator and
can be found by running the following search:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">GET /_search
{
  "query": {
    "term" : {
      "query.extraction_result" : "failed"
    }
  }
}</pre></div><div class="console_widget" data-snippet="snippets/538.console"></div><div class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>The above example assumes that there is a <code class="literal">query</code> field of type
<code class="literal">percolator</code> in the mappings.</p></div></div></div><div class="navfooter"><span class="prev"><a href="query-dsl-script-query.html">
              « 
              Script Query</a>
           
        </span><span class="next">
           
          <a href="span-queries.html">Span queries
               »
            </a></span></div>
<!-- end body -->

            </div>
            <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
        
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'</div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>

<style type="text/css">
	
        
            .Facebook a {background:url("/assets/bltf546ff2e0a8f2de5/facebook.svg") no-repeat;}
            .Facebook a:before {
                content: url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Facebook a:hover {background:url("/assets/bltc24cf11c714ecfc4/facebook-hover.svg")}		
        
	
        
            .Twitter a {background:url("/assets/bltdd9556d6b24e2b85/twitter.svg") no-repeat;}
            .Twitter a:before {
                content: url("/assets/blt90b0372cc07a54d3/twitter-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Twitter a:hover {background:url("/assets/blt90b0372cc07a54d3/twitter-hover.svg")}		
        
	
        
            .LinkedIn a {background:url("/assets/bltc4a77e0f52ce07f1/linkedin.svg") no-repeat;}
            .LinkedIn a:before {
                content: url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .LinkedIn a:hover {background:url("/assets/blt01ce654380e4ea6c/linkedin-hover.svg")}		
        
	
        
            .Xing a {background:url("/assets/bltc6347078dcc9ec76/xing.svg") no-repeat;}
            .Xing a:before {
                content: url("/assets/bltededebe5f7521a39/xing-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .Xing a:hover {background:url("/assets/bltededebe5f7521a39/xing-hover.svg")}		
        
	
        
            .YouTube a {background:url("/assets/blt4982061ce1aebc7f/youtube.svg") no-repeat;}
            .YouTube a:before {
                content: url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg");
                width:0;
                height:0;
                visibility:hidden;
            }
        
        
            .YouTube a:hover {background:url("/assets/bltddeb6c6404ae81a5/youtube-hover.svg")}		
        
	
</style>

      </section>
    </div>

    
<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/static/js/jquery.autocomplete.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script src="/static/js/nav-v5.js"></script>
<script src="/static/js/script.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
  
            <script type="text/javascript">
window.initial_state = {}
</script>

            </body>
        
</html>
