<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>MinHash Token Filter
        | Elasticsearch Reference [7.3]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [7.3]" /><link rel="up" href="analysis-tokenfilters.html" title="Token Filters" /><link rel="prev" href="analysis-fingerprint-tokenfilter.html" title="Fingerprint Token Filter" /><link rel="next" href="analysis-remove-duplicates-tokenfilter.html" title="Remove Duplicates Token Filter" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.3" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="7.3" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="description" content="" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- For third-generation iPad with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <!-- For iPhone with high-resolution Retina display: -->
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <!-- For first- and second-generation iPad: -->
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- css -->
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- new ga for staging server -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>
    <!-- new ga for staging server -->

    <div id='elastic-nav'></div>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [7.3]
    </a></span> » <span class="breadcrumb-link"><a href="analysis.html">Analysis</a></span> » <span class="breadcrumb-link"><a href="analysis-tokenfilters.html">Token Filters</a></span> » <span class="breadcrumb-node">MinHash Token Filter</span></div><div class="navheader"><span class="prev"><a href="analysis-fingerprint-tokenfilter.html">
              « 
              Fingerprint Token Filter</a>
           
        </span><span class="next">
           
          <a href="analysis-remove-duplicates-tokenfilter.html">Remove Duplicates Token Filter
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="analysis-minhash-tokenfilter"></a>MinHash Token Filter<a href="https://github.com/elastic/elasticsearch/edit/7.3/docs/reference/analysis/tokenfilters/minhash-tokenfilter.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The <code class="literal">min_hash</code> token filter hashes each token of the token stream and divides
the resulting hashes into buckets, keeping the lowest-valued hashes per
bucket. It then returns these hashes as tokens.</p><p>The following are settings that can be set for a <code class="literal">min_hash</code> token filter.</p><div class="informaltable"><table cellpadding="4px" border="1"><colgroup><col class="col_1" /><col class="col_2" /></colgroup><thead><tr><th align="left" valign="top">Setting</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p><code class="literal">hash_count</code></p></td><td align="left" valign="top"><p>The number of hashes to hash the token stream with. Defaults to <code class="literal">1</code>.</p></td></tr><tr><td align="left" valign="top"><p><code class="literal">bucket_count</code></p></td><td align="left" valign="top"><p>The number of buckets to divide the minhashes into. Defaults to <code class="literal">512</code>.</p></td></tr><tr><td align="left" valign="top"><p><code class="literal">hash_set_size</code></p></td><td align="left" valign="top"><p>The number of minhashes to keep per bucket. Defaults to <code class="literal">1</code>.</p></td></tr><tr><td align="left" valign="top"><p><code class="literal">with_rotation</code></p></td><td align="left" valign="top"><p>Whether or not to fill empty buckets with the value of the first non-empty
bucket to its circular right. Only takes effect if hash_set_size is equal to one.
Defaults to <code class="literal">true</code> if bucket_count is greater than one, else <code class="literal">false</code>.</p></td></tr></tbody></table></div><p>Some points to consider while setting up a <code class="literal">min_hash</code> filter:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">min_hash</code> filter input tokens should typically be k-words shingles produced
from <a class="link" href="analysis-shingle-tokenfilter.html" title="Shingle Token Filter">shingle token filter</a>.  You should
choose <code class="literal">k</code> large enough so that the probability of any given shingle
occurring in a  document is low. At the same time, as
internally each shingle is hashed into to 128-bit hash, you should choose
<code class="literal">k</code> small enough so that all possible
different k-words shingles can be hashed to 128-bit hash with
minimal collision.</li><li class="listitem"><p class="simpara">choosing the right settings for <code class="literal">hash_count</code>, <code class="literal">bucket_count</code> and
<code class="literal">hash_set_size</code> needs some experimentation.</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">to improve the precision, you should increase <code class="literal">bucket_count</code> or
<code class="literal">hash_set_size</code>. Higher values of <code class="literal">bucket_count</code> or <code class="literal">hash_set_size</code>
will provide a higher guarantee that different tokens are
indexed to different buckets.</li><li class="listitem">to improve the recall,
you should increase <code class="literal">hash_count</code> parameter. For example,
setting <code class="literal">hash_count=2</code>, will make each token to be hashed in
two different ways, thus increasing the number of potential
candidates for search.</li></ul></div></li><li class="listitem">the default settings makes the  <code class="literal">min_hash</code> filter to produce for
each document 512 <code class="literal">min_hash</code> tokens, each is of size 16 bytes.
Thus, each document’s size will be increased by around 8Kb.</li><li class="listitem"><code class="literal">min_hash</code> filter is used to hash for Jaccard similarity. This means
that it doesn’t matter how many times a document contains a certain token,
only that if it contains it or not.</li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_theory"></a>Theory<a href="https://github.com/elastic/elasticsearch/edit/7.3/docs/reference/analysis/tokenfilters/minhash-tokenfilter.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>MinHash token filter allows you to hash documents for similarity search.
Similarity search, or nearest neighbor search is a complex problem.
A naive solution requires an exhaustive pairwise comparison between a query
document and every document in an index. This is a prohibitive operation
if the index is large. A number of approximate nearest neighbor search
solutions have been developed to make similarity search more practical and
computationally feasible. One of these solutions involves hashing of documents.</p><p>Documents are hashed in a way that similar documents are more likely
to produce the same hash code and are put into the same hash bucket,
while dissimilar documents are more likely to be hashed into
different hash buckets. This type of hashing is known as
locality sensitive hashing (LSH).</p><p>Depending on what constitutes the similarity between documents,
various LSH functions <a class="ulink" href="https://arxiv.org/abs/1408.2927" target="_top">have been proposed</a>.
For <a class="ulink" href="https://en.wikipedia.org/wiki/Jaccard_index" target="_top">Jaccard similarity</a>, a popular
LSH function is <a class="ulink" href="https://en.wikipedia.org/wiki/MinHash" target="_top">MinHash</a>.
A general idea of the way MinHash produces a signature for a document
is by applying a random permutation over the whole index vocabulary (random
numbering for the vocabulary), and recording the minimum value for this permutation
for the document (the minimum number for a vocabulary word that is present
in the document). The permutations are run several times;
combining the minimum values for all of them will constitute a
signature for the document.</p><p>In practice, instead of random permutations, a number of hash functions
are chosen. A hash function calculates a hash code for each of a
document’s tokens and chooses the minimum hash code among them.
The minimum hash codes from all hash functions are combined
to form a signature for the document.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_of_setting_minhash_token_filter_in_elasticsearch"></a>Example of setting MinHash Token Filter in Elasticsearch<a href="https://github.com/elastic/elasticsearch/edit/7.3/docs/reference/analysis/tokenfilters/minhash-tokenfilter.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Here is an example of setting up a <code class="literal">min_hash</code> filter:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">POST /index1
{
  "settings": {
    "analysis": {
      "filter": {
        "my_shingle_filter": { <a id="CO298-1"></a><i class="conum" data-value="1"></i>
          "type": "shingle",
          "min_shingle_size": 5,
          "max_shingle_size": 5,
          "output_unigrams": false
        },
        "my_minhash_filter": {
          "type": "min_hash",
          "hash_count": 1,   <a id="CO298-2"></a><i class="conum" data-value="2"></i>
          "bucket_count": 512, <a id="CO298-3"></a><i class="conum" data-value="3"></i>
          "hash_set_size": 1, <a id="CO298-4"></a><i class="conum" data-value="4"></i>
          "with_rotation": true <a id="CO298-5"></a><i class="conum" data-value="5"></i>
        }
      },
      "analyzer": {
        "my_analyzer": {
          "tokenizer": "standard",
          "filter": [
            "my_shingle_filter",
            "my_minhash_filter"
          ]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "fingerprint": {
        "type": "text",
        "analyzer": "my_analyzer"
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO298-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>setting a shingle filter with 5-word shingles</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO298-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>setting min_hash filter to hash with 1 hash</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO298-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>setting min_hash filter to hash tokens into 512 buckets</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO298-4"><i class="conum" data-value="4"></i></a> </p></td><td valign="top" align="left"><p>setting min_hash filter to keep only a single smallest hash in each bucket</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO298-5"><i class="conum" data-value="5"></i></a> </p></td><td valign="top" align="left"><p>setting min_hash filter to fill empty buckets with values from neighboring buckets</p></td></tr></table></div></div></div><div class="navfooter"><span class="prev"><a href="analysis-fingerprint-tokenfilter.html">
              « 
              Fingerprint Token Filter</a>
           
        </span><span class="next">
           
          <a href="analysis-remove-duplicates-tokenfilter.html">Remove Duplicates Token Filter
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Getting Started Videos</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/webinars/getting-started-elasticsearch?baymax=default&elektra=docs&storm=top-video">Starting Elasticsearch</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Introduction to Kibana</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/getting-started-logstash?baymax=default&elektra=docs&storm=top-video">Logstash Starter Guide</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<!-- Footer Section end-->

<script src='https://www.elastic.co/elastic-nav.js'></script>
<script src='https://www.elastic.co/elastic-footer.js'></script>
      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script type="text/javascript" src="/static/js/slick.min.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>

<script type="text/javascript">
window.initial_state = {}</script>
  </body>
</html>
