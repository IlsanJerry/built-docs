<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Configuring a PKI realm
        | Elasticsearch Reference [7.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch Reference [7.x]" /><link rel="up" href="configuring-security.html" title="Configuring security in Elasticsearch" /><link rel="prev" href="configuring-ad-realm.html" title="Configuring an Active Directory realm" /><link rel="next" href="security-files.html" title="Security files" /><meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="7.x" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta property="og:image" content="https://www.elastic.co/static/images/elastic-logo-200.png" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <!-- Subnav -->
    <div>
      <div>
        <div class="tertiary-nav d-none d-md-block">
          <div class="container">
            <div class="p-t-b-15 d-flex justify-content-between nav-container">
              <div class="breadcrum-wrapper"><span><a href="/guide/" style="font-size: 14px; font-weight: 600; color: #000;">Docs</a></span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container">
              <div class="row">
                <div class="col-xs-12 col-sm-8 col-md-8 guide-section">
                  <!-- start body -->
                  <div class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [7.x]
    </a></span> » <span class="breadcrumb-link"><a href="secure-cluster.html">Secure a cluster</a></span> » <span class="breadcrumb-link"><a href="configuring-security.html">Configuring security in Elasticsearch</a></span> » <span class="breadcrumb-node">Configuring a PKI realm</span></div><div class="navheader"><span class="prev"><a href="configuring-ad-realm.html">
              « 
              Configuring an Active Directory realm</a>
           
        </span><span class="next">
           
          <a href="security-files.html">Security files
               »
            </a></span></div><div class="xpack section"><div class="titlepage"><div><div><h2 class="title"><a id="configuring-pki-realm"></a>Configuring a PKI realm<a href="https://github.com/elastic/elasticsearch/edit/7.x/x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2></div></div></div><p>You can configure Elasticsearch to use Public Key Infrastructure (PKI) certificates to
authenticate users. This requires clients connecting directly to Elasticsearch to
present X.509 certificates. The certificates must first be accepted for
authentication on the SSL/TLS layer on Elasticsearch. Only then they are optionally
further validated by a PKI realm.</p><p>Users may also use PKI certificates to authenticate to Kibana, however this
requires some <a class="link" href="configuring-pki-realm.html#pki-realm-for-proxied-clients" title="PKI authentication for clients connecting to Kibana">additional configuration</a>. On
Elasticsearch, this configuration enables Kibana to act as a proxy for SSL/TLS
authentication and to submit the client certificates to Elasticsearch for further
validation by a PKI realm.</p><p>For more general information, see <a class="xref" href="pki-realm.html" title="PKI user authentication">PKI user authentication</a>.</p><h4><a id="pki-realm-for-direct-clients"></a>PKI authentication for clients connecting directly to Elasticsearch<a href="https://github.com/elastic/elasticsearch/edit/7.x/x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>To use PKI in Elasticsearch, you configure a PKI realm, enable client authentication on
the desired network layers (transport or http), and map the Distinguished Name
(DN) from the Subject field in the user certificate to roles by using the
<a class="link" href="security-api-role-mapping.html" title="Role mapping APIs">role-mapping API</a> or the role-mapping file.</p><p>You can also use a combination of PKI and username/password authentication. For
example, you can enable SSL/TLS on the transport layer and define a PKI realm to
require transport clients to authenticate with X.509 certificates, while still
authenticating HTTP traffic using username and password credentials. You can
also set <code class="literal">xpack.security.transport.ssl.client_authentication</code> to <code class="literal">optional</code> to
allow clients without certificates to authenticate with other credentials.</p><div class="important admon"><div class="icon"></div><div class="admon_content"><p>You must enable SSL/TLS with client authentication to use PKI when
clients connect directly to Elasticsearch.</p></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Add a realm configuration for a <code class="literal">pki</code> realm to <code class="literal">elasticsearch.yml</code> under the
<code class="literal">xpack.security.authc.realms.pki</code> namespace.
If you are configuring multiple realms, you should
explicitly set the <code class="literal">order</code> attribute. See <a class="xref" href="security-settings.html#ref-pki-settings" title="PKI realm settings">PKI realm settings</a> for all of the
options you can set for a <code class="literal">pki</code> realm.</p><p class="simpara">For example, the following snippet shows the most basic <code class="literal">pki</code> realm configuration:</p><div class="pre_wrapper lang-yaml"><pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            order: 1</pre></div><p class="simpara">With this configuration, any certificate trusted by the Elasticsearch SSL/TLS layer is
accepted for authentication. The username is the common name (CN) extracted
from the DN in the Subject field of the end-entity certificate. This
configuration does not permit PKI authentication to Kibana.</p><div class="important admon"><div class="icon"></div><div class="admon_content"><p>When you configure realms in <code class="literal">elasticsearch.yml</code>, only the
realms you specify are used for authentication. If you also want to use the
<code class="literal">native</code> or <code class="literal">file</code> realms, you must include them in the realm chain.</p></div></div><p class="simpara">If you want to use something other than the CN of the Subject DN as the
username, you can specify a regex to extract the desired username. The regex is
applied on the Subject DN. For example, the regex in the following
configuration extracts the email address from the Subject DN:</p><div class="pre_wrapper lang-yaml"><pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            username_pattern: "EMAILADDRESS=(.*?)(?:,|$)"</pre></div><div class="note admon"><div class="icon"></div><div class="admon_content"><p>If the regex is too restrictive and does not match the Subject DN of the
client’s certificate, then the realm does not authenticate the certificate.</p></div></div></li><li class="listitem">Restart Elasticsearch because realm configuration is not reloaded automatically. If
you’re following through with the next steps, you might wish to hold the
restart for last.</li><li class="listitem"><a class="link" href="configuring-tls.html" title="Encrypting communications in Elasticsearch">Enable SSL/TLS</a>.</li><li class="listitem"><p class="simpara">Enable client authentication on the desired network layers (transport or http).</p><p class="simpara">When clients connect directly to Elasticsearch and are not proxy-authenticated, the PKI
realm relies on the TLS settings of the node’s network interface. The realm can
be configured to be more restrictive than the underlying network connection.
That is, it is possible to configure the node such that some connections
are accepted by the network interface but then fail to be authenticated by the
PKI realm. However, the reverse is not possible. The PKI realm cannot
authenticate a connection that has been refused by the network interface.</p><p class="simpara">In particular this means:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The transport or http interface must request client certificates by setting
<code class="literal">client_authentication</code> to <code class="literal">optional</code> or <code class="literal">required</code>.</li><li class="listitem">The interface must <span class="emphasis"><em>trust</em></span> the certificate that is presented by the client
by configuring either the <code class="literal">truststore</code> or <code class="literal">certificate_authorities</code> paths,
or by setting <code class="literal">verification_mode</code> to <code class="literal">none</code>. See
<a class="link" href="security-settings.html#ssl-tls-settings" title="Default values for TLS/SSL settings"><code class="literal">ssl.verification_mode</code></a> for an explanation of this
setting.</li><li class="listitem">The <span class="emphasis"><em>protocols</em></span> supported by the interface must be compatible with those
used by the client.</li></ul></div><p class="simpara">The relevant network interface (transport or http) must be configured to trust
any certificate that is to be used within the PKI realm. However, it is possible to
configure the PKI realm to trust only a <span class="emphasis"><em>subset</em></span> of the certificates accepted
by the network interface. This is useful when the SSL/TLS layer trusts clients
with certificates that are signed by a different CA than the one that signs your
users' certificates.</p><p class="simpara">To configure the PKI realm with its own truststore, specify the
<code class="literal">truststore.path</code> option. The path must be located within the Elasticsearch
configuration directory (ES_PATH_CONF). For example:</p><div class="pre_wrapper lang-yaml"><pre class="programlisting prettyprint lang-yaml">xpack:
  security:
    authc:
      realms:
        pki:
          pki1:
            truststore:
              path: "pki1_truststore.jks"</pre></div><p class="simpara">If the truststore is password protected, the password should be configured by
adding the appropriate <code class="literal">secure_password</code> setting to the Elasticsearch keystore.  For
example, the following command adds the password for the example realm above:</p><div class="pre_wrapper lang-shell"><pre class="programlisting prettyprint lang-shell">bin/elasticsearch-keystore add \
xpack.security.authc.realms.pki.pki1.truststore.secure_password</pre></div><p class="simpara">The <code class="literal">certificate_authorities</code> option can be used as an alternative to the
<code class="literal">truststore.path</code> setting, when the certificate files are PEM formatted
. The setting accepts a list. The two options are exclusive, they cannot be both used
simultaneously.</p></li><li class="listitem"><p class="simpara">Map roles for PKI users.</p><p class="simpara">You map roles for PKI users through the <a class="link" href="security-api.html#security-role-mapping-apis" title="Role mappings">role
mapping APIs</a> or by using a file stored on each node. Both configuration
options are merged together. When a user authenticates against a PKI realm, the
privileges for that user are the union of all privileges defined by the roles
to which the user is mapped.</p><p class="simpara">You identify a user by the distinguished name in their certificate.
For example, the following mapping configuration maps <code class="literal">John Doe</code> to the
<code class="literal">user</code> role:</p><p class="simpara">Using the role-mapping API:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/users
{
  "roles" : [ "user" ],
  "rules" : { "field" : {
    "dn" : "cn=John Doe,ou=example,o=com" <a id="CO470-1"></a><i class="conum" data-value="1"></i>
  } },
  "enabled": true
}</pre></div><div class="console_widget" data-snippet="snippets/1104.console"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO470-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>The distinguished name (DN) of a PKI user.</p></td></tr></table></div><p class="simpara">Or, alternatively, configured inside a role-mapping file. The file’s path
defaults to <code class="literal">ES_PATH_CONF/role_mapping.yml</code>. You can specify a different path (which must be within
ES_PATH_CONF) by using the <code class="literal">files.role_mapping</code> realm setting (e.g.
<code class="literal">xpack.security.authc.realms.pki.pki1.files.role_mapping</code>):</p><div class="pre_wrapper lang-yaml"><pre class="programlisting prettyprint lang-yaml">user: <a id="CO471-1"></a><i class="conum" data-value="1"></i>
  - "cn=John Doe,ou=example,o=com" <a id="CO471-2"></a><i class="conum" data-value="2"></i></pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO471-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>The name of a role.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO471-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>The distinguished name (DN) of a PKI user.</p></td></tr></table></div><p class="simpara">The distinguished name for a PKI user follows X.500 naming conventions which
place the most specific fields (like <code class="literal">cn</code> or <code class="literal">uid</code>) at the beginning of the
name, and the most general fields (like <code class="literal">o</code> or <code class="literal">dc</code>) at the end of the name.
Some tools, such as <span class="emphasis"><em>openssl</em></span>, may print out the subject name in a different
format.</p><p class="simpara">One way that you can determine the correct DN for a certificate is to use the
<a class="link" href="security-api-authenticate.html" title="Authenticate API">authenticate API</a> (use the relevant PKI
certificate as the means of authentication) and inspect the metadata field in
the result. The user’s distinguished name will be populated under the <code class="literal">pki_dn</code>
key. You can also use the authenticate API to validate your role mapping.</p><p class="simpara">For more information, see <a class="xref" href="mapping-roles.html" title="Mapping users and groups to roles">Mapping users and groups to roles</a>.</p><div class="note admon"><div class="icon"></div><div class="admon_content"><p>The PKI realm supports <a class="link" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms</a> as an
alternative to role mapping.</p></div></div></li></ol></div><h4><a id="pki-realm-for-proxied-clients"></a>PKI authentication for clients connecting to Kibana<a href="https://github.com/elastic/elasticsearch/edit/7.x/x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>By default, the PKI realm relies on the node’s network interface to perform the
SSL/TLS handshake and extract the client certificate. This behaviour requires
that that clients connect directly to Elasticsearch so that their SSL connection is
terminated by the Elasticsearch node.  If SSL/TLS authenticatication is to be performed
by Kibana, the PKI realm must be configured to permit delegation.</p><p>Specifically, when clients presenting X.509 certificates connect to Kibana,
Kibana performs the SSL/TLS authentication. Kibana then forwards the client’s
certificate chain, by calling an Elasticsearch API, to have them further validated by
the PKI realms that have been configured for delegation.</p><p>To permit authentication delegation for a specific Elasticsearch PKI realm, start by
configuring the realm for the usual case, as detailed in the
<a class="xref" href="configuring-pki-realm.html#pki-realm-for-direct-clients" title="PKI authentication for clients connecting directly to Elasticsearch">PKI authentication for clients connecting directly to Elasticsearch</a>
section. Note that you must explicitly configure a <code class="literal">truststore</code> (or,
equivalently <code class="literal">certificate_authorities</code>) even though it is the same trust
configuration that you have configured on the network layer.  Afterwards,
simply toggle the <code class="literal">delegation.enabled</code> realm setting to <code class="literal">true</code>.  This realm is
now allowed to validate delegated PKI authentication (after restarting Elasticsearch).</p><div class="note admon"><div class="icon"></div><div class="admon_content"><p>PKI authentication delegation requires that the
<code class="literal">xpack.security.authc.token.enabled</code> setting be <code class="literal">true</code> and that SSL/TLS be
configured (without SSL/TLS client authentication).</p></div></div><div class="note admon"><div class="icon"></div><div class="admon_content"><p>Kibana also needs to be
<a class="ulink" href="/guide/en/kibana/7.x/kibana-authentication.html#pki-authentication" target="_top">configured to allow
PKI certificate authentication</a>.</p></div></div><p>A PKI realm with <code class="literal">delegation.enabled</code> still works unchanged for clients
connecting directly to Elasticsearch. Directly authenticated users, and users that are PKI
authenticated by delegation to Kibana both follow the same
<a class="link" href="mapping-roles.html" title="Mapping users and groups to roles">role mapping rules</a> or
<a class="link" href="realm-chains.html#authorization_realms" title="Delegating authorization to another realm">authorization realms configurations</a>.</p><p>However, if you use the <a class="link" href="security-api.html#security-role-mapping-apis" title="Role mappings">role mapping APIs</a>,
you can distinguish between users that are authenticated by delegation and
users that are authenticated directly. The former have the
extra fields <code class="literal">pki_delegated_by_user</code> and <code class="literal">pki_delegated_by_realm</code> in the user’s
metadata. In the common setup, where authentication is delegated to Kibana, the
values of these fields are <code class="literal">kibana</code> and <code class="literal">reserved</code>, respectively. For example,
the following role mapping rule will assign the <code class="literal">role_for_pki1_direct</code> role to
all users that have been authenticated directly by the <code class="literal">pki1</code> realm, by
connecting to Elasticsearch instead of going through Kibana:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /_security/role_mapping/direct_pki_only
{
  "roles" : [ "role_for_pki1_direct" ],
  "rules" : {
    "all": [
      {
        "field": {"realm.name": "pki1"}
      },
      {
        "field": {
          "metadata.pki_delegated_by_user": null <a id="CO472-1"></a><i class="conum" data-value="1"></i>
        }
      }
    ]
  },
  "enabled": true
}</pre></div><div class="console_widget" data-snippet="snippets/1105.console"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO472-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>only when this metadata field is set (it is <span class="strong strong"><strong>not</strong></span> <code class="literal">null</code>) the user has been
authenticated in the delegation scenario.</p></td></tr></table></div></div><div class="navfooter"><span class="prev"><a href="configuring-ad-realm.html">
              « 
              Configuring an Active Directory realm</a>
           
        </span><span class="next">
           
          <a href="security-files.html">Security files
               »
            </a></span></div>
                  <!-- end body -->
                </div>
                <div class="col-xs-12 col-sm-4 col-md-4" id="right_col">
                  <div id="rtpcontainer" style="display: block;">
                    <div class="mktg-promo">
                      <h3>Most Popular</h3>
                      <ul class="icons">
                        <li class="icon-elasticsearch-white"><a href="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=default&elektra=docs&storm=top-video">Elasticsearch Service: Free Trial</a></li>
                        <li class="icon-kibana-white"><a href="https://www.elastic.co/webinars/getting-started-kibana?baymax=default&elektra=docs&storm=top-video">Intro to Kibana: Video</a></li>
                        <li class="icon-logstash-white"><a href="https://www.elastic.co/webinars/introduction-elk-stack?baymax=default&elektra=docs&storm=top-video">ELK for Logs & Metrics: Video</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


<div id='elastic-footer'></div>
<script src='https://www.elastic.co/elastic-footer.js'></script>
<!-- Footer Section end-->

      </section>
    </div>

<script type="text/javascript">
	var suggestionsUrl = "https://search.elastic.co/suggest";
	var localeUrl = '{"relative_url_prefix":"/","code":"en-us","display_code":"en-us","url":"/guide_template"}';
</script>
<script src="/static/js/swiftype_app_search.umd.min.js"></script>
<script src="/guide/static/jquery.js"></script>
<script type="text/javascript" src="/guide/static/docs.js"></script>
<script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
