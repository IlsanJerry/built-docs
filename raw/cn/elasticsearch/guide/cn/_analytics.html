<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">分析
        | Elasticsearch: 权威指南
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: 权威指南" /><link rel="up" href="intro.html" title="你知道的, 为了搜索…" /><link rel="prev" href="highlighting-intro.html" title="高亮搜索" /><link rel="next" href="_tutorial_conclusion.html" title="教程结语" /><meta xmlns="" name="description" content="有关如何使用 Elasticsearch、Kibana、Logstash、Beats、X-Pack、Elastic Cloud、Elasticsearch for Apache Hadoop 及我们各种语言的客户端的文档。" /><meta xmlns="" name="DC.type" content="Learn/Docs/Elasticsearch/Definitive Guide" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="cn" /></head><body><div xmlns="" class="page_header"><b>请注意:</b><br/>本书基于 Elasticsearch 2.x 版本，有些内容可能已经过时。
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: 权威指南</a></span> » <span class="breadcrumb-link"><a href="getting-started.html">基础入门</a></span> » <span class="breadcrumb-link"><a href="intro.html">你知道的, 为了搜索…</a></span> » <span class="breadcrumb-node">分析</span></div><div xmlns="" class="navheader"><span class="prev"><a href="highlighting-intro.html">
              « 
              高亮搜索</a>
           
        </span><span class="next">
           
          <a href="_tutorial_conclusion.html">教程结语
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_analytics"></a>分析<a xmlns="" href="https://github.com/elasticsearch-cn/elasticsearch-definitive-guide/edit/cn/010_Intro/35_Tutorial_Aggregations.asciidoc" class="edit_me" title="在 GitHub 上编辑本页" rel="nofollow">编辑</a></h2></div></div></div><p>终于到了最后一个业务需求：支持管理者对员工目录做分析。<a id="id-1.4.3.25.2.1" class="indexterm"></a> Elasticsearch 有一个功能叫聚合（aggregations），<a id="id-1.4.3.25.2.2" class="indexterm"></a>允许我们基于数据生成一些精细的分析结果。聚合与 SQL 中的 <code class="literal">GROUP BY</code> 类似但更强大。</p><p>举个例子，挖掘出员工中最受欢迎的兴趣爱好：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /megacorp/employee/_search
{
  "aggs": {
    "all_interests": {
      "terms": { "field": "interests" }
    }
  }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/010_Intro/35_Aggregations.json"></div><p>暂时忽略掉语法，直接看看结果：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
   ...
   "hits": { ... },
   "aggregations": {
      "all_interests": {
         "buckets": [
            {
               "key":       "music",
               "doc_count": 2
            },
            {
               "key":       "forestry",
               "doc_count": 1
            },
            {
               "key":       "sports",
               "doc_count": 1
            }
         ]
      }
   }
}</pre></div><p>可以看到，两位员工对音乐感兴趣，一位对林业感兴趣，一位对运动感兴趣。这些聚合的结果数据并非预先统计，而是根据匹配当前查询的文档即时生成的。如果想知道叫 Smith 的员工中最受欢迎的兴趣爱好，可以直接构造一个组合查询：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /megacorp/employee/_search
{
  "query": {
    "match": {
      "last_name": "smith"
    }
  },
  "aggs": {
    "all_interests": {
      "terms": {
        "field": "interests"
      }
    }
  }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/010_Intro/35_Aggregations.json"></div><p><code class="literal">all_interests</code> 聚合已经变为只包含匹配查询的文档：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">  ...
  "all_interests": {
     "buckets": [
        {
           "key": "music",
           "doc_count": 2
        },
        {
           "key": "sports",
           "doc_count": 1
        }
     ]
  }</pre></div><p>聚合还支持分级汇总 <a id="id-1.4.3.25.13.1" class="indexterm"></a>
<a id="id-1.4.3.25.13.2" class="indexterm"></a> 。比如，查询特定兴趣爱好员工的平均年龄：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /megacorp/employee/_search
{
    "aggs" : {
        "all_interests" : {
            "terms" : { "field" : "interests" },
            "aggs" : {
                "avg_age" : {
                    "avg" : { "field" : "age" }
                }
            }
        }
    }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/010_Intro/35_Aggregations.json"></div><p>得到的聚合结果有点儿复杂，但理解起来还是很简单的：</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">  ...
  "all_interests": {
     "buckets": [
        {
           "key": "music",
           "doc_count": 2,
           "avg_age": {
              "value": 28.5
           }
        },
        {
           "key": "forestry",
           "doc_count": 1,
           "avg_age": {
              "value": 35
           }
        },
        {
           "key": "sports",
           "doc_count": 1,
           "avg_age": {
              "value": 25
           }
        }
     ]
  }</pre></div><p>输出基本是第一次聚合的加强版。依然有一个兴趣及数量的列表，只不过每个兴趣都有了一个附加的 <code class="literal">avg_age</code> 属性，代表有这个兴趣爱好的所有员工的平均年龄。</p><p>即使现在不太理解这些语法也没有关系，依然很容易了解到复杂聚合及分组通过 Elasticsearch 特性实现得很完美，能够提取的数据类型也没有任何限制。</p></div><div xmlns="" class="navfooter"><span class="prev"><a href="highlighting-intro.html">
              « 
              高亮搜索</a>
           
        </span><span class="next">
           
          <a href="_tutorial_conclusion.html">教程结语
               »
            </a></span></div></body></html>