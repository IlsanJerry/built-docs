<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fleet Server is running and healthy with data, but other Agents cannot use it to connect to Elasticsearch | Fleet and Elastic Agent Guide [8.3] | Elastic</title>
<meta class="elastic" name="content" content="Fleet Server is running and healthy with data, but other Agents cannot use it to connect to Elasticsearch | Fleet and Elastic Agent Guide [8.3]">

<link rel="home" href="index.html" title="Fleet and Elastic Agent Guide [8.3]"/>
<link rel="up" href="fleet-troubleshooting.html" title="Troubleshoot common problems"/>
<link rel="prev" href="fleet-troubleshooting.html" title="Troubleshoot common problems"/>
<link rel="next" href="fleet-faq.html" title="Frequently asked questions"/>
<meta class="elastic" name="product_version" content="8.3"/>
<meta class="elastic" name="product_name" content="Fleet and Elastic Agent"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/Elastic Agent/8.3"/>
<meta name="DC.subject" content="Fleet and Elastic Agent"/>
<meta name="DC.identifier" content="8.3"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Fleet and Elastic Agent Guide [8.3]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="troubleshooting-intro.html">Troubleshoot</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="fleet-troubleshooting.html">Troubleshoot common problems</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="fleet-troubleshooting.html">« Troubleshoot common problems</a>
</span>
<span class="next">
<a href="fleet-faq.html">Frequently asked questions »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="secondary-agent-not-connecting"></a>Fleet Server is running and healthy with data, but other Agents cannot use it to connect to Elasticsearch<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h3>
</div></div></div>
<p>Some settings are only used when you have multiple Elastic Agents.  If this is the case, it may help
to check that the hosts can communicate with the Fleet Server.</p>
<p>From the non-Fleet Server host, run the following command:</p>
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">curl -f http://&lt;fleet-server-ip&gt;:8220/api/status</pre>
</div>
<p>The response may yield errors that you can be debug further, or it may work and show that communication ports and
networking are not the problems.</p>
<p>One common problem is that the default Fleet Server port of <code class="literal">8220</code> isn’t open on the Fleet Server
host to communicate. You can review and correct this using common tools in alignment with any
networking and security concerns you may have.</p>
<h4><a id="es-apikey-failed"></a>Elasticsearch authentication service fails with <code class="literal">Authentication using apikey failed</code> message<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To save API keys and encrypt them in Elasticsearch, Fleet requires an encryption key.</p>
<p>To provide an API key, in the <code class="literal">kibana.yml</code> configuration file, set the <code class="literal">xpack.encryptedSavedObjects.encryptionKey</code> property.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.encryptedSavedObjects.encryptionKey: "something_at_least_32_characters"</pre>
</div>
<h4><a id="process-not-root"></a>Elastic Agent fails with <code class="literal">Agent process is not root/admin or validation failed</code> message<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>Ensure the user running Elastic Agent has root privileges as some integrations
require root privileges to collect sensitive data.</p>
<p>If you&#8217;re running Elastic Agent in the foreground (and not as a service) on Linux or macOS, run the
agent under the root user: <code class="literal">sudo</code> or <code class="literal">su</code>.</p>
<p>If you&#8217;re using the Endpoint and Cloud Security integration, make sure you&#8217;re
running Elastic Agent under the SYSTEM account.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you install Elastic Agent as a service as described in
<a class="xref" href="elastic-agent-installation.html" title="Install Elastic Agents"><em>Install Elastic Agents</em></a>, Elastic Agent runs under the SYSTEM account by
default.</p>
</div>
</div>
<p>To run Elastic Agent under the SYSTEM account, you can do the following:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec" class="ulink" target="_top">PsExec</a>
and extract the contents to a folder. For example, <code class="literal">d:\tools</code>.
</li>
<li class="listitem">
Open a command prompt as an Administrator (right-click the command prompt
icon and select <span class="strong strong"><strong>Run As Administrator</strong></span>).
</li>
<li class="listitem">
<p>From the command prompt, run Elastic Agent under the SYSTEM account:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">d:\tools\psexec.exe -sid "C:\Program Files\Elastic-Agent\elastic-agent.exe" run</pre>
</div>
</li>
</ol>
</div>
<h4><a id="upgrading-integration-too-many-conflicts"></a>Integration policy upgrade has too many conflicts<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>If you try to upgrade an integration policy that is several versions old, there
may be substantial conflicts or configuration issues. Rather than trying to fix
these problems, it might be faster to create a new policy, test it, and roll
out the integration upgrade to additional hosts.</p>
<p>After <a class="xref" href="upgrade-integration.html" title="Upgrade an Elastic Agent integration">upgrading the integration</a>:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="agent-policy.html#create-a-policy" title="Create a policy">Create a new policy</a>.
</li>
<li class="listitem">
<a class="xref" href="agent-policy.html#add-integration" title="Add an integration to a policy">Add the integration to the policy</a>.
The newer version is automatically used.
</li>
<li class="listitem">
<p><a class="xref" href="agent-policy.html#apply-a-policy" title="Apply a policy">Apply the policy</a> to an Elastic Agent.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>In larger deployments, you should test integration upgrades on a sample Elastic Agent
before rolling out a larger upgrade initiative.
Only after a small trial is deemed successful should the updated policy be
rolled out all hosts.</p>
</div>
</div>
</li>
<li class="listitem">
<p>Roll out the integration update to additional hosts:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, click <span class="strong strong"><strong>Agent policies</strong></span>.
Click on the name of the policy you want to edit.
</li>
<li class="listitem">
Search or scroll to a specific integration.
Open the <span class="strong strong"><strong>Actions</strong></span> menu and select <span class="strong strong"><strong>Delete integration</strong></span>.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add integration</strong></span> and re-add the freshly deleted integration.
The updated version will be used and applied to all Elastic Agents.
</li>
<li class="listitem">
<p>Repeat this process for each policy with the out-of-date integration.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In some instances, for example, when there are hundreds or thousands of different Elastic Agents and
policies that need to be updated, this upgrade path is not feasible.
In this case, update one policy and use the <a class="xref" href="agent-policy.html#copy-policy" title="Copy a policy">Copy a policy</a> action to apply the updated policy versions to additional policies.
This method&#8217;s downside is losing
the granularity of assessing the individual Integration version changes individually across policies.</p>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<h4><a id="agent-hangs-while-unenrolling"></a>Elastic Agent hangs while unenrolling<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>When unenrolling Elastic Agent, Fleet waits for acknowledgment from the agent
before it completes the unenroll process. If Fleet doesn&#8217;t receive an
acknowledgment, the status hangs at <code class="literal">unenrolling.</code></p>
<p>You can unenroll an agent to invalidate all API keys related to the agent and change the status to
<code class="literal">inactive</code> so that the agent no longer appears in Fleet.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Fleet, select <span class="strong strong"><strong>Agents</strong></span>.
</li>
<li class="listitem">
Under Agents, choose <span class="strong strong"><strong>Unenroll agent</strong></span> from the <span class="strong strong"><strong>Actions</strong></span> menu next to the
agent you want to unenroll.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Force unenroll</strong></span>.
</li>
</ol>
</div>
<h4><a id="ca-cert-testing"></a>On Fleet Server startup, ERROR seen with <code class="literal">State changed to CRASHED: exited with code: 1</code><a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>You may see this error message for a number of different reasons. A common reason is when attempting production-like usage and the ca.crt file passed in cannot be found.  To verify if this is the problem, bootstrap Fleet Server without passing a ca.crt file. This implies you would test any subsequent
Elastic Agent installs temporarily with {fleet-sever}'s own self-signed cert.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Ensure to pass in the full path to the ca.crt file. A relative path is not viable.</p>
</div>
</div>
<p>You will know if your Fleet Server is set up with its testing oriented self-signed certificate usage,
when you see the following error during Elastic Agent installs:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Error: fail to enroll: fail to execute request to fleet-server: x509: certificate signed by unknown authority
Error: enroll command failed with exit code: 1</pre>
</div>
<p>To install or enroll against a self-signed cert Fleet Server Elastic Agent, add in the <code class="literal">--insecure</code> option to the
command:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">sudo ./elastic-agent install -f --url=https://&lt;fleet-server-ip&gt;:8220 --enrollment-token=&lt;token&gt; --insecure</pre>
</div>
<p>For more information, refer to <a class="xref" href="fleet-troubleshooting.html#agent-enrollment-certs" title="Elastic Agent enrollment fails on the host with x509: certificate signed by unknown authority message">Elastic Agent enrollment fails on the host with <code class="literal">x509: certificate signed by unknown authority</code> message</a>.</p>
<h4><a id="endpoint-not-uninstalled-with-agent"></a>Uninstalling Elastic Endpoint fails<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>When you uninstall Elastic Agent, all the programs managed by Elastic Agent, such as
Elastic Endpoint, are also removed. If uninstalling fails,
Elastic Endpoint might remain on your system.</p>
<p>To remove Elastic Endpoint, run the following commands:</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="Uninstall">
    <button role="tab"
            aria-selected="true"
            aria-controls="mac-tab-uninstall"
            id="mac-uninstall">
      macOS
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="linux-tab-uninstall"
            id="linux-uninstall"
            tabindex="-1">
      Linux
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="win-tab-uninstall"
            id="win-uninstall"
            tabindex="-1">
      Windows
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="mac-tab-uninstall"
       aria-labelledby="mac-uninstall">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd /tmp
cp /Library/Elastic/Endpoint/elastic-endpoint elastic-endpoint
sudo ./elastic-endpoint uninstall
rm elastic-endpoint</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="linux-tab-uninstall"
       aria-labelledby="linux-uninstall"
       hidden="">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd /tmp
cp /opt/Elastic/Endpoint/elastic-endpoint elastic-endpoint
sudo ./elastic-endpoint uninstall
rm elastic-endpoint</pre>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="win-tab-uninstall"
       aria-labelledby="win-uninstall"
       hidden="">
<div class="pre_wrapper lang-shell">
<pre class="programlisting prettyprint lang-shell">cd %TEMP%
copy "c:\Program Files\Elastic\Endpoint\elastic-endpoint.exe" elastic-endpoint.exe
.\elastic-endpoint.exe uninstall
del .\elastic-endpoint.exe</pre>
</div>
  </div>
</div>
<h4><a id="endpoint-unauthorized"></a>API key is unauthorized to send telemetry to <code class="literal">.logs-endpoint.diagnostic.collection-*</code> indices<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>By default, telemetry is turned on in the Elastic Stack to helps us learn about the
features that our users are most interested in. This helps us to focus our efforts on
making features even better.</p>
<p>If you&#8217;ve recently upgraded from version <code class="literal">7.10</code> to <code class="literal">7.11</code>, you might see the
following message when you view Endpoint and Cloud Security logs:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">action [indices:admin/auto_create] is unauthorized for API key id [KbvCi3YB96EBa6C9k2Cm]
of user [fleet_enroll] on indices [.logs-endpoint.diagnostic.collection-default]</pre>
</div>
<p>The above message indicates that Elastic Endpoint does not have the correct
permissions to send telemetry. This is a known problem in 7.11 that will be
fixed in an upcoming patch release.</p>
<p>To remove this message from your logs, you can turn off telemetry for the Endpoint and Cloud Security integration
until the next patch release is available.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
In Kibana, click <span class="strong strong"><strong>Integrations</strong></span>, and then select the <span class="strong strong"><strong>Manage</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Endpoint and Cloud Security</strong></span>, and then select the <span class="strong strong"><strong>Policies</strong></span> tab to view all the
installed integrations.
</li>
<li class="listitem">
Click the integration to edit it.
</li>
<li class="listitem">
Under advanced settings, set <code class="literal">windows.advanced.diagnostic.enabled</code>
to <code class="literal">false</code>, and then save the integration.
</li>
</ol>
</div>
<h4><a id="hosted-agent-offline"></a>Hosted Elastic Agent is offline<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>To scale the Fleet Server deployment, Elastic Cloud starts new containers or shuts down old ones when hosted Elastic Agents are required or no longer needed. The old Elastic Agents will show in the Agents list for 24 hours then automatically disappear.</p>
<h4><a id="hosted-agent-8-x-upgrade-fail"></a>APM &amp; Fleet fails to upgrade to 8.x on Elastic Cloud<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/observability-docs/edit/8.3/docs/en/ingest-management/troubleshooting/troubleshooting.asciidoc">edit</a></h4>
<p>In some scenarios, upgrading APM &amp; Fleet to 8.x may fail if the Elastic Cloud agent policy was modified manually. The Fleet app in Kibana may show a message like:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Unable to create package policy. Package 'apm' already exists on this agent policy</pre>
</div>
<p>To work around this problem, you can reset the Elastic Cloud agent policy with an API call. Note that this will remove any custom integration policies that you&#8217;ve added to the policy, such as Synthetics monitors.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -u elastic:&lt;password&gt; --request POST \
  --url &lt;kibana_url&gt;/internal/fleet/reset_preconfigured_agent_policies/policy-elastic-agent-on-cloud \
  --header 'Content-Type: application/json' \
  --header 'kbn-xsrf: xyz' \</pre>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="fleet-troubleshooting.html">« Troubleshoot common problems</a>
</span>
<span class="next">
<a href="fleet-faq.html">Frequently asked questions »</a>
</span>
</div>
</div>
</body>
</html>
