<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Run Elastic Agent on Kubernetes | Fleet User Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="Fleet User Guide [master]"/>
<link rel="up" href="elastic-agent-installation-configuration.html" title="Elastic Agents"/>
<link rel="prev" href="run-elastic-agent-standalone.html" title="Run Elastic Agent standalone (advanced users)"/>
<link rel="next" href="running-on-kubernetes-standalone.html" title="Run Elastic Agent standalone on Kubernetes"/>
<meta name="DC.type" content="Learn/Docs/Fleet/Guide/master"/>
<meta name="DC.subject" content="Fleet"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Fleet User Guide [master]</a></span>
»
<span class="breadcrumb-link"><a href="elastic-agent-installation-configuration.html">Elastic Agents</a></span>
»
<span class="breadcrumb-node">Run Elastic Agent on Kubernetes</span>
</div>
<div class="navheader">
<span class="prev">
<a href="run-elastic-agent-standalone.html">« Run Elastic Agent standalone (advanced users)</a>
</span>
<span class="next">
<a href="running-on-kubernetes-standalone.html">Run Elastic Agent standalone on Kubernetes »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="running-on-kubernetes"></a>Run Elastic Agent on Kubernetes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/ingest-management/elastic-agent/running-on-kubernetes.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>You can use Elastic Agent <a href="https://www.docker.elastic.co/r/beats/elastic-agent" class="ulink" target="_top">Docker images</a> on Kubernetes to
retrieve cluster metrics.</p>
<h4><a id="_kubernetes_deploy_manifests"></a>Kubernetes deploy manifests<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/ingest-management/elastic-agent/running-on-kubernetes.asciidoc">edit</a></h4>
<p>You deploy Elastic Agent in two different ways at the same time:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
As a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" class="ulink" target="_top">DaemonSet</a>
to ensure that there&#8217;s a running instance on each node of the cluster. These
instances are used to retrieve most metrics from the host, such as system
metrics, Docker stats, and metrics from all the services running on top of
Kubernetes.
</li>
<li class="listitem">
As a single Elastic Agent instance created using a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/Deployment/" class="ulink" target="_top">Deployment</a>.
This instance is used to retrieve metrics that are unique for the whole
cluster, such as Kubernetes events or
<a href="https://github.com/kubernetes/kube-state-metrics" class="ulink" target="_top">kube-state-metrics</a>.
</li>
</ul>
</div>
<p>Everything is deployed under the <code class="literal">kube-system</code> namespace by default. To change
the namespace, modify the manifest file.</p>
<p>To download the manifest file, run:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -L -O https://raw.githubusercontent.com/elastic/beats/master/deploy/kubernetes/elastic-agent-kubernetes.yaml</pre>
</div>
<h4><a id="_settings"></a>Settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/ingest-management/elastic-agent/running-on-kubernetes.asciidoc">edit</a></h4>
<p>By default, Elastic Agent is enrolled to an existing Kibana deployment,
if present using the specified credentials. The <code class="literal">FLEET_ENROLLMENT_TOKEN</code> parameter is used to connect Agent to the
corresponding Elastic Agent policy. It is suggested to connect Daemonset Agents to a node scope configuration
and Deployment Agent to a cluster scope configuration. Then Kubernetes package will be deployed enabling cluster scope
datasets using cluster scope configuration while node scope datasets will be enabled under node scope configuration.</p>
<p>To specify different destination/credentials,
change the following parameters in the manifest file:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">- name: FLEET_ENROLLMENT_TOKEN
  value: "abcdf_token"
- name: KIBANA_HOST
  value: "http://kibana:5601"
- name: KIBANA_USERNAME
  value: "elastic"
- name: KIBANA_PASSWORD
  value: "changeme"</pre>
</div>
<details>
<summary class="title">Configuration details</summary>
<div class="content">
<div class="sidebar">
<div class="titlepage"></div>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">
Settings
</th>
<th align="left" valign="top">
Description
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top">
<p><a id="env-{type}-fleet-enrollment-token"></a><code class="literal">FLEET_ENROLLMENT_TOKEN</code></p>
</td>
<td align="left" valign="top">
<p>(string) The token to use for enrollment.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">""</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top">
<p><a id="env-{type}-kibana-host"></a><code class="literal">KIBANA_HOST</code></p>
</td>
<td align="left" valign="top">
<p>(string) The Kibana host.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">http://kibana:5601</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top">
<p><a id="env-{type}-kibana-username"></a><code class="literal">KIBANA_USERNAME</code></p>
</td>
<td align="left" valign="top">
<p>(string) The basic authentication username used to connect to Kibana.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">elastic</code></p>
</td>
</tr>
<tr>
<td align="left" valign="top">
<p><a id="env-{type}-kibana-password"></a><code class="literal">KIBANA_PASSWORD</code></p>
</td>
<td align="left" valign="top">
<p>(string) The basic authentication password used to connect to Kibana.</p>
<p><span class="strong strong"><strong>Default:</strong></span> <code class="literal">changeme</code></p>
</td>
</tr>
</tbody>
</table>
</div>
<p>See <a class="xref" href="agent-environment-variables.html" title="Elastic Agent environment variables">Environment variables</a> for all available options.</p>
</div>
</div>
</details>
<h5><a id="_run_elastic_agent_on_master_nodes"></a>Run Elastic Agent on master nodes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/ingest-management/elastic-agent/running-on-kubernetes.asciidoc">edit</a></h5>
<p>Kubernetes master nodes can use <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/" class="ulink" target="_top">taints</a>
to limit the workloads that can run on them. To run Elastic Agent on master nodes, you may need to
update the Daemonset spec to include proper tolerations:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">spec:
 tolerations:
 - key: node-role.kubernetes.io/master
   effect: NoSchedule</pre>
</div>
<h4><a id="_deploy"></a>Deploy<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/master/docs/en/ingest-management/elastic-agent/running-on-kubernetes.asciidoc">edit</a></h4>
<p>If planing to deploy <code class="literal">state_*</code> datasets of Kubernetes package,
<a href="https://github.com/kubernetes/kube-state-metrics#usage" class="ulink" target="_top">kube-state-metrics</a> is needed to be already deployed
in the cluster. If <code class="literal">kube-state-metrics</code> is not already running, deploy it now (see the
<a href="https://github.com/kubernetes/kube-state-metrics#kubernetes-deployment" class="ulink" target="_top">Kubernetes
deployment</a> docs).</p>
<p>To deploy to Kubernetes, run:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">kubectl create -f elastic-agent-kubernetes.yaml</pre>
</div>
<p>To check the status, run:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">$ kubectl --namespace=kube-system get pods -l group=ingest-management

NAME                                                    READY   STATUS    RESTARTS   AGE
agent-ingest-management-clusterscope-574dbfc48f-sfrdt   1/1     Running     3        8d
agent-ingest-management-nodescope-jt9zj                 1/1     Running     3        8d</pre>
</div>
<p>Elastic Agents should be enrolled to Fleet and user should be able to deploy Kubernetes package accordingly.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="run-elastic-agent-standalone.html">« Run Elastic Agent standalone (advanced users)</a>
</span>
<span class="next">
<a href="running-on-kubernetes-standalone.html">Run Elastic Agent standalone on Kubernetes »</a>
</span>
</div>
</div>
</body>
</html>
