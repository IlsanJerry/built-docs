<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Troubleshooting anomaly detection | Machine Learning in the Elastic Stack [7.9] | Elastic</title>
<link rel="home" href="index.html" title="Machine Learning in the Elastic Stack [7.9]"/>
<link rel="up" href="xpack-ml.html" title="Anomaly detection"/>
<link rel="prev" href="ml-limitations.html" title="Machine learning anomaly detection limitations"/>
<link rel="next" href="ml-dfanalytics.html" title="Data frame analytics"/>
<meta name="DC.type" content="Learn/Docs/Elastic Stack/Machine learning/7.9"/>
<meta name="DC.subject" content="Machine learning"/>
<meta name="DC.identifier" content="7.9"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
<strong>IMPORTANT</strong>: No additional bug fixes or documentation updates
will be released for this version. For the latest information, see the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Machine Learning in the Elastic Stack [7.9]</a></span>
»
<span class="breadcrumb-link"><a href="xpack-ml.html">Anomaly detection</a></span>
»
<span class="breadcrumb-node">Troubleshooting anomaly detection</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ml-limitations.html">« Machine learning anomaly detection limitations</a>
</span>
<span class="next">
<a href="ml-dfanalytics.html">Data frame analytics »</a>
</span>
</div>
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="ml-troubleshooting"></a>Troubleshooting anomaly detection<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/stack-docs/edit/7.9/docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>Use the information in this section to troubleshoot common problems and known
issues.</p>
<h3><a id="ml-troubleshooting-mappings"></a>Incorrect mappings in 7.9.0 or higher<a class="edit_me edit_me_private" rel="nofollow" title="Editing on GitHub is available to Elastic" href="https://github.com/elastic/stack-docs/edit/7.9/docs/en/stack/ml/anomaly-detection/ml-troubleshooting.asciidoc">edit</a></h3>
<p>This problem occurs when you upgrade to 7.9.0 and incorrect mappings are
added to the machine learning annotations index or the machine learning config index.</p>
<p>It is also possible for this problem to occur for the machine learning config index when
you upgrade to 7.9.1 or higher after previously upgrading to several prior 7.x
versions. If you skip version 7.9.0 and upgrade directly to version 7.9.1 or
higher then the mappings on the machine learning annotations index will be correct.
However, if you upgraded to version 7.9.0 and suffered incorrect mappings then
upgrading to 7.9.1 will not fix these; you will need to follow the procedure
detailed below.</p>
<p><span class="strong strong"><strong>Symptoms:</strong></span></p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Some pages in the Machine Learning UI do not display correctly. For example, the
<span class="strong strong"><strong>Anomaly Explorer</strong></span> fails to load.
</li>
<li class="listitem">
The following error occurs in Kibana when you try to view annotations for
anomaly detection jobs: <code class="literal">Error loading the list of annotations for this job</code>
</li>
<li class="listitem">
Cannot create or update any machine learning jobs. The error messages in this case are
illegal argument exceptions like <code class="literal">mapper [model_plot_config.annotations_enabled]
cannot be changed from type [keyword] to [boolean]</code>. This problem is most likely
to occur if after upgrading you open an existing anomaly detection job in 7.9.0 before
you create or update a job.
</li>
</ul>
</div>
<p><span class="strong strong"><strong>Resolution:</strong></span></p>
<p>To avoid this problem, manually update the mappings on the machine learning annotations and
config indices in your old Elasticsearch version before you upgrade to 7.9.0. For example:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT .ml-annotations-6/_mapping
{
  "properties": {
    "event" : {
      "type" : "keyword"
    },
    "detector_index" : {
      "type" : "integer"
    },
    "partition_field_name" : {
      "type" : "keyword"
    },
    "partition_field_value" : {
      "type" : "keyword"
    },
    "over_field_name" : {
      "type" : "keyword"
    },
    "over_field_value" : {
      "type" : "keyword"
    },
    "by_field_name" : {
      "type" : "keyword"
    },
    "by_field_value" : {
      "type" : "keyword"
    }
  }
}

PUT .ml-config/_mapping
{
  "properties": {
    "analysis_config": {
      "properties": {
        "per_partition_categorization" : {
          "properties" : {
            "enabled" : {
              "type" : "boolean"
            },
            "stop_on_warn" : {
              "type" : "boolean"
            }
          }
        }
      }
    },
    "max_num_threads" : {
      "type" : "integer"
    },
    "model_plot_config" : {
      "properties" : {
        "annotations_enabled" : {
          "type" : "boolean"
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/37.console"></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If security features are enabled, you must have the
<a href="/guide/en/elasticsearch/reference/7.9/built-in-roles.html" class="ulink" target="_top"><code class="literal">superuser</code> role</a> to alter the <code class="literal">.ml-config</code> index.</p>
</div>
</div>
<p>If you did not manually update the mappings before the upgrade, you can
nonetheless try to do it after the upgrade. If either update fails, you must
reindex that index.</p>
<p>For example, to reindex the machine learning annotations index, follow these steps:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console"># 1. Enable upgrade mode
POST _ml/set_upgrade_mode?enabled=true&amp;timeout=10m

# 2. Create a temporary index
PUT temp_ml_annotations

# 3. Reindex the `.ml-annotations-6` index into the temporary index
POST _reindex
{
  "source": { "index": ".ml-annotations-6" },
  "dest": { "index": "temp_ml_annotations" }
}

# 4. Delete the .ml-annotations-6 index
DELETE .ml-annotations-6

# 5. Disable upgrade mode
POST _ml/set_upgrade_mode?enabled=false&amp;timeout=10m

# 6. Wait for .ml-annotations-6 to be recreated

# 7. Reindex the temporary index into the .ml-annotations-6 index
POST _reindex
{
  "source": { "index": "temp_ml_annotations" },
  "dest": { "index": ".ml-annotations-6" }
}

# 8. Delete the temporary index
DELETE temp_ml_annotations</pre>
</div>
<div class="console_widget" data-snippet="snippets/38.console"></div>
<p>To reindex the machine learning config index, follow these steps:</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console"># 1. Enable upgrade mode
POST _ml/set_upgrade_mode?enabled=true&amp;timeout=10m

# 2. Create a temporary index
PUT temp_ml_config

# 3. Reindex the .ml-config index into the temporary index
POST _reindex
{
  "source": { "index": ".ml-config" },
  "dest": { "index": "temp_ml_config" }
}

# 4. Delete the .ml-config index
DELETE .ml-config

# 5. Create the .ml-config index
PUT .ml-config
{
  "settings": { "auto_expand_replicas": "0-1"}
}

# 6. Reindex the temporary index into the .ml-config index
POST _reindex
{
  "source": { "index": "temp_ml_config" },
  "dest": { "index": ".ml-config" }
}

# 7. Disable upgrade mode
POST _ml/set_upgrade_mode?enabled=false&amp;timeout=10m

# 8. Delete the temporary index
DELETE temp_ml_config</pre>
</div>
<div class="console_widget" data-snippet="snippets/39.console"></div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ml-limitations.html">« Machine learning anomaly detection limitations</a>
</span>
<span class="next">
<a href="ml-dfanalytics.html">Data frame analytics »</a>
</span>
</div>
</div>
</body>
</html>
