<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AWS Lambda Extension (Experimental) | APM User Guide [8.1] | Elastic</title>
<link rel="home" href="index.html" title="APM User Guide [8.1]"/>
<link rel="up" href="features.html" title="Elastic APM features"/>
<link rel="prev" href="span-compression.html" title="Span compression"/>
<link rel="next" href="how-to-guides.html" title="How-to guides"/>
<meta name="DC.type" content="Learn/Docs/APM Guide/8.1"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="8.1"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM User Guide [8.1]</a></span>
»
<span class="breadcrumb-link"><a href="features.html">Elastic APM features</a></span>
»
<span class="breadcrumb-node">AWS Lambda Extension (Experimental)</span>
</div>
<div class="navheader">
<span class="prev">
<a href="span-compression.html">« Span compression</a>
</span>
<span class="next">
<a href="how-to-guides.html">How-to guides »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="aws-lambda-extension"></a>AWS Lambda Extension (Experimental)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is in technical preview and may be changed or removed in a future release. Elastic will apply best effort to fix any issues, but features in technical preview are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>Elastic&#8217;s APM Agents instrument AWS Lambda functions and dispatch APM data via an AWS Lambda Extension.</p>
<h4><a id="aws-lambda-arch"></a>Extension Architecture<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h4>
<p>Normally, during the execution of a Lambda function, there&#8217;s only a single language process running in the AWS Lambda execution environment.  However, with an AWS Lambda Extension, Lambda users can run a <em>second</em> process alongside their main service/application process.</p>
<p><span class="image"><img src="images/data-flow.png" alt="image showing data flow from lambda function" width="to extension" height="to APM Server"></span></p>
<p>By using a custom-built AWS Lambda Extension, Elastic APM Agents can send data to a locally running Lambda Extension process, and that process will forward data on to APM Server.  The Lambda Extension ensures that any latency between the Lambda function and the AWS Server instance will not cause latency in the Lambda function/Service itself.</p>
<h4><a id="aws-lambda-instrumenting"></a>Instrumenting a Lambda Function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h4>
<p>The rest of this guide contains instructions for instrumenting a Lambda function. There are two high level steps to instrumenting an AWS Lambda function.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="aws-lambda-extension.html#aws-lambda-configure-layer" title="Configuring the APM Lambda Extension Layer">Configuring the APM Lambda Extension Layer</a>
</li>
<li class="listitem">
<a class="xref" href="aws-lambda-extension.html#aws-lambda-handler" title="Configuring the Agent and Lambda Function handler">Configuring the Agent and Lambda Function handler</a>
</li>
</ol>
</div>
<h5><a id="aws-lambda-configure-layer"></a>Configuring the APM Lambda Extension Layer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h5>
<p>First, you&#8217;ll need to <a href="https://github.com/elastic/apm-aws-lambda/releases" class="ulink" target="_top">pick the right ARN from the extension release table</a> for your AWS Lambda function. The ARN has the pattern <code class="literal">arn:aws:lambda:&lt;AWS_REGION_KEY&gt;:267093732750:layer:elastic-apm-extension-&lt;APM_EXTENSION_VERSION&gt;-&lt;ARCHITECTURE_KEY&gt;:&lt;LAYER_VERSION&gt;</code> and depends on:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The AWS region your Lambda function runs in. The APM Lambda Extension layer needs to be in the same region as your Lambda function.
</li>
<li class="listitem">
The architecture (<em>x86_64</em> or <em>arm64</em>) used for your Lambda function.
</li>
<li class="listitem">
The version of the APM Lambda Extension you would like to use.
</li>
</ul>
</div>
<p>You&#8217;ll then need to configure your function to use that layer. To add a layer</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Navigate to your function in the AWS Console
</li>
<li class="listitem">
Scroll to the Layers section and click the <em>Add a layer</em> button <span class="image"><img src="images/config-layer.png" alt="image of layer configuration section in AWS Console"></span>
</li>
<li class="listitem">
Choose the <em>Specify an ARN</em> radio button
</li>
<li class="listitem">
Enter the Version ARN of the APM Lambda Extension layer in the <em>Specify an ARN</em> text input
</li>
<li class="listitem">
Click the <em>Add</em> button
</li>
</ol>
</div>
<h6><a id="aws-lambda-env-vars"></a>Configure Environment Variables<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h6>
<p>Finally, once the layer&#8217;s in place you&#8217;ll need to configure a few environment variables. To configure variables</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Navigate to your function in the AWS Console
</li>
<li class="listitem">
Click on the <em>Configuration</em> tab
</li>
<li class="listitem">
Click on <em>Environment variables</em>
</li>
<li class="listitem">
Add the necessary variables.
</li>
</ol>
</div>
<p>The following environment variables are relevant for instrumenting a Lambda function:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
(required) <code class="literal">ELASTIC_APM_LAMBDA_APM_SERVER</code>:<br>
This required config option controls where the Lambda extension will ship data. This should be the URL of the final APM Server destination for your telemetry.
</li>
<li class="listitem">
(required) <code class="literal">ELASTIC_APM_SECRET_TOKEN</code> or <code class="literal">ELASTIC_APM_API_KEY</code>:<br>
One of these needs to be set as the authentication method that the extension uses when sending data to the URL configured via <code class="literal">ELASTIC_APM_LAMBDA_APM_SERVER</code>.
</li>
<li class="listitem">
(optional) <code class="literal">ELASTIC_APM_SERVICE_NAME</code>:<br>
The configured name of your application or service.  The APM Agent will use this value when reporting data to APM Server. If unset, the APM Agent will automatically set the value based on the Lambda function name. Use this config option if you want to group multiple Lambda functions under a single service entity in APM.
</li>
<li class="listitem">
(optional) <code class="literal">ELASTIC_APM_DATA_RECEIVER_TIMEOUT_SECONDS</code>:<br>
The timeout value, in seconds, for the Lambda Extension&#8217;s server receiving data from the agent. The <em>default</em> is <code class="literal">15</code>.
</li>
<li class="listitem">
<p>(optional) <code class="literal">ELASTIC_APM_SEND_STRATEGY</code>:<br>
Whether to synchronously flush APM agent data from the extension to the APM server at the end of the function invocation.
The two accepted values are <code class="literal">background</code> and <code class="literal">syncflush</code>. The <em>default</em> is <code class="literal">syncflush</code>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">background</code> strategy indicates that the extension will not flush when it receives a signal that the function invocation
has completed. It will instead send any remaining buffered data on the next function invocation. The result is that, if the
function is not subsequently invoked for that Lambda environment, the buffered data will be lost. However, for lambda functions
that have a steadily frequent load pattern the extension could delay sending the data to the APM server to the next lambda
request and do the sending in parallel to the processing of that next request. This potentially would improve both the lambda
function response time and its throughput.
</li>
<li class="listitem">
The other value, <code class="literal">syncflush</code> will synchronously flush all remaining buffered APM agent data to the APM server when the
extension receives a signal that the function invocation has completed. This strategy blocks the lambda function from receiving
the next request until the extension has flushed all the data. This has a negative effect on the throughput of the function,
though it ensures that all APM data is sent to the APM server.
</li>
</ul>
</div>
</li>
</ul>
</div>
<p>An example configuration of the APM Lambda Extension might look like the following</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">ELASTIC_APM_LAMBDA_APM_SERVER=https://your-apm-server-url:443 # (required) this is your APM Server URL
ELASTIC_APM_SECRET_TOKEN=shhhhhhitsasecret     # (required) this is your APM Server's secret token
ELASTIC_APM_SERVICE_NAME=yourApmServiceName    # (optional) use this to group multiple lambda functions
ELASTIC_APM_DATA_RECEIVER_TIMEOUT_SECONDS=20   # (optional) wait 20s to receive data from the APM agent
ELASTIC_APM_SEND_STRATEGY=background           # (optional) this is the default strategy</pre>
</div>
<p>For a <em>minimal configuration</em> you need to specify the <code class="literal">ELASTIC_APM_LAMBDA_APM_SERVER</code> and the <code class="literal">ELASTIC_APM_SECRET_TOKEN</code> config options.</p>
<h5><a id="aws-lambda-handler"></a>Configuring the Agent and Lambda Function handler<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h5>
<p>After the extension has been installed, install the relevant language agent and wrap the Lambda function handler.</p>
<h6><a id="aws-lambda-nodejs"></a>Node.js<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h6>
<p>To install the Node.js agent in Lambda you&#8217;ll use a second layer.  You&#8217;ll need to <a href="https://github.com/elastic/apm-agent-nodejs/releases" class="ulink" target="_top">pick the right ARN from the agent release table</a>. The ARN has the pattern <code class="literal">arn:aws:lambda:&lt;AWS_REGION_KEY&gt;:267093732750:layer:elastic-apm-node-ver-&lt;APM_EXTENSION_VERSION&gt;:&lt;LAYER_VERSION&gt;</code> and depends on:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The AWS region your Lambda function runs in. The APM Lambda Extension layer needs to be in the same region as your Lambda function.
</li>
<li class="listitem">
The version of the APM Lambda Extension you would like to use.
</li>
</ul>
</div>
<p>You&#8217;ll then need to configure your function to use that layer. To add a layer</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Navigate to your function in the AWS Console
</li>
<li class="listitem">
Scroll to the Layers section and click the <em>Add a layer</em> button <span class="image"><img src="images/config-layer.png" alt="image of layer configuration section in AWS Console"></span>
</li>
<li class="listitem">
Choose the <em>Specify an ARN</em> radio button
</li>
<li class="listitem">
Enter the Version ARN of the APM Lambda Extension layer in the <em>Specify an ARN</em> text input
</li>
<li class="listitem">
Click the <em>Add</em> button
</li>
</ol>
</div>
<p>Finally, to have the Node.js agent automatically wrap your Lambda function handler, add the following environment variable.</p>
<pre class="screen">---
NODE_OPTIONS=-r elastic-apm-node/start
---</pre>
<p>See the <a href="/guide/en/apm/agent/nodejs/current/lambda.html" class="ulink" target="_top">Node.js agent setup guide</a> for detailed instructions on setting up the Node.js agent for AWS Lambda.</p>
<h6><a id="aws-lambda-python"></a>Python<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h6>
<p>In Python, you wrap a Lambda function handler using the following syntax.</p>
<div class="pre_wrapper lang-python">
<pre class="programlisting prettyprint lang-python">from elasticapm import capture_serverless
@capture_serverless()
def handler(event, context):
    return {"statusCode": r.status_code, "body": "Success!"}</pre>
</div>
<p>See the <a href="/guide/en/apm/agent/python/current/lambda-support.html" class="ulink" target="_top">Python agent setup guide</a> for detailed instructions on setting up the Python agent for AWS Lambda.</p>
<h6><a id="aws-lambda-java"></a>Java<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/8.1/docs/monitoring-aws-lambda.asciidoc">edit</a></h6>
<p>Like the extension, the Elastic APM Java agent is installed as a Lambda layer.</p>
<p>See the <a href="/guide/en/apm/agent/java/current/aws-lambda.html" class="ulink" target="_top">Java agent setup guide</a> for detailed instructions on setting up the Java agent for AWS Lambda.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="span-compression.html">« Span compression</a>
</span>
<span class="next">
<a href="how-to-guides.html">How-to guides »</a>
</span>
</div>
</div>
</body>
</html>
