<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Get started with Lambda | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="setup.html" title="Set up the Agent"/>
<link rel="prev" href="ssl-configuration.html" title="SSL/TLS communication with APM Server"/>
<link rel="next" href="supported-technologies-details.html" title="Supported technologies"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
»
<span class="breadcrumb-link"><a href="setup.html">Set up the Agent</a></span>
»
<span class="breadcrumb-node">Get started with Lambda</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ssl-configuration.html">« SSL/TLS communication with APM Server</a>
</span>
<span class="next">
<a href="supported-technologies-details.html">Supported technologies »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="aws-lambda"></a>Get started with Lambda<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h2>
</div></div></div>
<p>Getting Elastic APM set up for your lambda functions is easy,
and there are various ways you can tweak it to fit your needs.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In order to get the full AWS Lambda tracing capabilities, use with APM Server 7.16 or higher. Using
older versions provides most value, but some relevant metadata fields will not be indexed.</p>
</div>
</div>
<h4><a id="aws-lambda-runtimes"></a>Supported runtimes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>AWS Lambda provides multiple <a href="https://docs.aws.amazon.com/lambda/latest/dg/java-image.html" class="ulink" target="_top">JVM base images</a>, only the ones that support the <code class="literal">AWS_LAMBDA_EXEC_WRAPPER</code> environment variables
are supported out of the box.</p>
<p>Running with unsupported images is still possible but requires providing agent configuration through environment variables
explicitly.</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
<col class="col_4"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Tags</th>
<th align="left" valign="top">Java Runtime</th>
<th align="left" valign="top">Operating System</th>
<th align="left" valign="top">Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>11</p></td>
<td align="left" valign="top"><p>Java 11 (Corretto)</p></td>
<td align="left" valign="top"><p>Amazon Linux 2</p></td>
<td align="left" valign="top"><p>yes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>8.al2</p></td>
<td align="left" valign="top"><p>Java 8 (Corretto)</p></td>
<td align="left" valign="top"><p>Amazon Linux 2</p></td>
<td align="left" valign="top"><p>yes</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>8</p></td>
<td align="left" valign="top"><p>Java 8 (OpenJDK)</p></td>
<td align="left" valign="top"><p>Amazon Linux 2018.03</p></td>
<td align="left" valign="top"><p>no</p></td>
</tr>
</tbody>
</table>
</div>
<h4><a id="aws-lambda-installation"></a>Installation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Setting up APM for your Java Lambda function is a two-step process. Make sure to follow <em>both</em> of the following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="aws-lambda.html#aws-lambda-extension" title="Install the Elastic APM Lambda extension">Install the Elastic APM Lambda extension</a>
</li>
<li class="listitem">
<a class="xref" href="aws-lambda.html#aws-lambda-instrumenting" title="Install the Elastic APM Java Agent Layer">Install the Elastic APM Java Agent Layer</a>
</li>
</ol>
</div>
<h4><a id="aws-lambda-extension"></a>Install the Elastic APM Lambda extension<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Elastic uses a Lambda extension to forward data to an APM Server in a way that does not interfere with the execution of your Lambda function.</p>
<p>Follow the <a href="/guide/en/apm/guide/current/aws-lambda-extension.html" class="ulink" target="_top">installation documentation for the extension</a> to setup the Elastic APM Lambda extension for your Lambda function.</p>
<h4><a id="aws-lambda-instrumenting"></a>Install the Elastic APM Java Agent Layer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>The Java Agent is installed as an AWS Layer.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Pick the right ARN from the <a href="https://github.com/elastic/apm-agent-java/releases" class="ulink" target="_top">ARN table for the APM Java Agent Lambda Layer</a>. Note: The APM Java Agent Layer needs to be in the <em>same region</em> as your Lambda function.
</li>
<li class="listitem">
Navigate to your function in the AWS Console
</li>
<li class="listitem">
Scroll to the Layers section and click the <em>Add a layer</em> button
</li>
<li class="listitem">
Choose the <em>Specify an ARN</em> radio button
</li>
<li class="listitem">
Enter the Version ARN of the APM Java Agent Layer in the <em>Specify an ARN</em> text input
</li>
<li class="listitem">
Click the <em>Add</em> button
</li>
</ol>
</div>
<p>Once the APM Java Agent Layer is in place, you&#8217;ll need to configure some environment variables <em>in addition</em> to the environment variables you already configured for the APM Lambda extension.
Configure the following environment variables for the APM Java Agent Layer:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
(required) <code class="literal">AWS_LAMBDA_EXEC_WRAPPER</code>: set this variable&#8217;s value to <code class="literal">/opt/elastic-apm-handler</code>, so that Lambda starts the runtime with an attached APM Java agent.
</li>
<li class="listitem">
(recommended) <a class="xref" href="config-stacktrace.html#config-application-packages" title="application_packages"><code class="literal">ELASTIC_APM_APPLICATION_PACKAGES</code></a>: setting this may improve cold start times.
</li>
<li class="listitem">
(optional) Fine-tune the Java agent with any of the available <a class="xref" href="configuration.html" title="Configuration">configuration options</a>.
</li>
</ol>
</div>
<p>That&#8217;s it, if you&#8217;ve done all of the above you are set to go!
Your Lambda function invocations should be traced from now on.</p>
<h4><a id="aws-lambda-performance-monitoring"></a>Performance monitoring<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Elastic APM automatically measures the performance of your lambda function executions.
It records traces for database queries, external HTTP requests,
and other slow operations that happen during execution.</p>
<p>By default, the agent will trace <a class="xref" href="setup.html#supported-technologies" title="Supported technologies">the usual supported technologies</a>.
To trace other events, take a look at <a class="xref" href="java-method-monitoring.html" title="How to find slow methods">additional method tracing options</a>, however note that
due to its asynchronous nature, the <a class="xref" href="method-sampling-based.html" title="Sampling-based profiler">Sampling Profiler</a> is not a valid option for AWS Lambda.</p>
<h4><a id="aws-lambda-error-monitoring"></a>Error monitoring<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Whenever an <code class="literal">Exception</code> is thrown by your function handler method, the agent will send an error event to the APM Server
and the corresponding transaction will be recorded as a failed transaction.
Errors related to traced spans will be sent as well.</p>
<h4><a id="aws-lambda-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
System and custom metrics are not collected for Lambda functions. This is both because most of those are irrelevant
and because the interval-based event sending model is not suitable for FaaS environments.
</li>
<li class="listitem">
<p>Cold starts can be significantly slower when the agent is installed. If this is an issue, following are ways to deal with slow code
starts:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
If the only issue with slower cold starts is Lambda timing out, consider increasing the configured timeout.
</li>
<li class="listitem">
The higher memory limit you would allow for your Function, the smaller this effect would be. This is irrelevant for
subsequent Function invocations, it is only relevant for cold starts.
</li>
<li class="listitem">
Much of the startup delay is related to the amount of enabled instrumentations. An enabled instrumentation will contribute to this
overhead regardless of it being applicable for your specific Lambda function. You can considerably reduce the related overhead by
specifying a limited list of enabled instrumentations through the <a class="xref" href="config-core.html#config-enable-instrumentations" title="enable_instrumentations ()"><code class="literal">enable_instrumentations</code></a> config.
An automatic way to generate such list is by invoking your Lambda with the agent&#8217;s default configurations and a <a class="xref" href="config-logging.html#config-log-level" title="log_level"><code class="literal">log_level</code></a> of <code class="literal">INFO</code> or lower. After the first lambda invocation, the agent would log a message with the following format: <code class="literal">Used
instrumentation groups: [aws-lambda, executor, executor-collection, fork-join, ssl-context, urlconnection]</code>.
</li>
</ul>
</div>
</li>
<li class="listitem">
The <a class="xref" href="method-sampling-based.html" title="Sampling-based profiler">Sampling Profiler</a> feature would not work because it relies on profiling sessions and
subsequent asynchronous processing of the collected data.
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ssl-configuration.html">« SSL/TLS communication with APM Server</a>
</span>
<span class="next">
<a href="supported-technologies-details.html">Supported technologies »</a>
</span>
</div>
</div>
</body>
</html>
