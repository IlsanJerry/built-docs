<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Log correlation | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="prev" href="metrics.html" title="Metrics"/>
<link rel="next" href="java-method-monitoring.html" title="How to find slow methods"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="java-method-monitoring.html">How to find slow methods »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="log-correlation"></a>Log correlation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/log-correlation.asciidoc">edit</a></h1>
</div></div></div>
<p><a href="/guide/en/apm/guide/8.5/log-correlation.html" class="ulink" target="_top">Log correlation</a> allows you to navigate to all logs belonging to a particular trace
and vice-versa: for a specific log, see in which context it has been logged and which parameters the user provided.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Starting in APM agent version 1.30.0, log correlation is enabled by default.
In previous versions, log correlation must be explicitly enabled by setting
the <code class="literal">enable_log_correlation</code> configuration variable to <code class="literal">true</code>.</p>
</div>
</div>
<p>Here are the 3 main steps required to implement log correlation with a Java application.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="log-correlation.html#log-correlation-extract-ids" title="Step 1: Inject ID fields in logs">Step 1: Inject ID fields in logs</a>
</li>
<li class="listitem">
<a class="xref" href="log-correlation.html#log-correlation-reformat" title="Step 2: Reformat plain text logs">Step 2: Reformat plain text logs</a> (optional)
</li>
<li class="listitem">
<a class="xref" href="log-correlation.html#log-correlation-ingest" title="Step 3: Ingest your application logs into Elasticsearch">Step 3: Ingest your application logs into Elasticsearch</a>
</li>
</ul>
</div>
<h3><a id="log-correlation-extract-ids"></a>Step 1: Inject ID fields in logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/log-correlation.asciidoc">edit</a></h3>
<p>In order to correlate logs from your application with transactions captured by the Elastic APM Java Agent,
the agent injects the following IDs into <a href="https://www.slf4j.org/api/org/slf4j/MDC.html" class="ulink" target="_top">slf4j-MDC</a>-equivalents of
<a class="xref" href="supported-technologies-details.html#supported-logging-frameworks" title="Logging frameworks">supported logging frameworks</a>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/ecs/8.5/ecs-tracing.html" class="ulink" target="_top"><code class="literal">transaction.id</code></a>
</li>
<li class="listitem">
<a href="/guide/en/ecs/8.5/ecs-tracing.html" class="ulink" target="_top"><code class="literal">trace.id</code></a>
</li>
<li class="listitem">
<a href="/guide/en/ecs/8.5/ecs-error.html" class="ulink" target="_top"><code class="literal">error.id</code></a>
</li>
</ul>
</div>
<p>For plain text logs, the pattern layout of your logging configuration needs to be modified to write the MDC values into
log files. If you are using Logback or log4j, add <code class="literal">%X</code> to the format to log all MDC values or <code class="literal">%X{trace.id}</code> to only log the trace id.</p>
<p>If your application is already using <a href="https://github.com/elastic/java-ecs-logging" class="ulink" target="_top">Java ECS logging</a> or the
<a class="xref" href="config-logging.html#config-log-ecs-reformatting" title="log_ecs_reformatting ( experimental)"><code class="literal">log_ecs_reformatting</code></a> configuration option to write ECS formatted
logs, then there is no change required as the IDs will be automatically added to the ECS-formatted log lines. In this
case You can then skip directly to <a class="xref" href="log-correlation.html#log-correlation-ingest" title="Step 3: Ingest your application logs into Elasticsearch">step 3</a>.</p>
<h3><a id="log-correlation-reformat"></a>Step 2: Reformat plain text logs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/log-correlation.asciidoc">edit</a></h3>
<p>This step is optional, but strongly recommended as reformatting makes Elasticsearch ingestion simpler if they are
in ECS JSON format.</p>
<p>If you are using <a href="https://github.com/elastic/java-ecs-logging" class="ulink" target="_top">Java ECS logging</a>, there&#8217;s nothing to do in this step as
the application logs will already be formatted in ECS format.</p>
<p>The easiest way to reformat application logs is to use the experimental <a class="xref" href="config-logging.html#config-log-ecs-reformatting" title="log_ecs_reformatting ( experimental)"><code class="literal">log_ecs_reformatting</code></a>
configuration option as it will allow to reformat logs without modifying the application nor its configuration.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>the <a class="xref" href="config-logging.html#config-log-ecs-reformatting" title="log_ecs_reformatting ( experimental)"><code class="literal">log_ecs_reformatting</code></a> configuration is still experimental and may change
in the future. However, since it is effortless, it may be your first choice to try out.</p>
</div>
</div>
<p>By default, application logs are written in plain-text format, thus they have to be parsed prior storage in
Elasticsearch, this transformation is usually implemented through an <a href="/guide/en/elasticsearch/reference/8.5/ingest.html" class="ulink" target="_top">ingest pipeline</a> and a
<a href="/guide/en/elasticsearch/reference/8.5/grok-processor.html" class="ulink" target="_top">grok processor</a> or with a combination of Filebeat and Logstash configuration.</p>
<p>With plain-text log files, this parsing will have to extract the IDs added in <a class="xref" href="log-correlation.html#log-correlation-extract-ids" title="Step 1: Inject ID fields in logs">step 1</a> from
the plain-text log file and store them to their respective fields: <a href="/guide/en/ecs/8.5/ecs-tracing.html" class="ulink" target="_top"><code class="literal">transaction.id</code></a>, <a href="/guide/en/ecs/8.5/ecs-tracing.html" class="ulink" target="_top"><code class="literal">trace.id</code></a>
and <a href="/guide/en/ecs/8.5/ecs-error.html" class="ulink" target="_top"><code class="literal">error.id</code></a>.</p>
<h3><a id="log-correlation-ingest"></a>Step 3: Ingest your application logs into Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/log-correlation.asciidoc">edit</a></h3>
<p>Ingestion of log files into Elasticsearch is the last step and is common to all platforms, thus the
<a href="/guide/en/apm/guide/8.5/log-correlation.html#_ingest_your_logs_into_elasticsearch" class="ulink" target="_top">general guide</a> should be followed for instructions.</p>
<p>The Filebeat configuration will differ depending on the log file format:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
for ECS-formatted log files, the <span class="strong strong"><strong>JSON logs</strong></span> configuration should be used
</li>
<li class="listitem">
for plain-text log files, the <span class="strong strong"><strong>Parsing unstructured logs</strong></span> configuration should be used.
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="metrics.html">« Metrics</a>
</span>
<span class="next">
<a href="java-method-monitoring.html">How to find slow methods »</a>
</span>
</div>
</div>
</body>
</html>
