<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Automatic setup with apm-agent-attach-standalone.jar | APM Java Agent Reference [1.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [1.x]"/>
<link rel="up" href="setup.html" title="Set up the Agent"/>
<link rel="prev" href="setup-javaagent.html" title="Manual setup with -javaagent flag"/>
<link rel="next" href="setup-attach-api.html" title="Programmatic API setup to self-attach"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/1.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="1.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [1.x]</a></span>
»
<span class="breadcrumb-link"><a href="setup.html">Set up the Agent</a></span>
»
<span class="breadcrumb-node">Automatic setup with <code class="literal">apm-agent-attach-standalone.jar</code></span>
</div>
<div class="navheader">
<span class="prev">
<a href="setup-javaagent.html">« Manual setup with <code class="literal">-javaagent</code> flag</a>
</span>
<span class="next">
<a href="setup-attach-api.html">Programmatic API setup to self-attach »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="setup-attach-cli"></a>Automatic setup with <code class="literal">apm-agent-attach-standalone.jar</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h2>
</div></div></div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This installation method is in beta.</p>
</div>
</div>
<p>The <code class="literal">apm-agent-attach-standalone.jar</code> is a small Java program which attaches the Elastic APM Java agent to a specific JVM or to all JVMs of the same host it runs on.</p>
<p>This installation method does not require you to alter the configuration of your application server and can be used to conveniently instrument all JVMs on a particular host.</p>
<h4><a id="setup-attach-cli-supported-environments"></a>Supported environments<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<p>The attachment is supported on Windows,
Unix and Solaris operating systems on HotSpot-based JVMs (like OpenJDK and Oracle JDK) and OpenJ9.</p>
<p>Some flags, like <code class="literal">--include</code> and <code class="literal">--exclude</code> require the <code class="literal">jps</code> command to be installed,
which is part of the JDK distribution and does not typically come with the JRE distribution.</p>
<h4><a id="setup-attach-cli-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<p>The OS user executing <code class="literal">apm-agent-attach-standalone.jar</code> and the OS user of the application(s) to be monitored (the JVMs to attach to) has to be the same.</p>
<p>When attaching to a J9 VM, you have to explicitly set the <code class="literal">--pid &lt;pid&gt;</code> argument, or have <code class="literal">jps</code> installed.</p>
<p>The approach to mitigate <code class="literal">NoClassDefFoundError</code> s when used in OSGi containers (which includes most application servers) is experimental.
Versions prior to 1.18.0 don&#8217;t support OSGi containers.</p>
<h4><a id="setup-attach-cli-download"></a>Download<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<p>You can download the attach program from maven central:
<a href="https://search.maven.org/search?q=g:co.elastic.apm%20AND%20a:apm-agent-attach" class="ulink" target="_top">maven central</a></p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>As of version 1.9.0, you will have to download the <code class="literal">standalone</code> jar instead of the normal jar distribution.</p>
</div>
</div>
<h4><a id="setup-attach-cli-usage"></a>Usage<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<h5><a id="setup-attach-cli-usage-pid"></a>Attach to a JVM with a specific PID<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h5>
<p>Attaches the agent to a JVM with a specific process ID.
Optionally, you can pass in arguments to configure the agent.
See <a class="xref" href="setup-attach-cli.html#setup-attach-cli-usage-options" title="Options">Options</a> for the format of the agent arguments.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid &lt;pid&gt; [--config &lt;agent_config&gt;...]</pre>
</div>
<p>Example: The following command attaches the agent to the JVM with the PID 42 and exits.
Additionally, it applies some <a class="xref" href="configuration.html" title="Configuration">configuration options</a>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid 42 \
    --config service_name=my-cool-service server_urls=http://localhost:8200</pre>
</div>
<h5><a id="setup-attach-cli-usage-filtered"></a>Attach to a filtered set of JVMs on a certain host<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h5>
<p>Attaches the agent to all matching JVMs on the host which confirm to the optional include and exclude filters.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar [--include &lt;include_pattern&gt;...]
       [--exclude &lt;exclude_pattern&gt;...] [--continuous]
       [--config &lt;agent_config&gt;... | --args-provider &lt;args_provider_script&gt;]</pre>
</div>
<p>Example: The following command attaches the agent to all JVMs whose main class contains <code class="literal">MyApplication</code> or which are started from a jar file named <code class="literal">my-application.jar</code>.
It also makes the attacher run continuously so that it attaches the agent on starting JVMs which match the include pattern.
Additionally, it applies some <a class="xref" href="configuration.html" title="Configuration">configuration options</a>.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar \
    --include '.*MyApplication.*' '.*/my-application.jar.*' \
    --continuous \
    --config service_name=my-cool-service \
    --config server_urls=http://localhost:8200</pre>
</div>
<h5><a id="setup-attach-cli-usage-list"></a>List running JVMs<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h5>
<p>Lists all currently running JVMs, including their PID and their main class name or the path to their jar file.</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --list</pre>
</div>
<h5><a id="setup-attach-cli-usage-options"></a>Options<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h5>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong>-l, --list</strong></span>
</span>
</dt>
<dd>
<p>Lists all running JVMs. Same output as <code class="literal">jps -lv</code>.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-p, --pid &lt;pid&gt;</strong></span>
</span>
</dt>
<dd>
<p>PID of the JVM to attach. If not provided, attaches to all currently running JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--continuous</code>, <code class="literal">--exclude</code>, <code class="literal">--include</code> and <code class="literal">--args-provider</code></p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-c, --continuous</strong></span>
</span>
</dt>
<dd>
<p>If provided, this program continuously runs and attaches to all running and starting JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--pid</code></p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-e, --exclude &lt;exclude_pattern&gt;&#8230;&#8203;</strong></span>
</span>
</dt>
<dd>
<p>A list of regular expressions of fully qualified main class names or paths to JARs of applications or any JVM system property of the java process the java agent should not be attached to.
(Matches the output of <code class="literal">jps -lv</code>)</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-i, --include &lt;include_pattern&gt;&#8230;&#8203;</strong></span>
</span>
</dt>
<dd>
<p>A list of regular expressions of fully qualified main class names or paths to JARs of applications or any JVM system property of the java process the java agent should be attached to.
(Matches the output of <code class="literal">jps -lv</code>)</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-a, --args &lt;agent_arguments&gt;</strong></span>
</span>
</dt>
<dd>
<p>Deprecated in favor of --config.</p>
<p>If set, the arguments are used to configure the agent on the attached JVM (agentArguments of agentmain).</p>
<p>The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--args-provider</code></p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-C --config &lt;key=value&gt;&#8230;&#8203;</strong></span>
</span>
</dt>
<dd>
<p>This repeatable option sets one agent configuration option.</p>
<p>Example: <code class="literal">--config server_urls=http://localhost:8200,http://localhost:8201</code></p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-A, --args-provider &lt;args_provider_script&gt;</strong></span>
</span>
</dt>
<dd>
<p>The name of a program which is called when a new JVM starts up.
The program gets the pid and the main class name or path to the JAR file as an argument
and returns an arg string which is used to configure the agent on the attached JVM (agentArguments of agentmain).
When returning a non-zero status code from this program, the agent will not be attached to the starting JVM.</p>
<p>The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This option cannot be used in conjunction with <code class="literal">--pid</code> and <code class="literal">--config</code></p>
</div>
</div>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong>-w, --without-emulated-attach</strong></span>
</span>
</dt>
<dd>
<p>Disables using emulated attach feature provided by Byte Buddy, this should be used as a workaround on some JDK/JREs
when runtime attachment fails.</p>
</dd>
</dl>
</div>
<h4><a id="setup-attach-cli-docker"></a>Docker<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<p>Use this script to automatically attach to all docker containers running on a host.
This script does not return but continuously listens for starting containers which it also attaches to.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This script is experimental and might not work with all containers.
Especially the <code class="literal">jq --raw-output .[0].Config.Cmd[0]) == java</code> might vary.</p>
</div>
</div>
<p><strong>attach.sh.</strong></p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">#!/usr/bin/env bash
set -ex

attach () {
    # only attempt attachment if this looks like a java container
    if [[ $(docker inspect ${container_id} | jq --raw-output .[0].Config.Cmd[0]) == java ]]
    then
        echo attaching to $(docker ps --no-trunc | grep ${container_id})
        docker cp ./apm-agent-attach-*-standalone.jar ${container_id}:/apm-agent-attach-standalone.jar
        docker exec ${container_id} java -jar /apm-agent-attach-standalone.jar --config
    fi
}

# attach to running containers
for container_id in $(docker ps --quiet --no-trunc) ; do
    attach
done

# listen for starting containers and attach to those
docker events --filter 'event=start' --format '{{.ID}}' |
while IFS= read -r container_id
do
    attach
done</pre>
</div>
<h4><a id="setup-attach-cli-troubleshooting"></a>Troubleshooting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/1.x/docs/setup-attach-cli.asciidoc">edit</a></h4>
<p>If you get a message like <code class="literal">no main manifest attribute, in apm-agent-attach.jar</code>,
you are using the wrong artifact.
Use the one which ends in <code class="literal">-standalone.jar</code>.</p>
</div>
<div class="navfooter">
<span class="prev">
<a href="setup-javaagent.html">« Manual setup with <code class="literal">-javaagent</code> flag</a>
</span>
<span class="next">
<a href="setup-attach-api.html">Programmatic API setup to self-attach »</a>
</span>
</div>
</div>
</body>
</html>
