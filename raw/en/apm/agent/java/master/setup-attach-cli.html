<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Automatic setup with apm-agent-attach-standalone.jar
        | APM Java Agent Reference [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="APM Java Agent Reference [master]" /><link rel="up" href="setup.html" title="Set up" /><link rel="prev" href="setup-javaagent.html" title="Manual setup with -javaagent flag" /><link rel="next" href="setup-attach-api.html" title="Programmatic API setup to self-attach" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/APM Java Agent/Reference/master" /><meta xmlns="" name="DC.subject" content="APM" /><meta xmlns="" name="DC.identifier" content="master" /></head><body><div xmlns="" class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="setup.html">Set up</a></span> » <span class="breadcrumb-node">Automatic setup with <code xmlns="http://www.w3.org/1999/xhtml" class="literal">apm-agent-attach-standalone.jar</code></span></div><div xmlns="" class="navheader"><span class="prev"><a href="setup-javaagent.html">
              « 
              Manual setup with <code xmlns="http://www.w3.org/1999/xhtml" class="literal">-javaagent</code> flag</a>
           
        </span><span class="next">
           
          <a href="setup-attach-api.html">Programmatic API setup to self-attach
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="setup-attach-cli"></a>Automatic setup with <code class="literal">apm-agent-attach-standalone.jar</code><a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This installation method is experimental.</p></div></div><p>You can use the attacher as a standalone application on the command line or include it in your application to programmatically attach to the current JVM.</p><p>This installation method does not require you to alter the configuration of your application server and can be used to conveniently instrument all JVMs on a particular host.</p><p>The <code class="literal">apm-agent-attach-standalone.jar</code> is a small Java program which attaches the Elastic APM Java agent to a specific JVM or to all JVMs of the same host it runs on.</p><h4><a id="setup-attach-cli-supported-environments"></a>Supported environments<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The attachment is supported on Windows,
Unix and Solaris operating systems on HotSpot-based JVMs (like OpenJDK and Oracle JDK) and OpenJ9.</p><p>Some flags, like <code class="literal">--include</code> and <code class="literal">--exclude</code> require the <code class="literal">jps</code> command to be installed,
which is part of the JDK distribution and does not typically come with the JRE distribution.</p><h4><a id="setup-attach-cli-caveats"></a>Caveats<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The OS user executing <code class="literal">apm-agent-attach-standalone.jar</code> and the OS user of the application(s) to be monitored (the JVMs to attach to) has to be the same.</p><p>When attaching to a J9 VM, you have to explicitly set the <code class="literal">--pid &lt;pid&gt;</code> argument, or have <code class="literal">jps</code> installed.</p><p>Currently, this does not work in combination with OSGi containers (which includes most application servers).
The symptom is that there will be a lot of exceptions like this: <code class="literal">java.lang.NoClassDefFoundError: co/elastic/apm/agent/servlet/ServletApiAdvice</code>.</p><h4><a id="setup-attach-cli-download"></a>Download<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>You can download the attach program from maven central:
<a class="ulink" href="https://search.maven.org/search?q=g:co.elastic.apm%20AND%20a:apm-agent-attach" target="_top">maven central</a></p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">As of version 1.9.0, you will have to download the <code class="literal">standalone</code> jar instead of the normal jar distribution.</p></div></div><h4><a id="setup-attach-cli-usage"></a>Usage<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><h5><a id="setup-attach-cli-usage-pid"></a>Attach to a JVM with a specific PID<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Attaches the agent to a JVM with a specific process ID.
Optionally, you can pass in arguments to configure the agent.
See <a class="xref" href="setup-attach-cli.html#setup-attach-cli-usage-options" title="Options">Options</a> for the format of the agent arguments.</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid &lt;pid&gt; [--args &lt;agent_arguments&gt;]</pre></div><p>Example: The following command attaches the agent to the JVM with the PID 42 and exits.
Additionally, it applies some <a class="link" href="configuration.html" title="Configuration">configuration options</a>.</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --pid 42 \
    --args 'service_name=my-cool-service;server_urls=http://localhost:8200'</pre></div><h5><a id="setup-attach-cli-usage-filtered"></a>Attach to a filtered set of JVMs on a certain host<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Attaches the agent to all matching JVMs on the host which confirm to the optional include and exclude filters.</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar [-include &lt;include_pattern&gt;...]
       [-exclude &lt;exclude_pattern&gt;...] [--continuous]
       [--args &lt;agent_arguments&gt; | --args-provider &lt;args_provider_script&gt;]</pre></div><p>Example: The following command attaches the agent to all JVMs whose main class contains <code class="literal">MyApplication</code> or which are started from a jar file named <code class="literal">my-application.jar</code>.
It also makes the attacher run continuously so that it attaches the agent on starting JVMs which match the include pattern.
Additionally, it applies some <a class="link" href="configuration.html" title="Configuration">configuration options</a>.</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar \
    --include '.*MyApplication.*' '.*/my-application.jar' \
    --continuous \
    --args 'service_name=my-cool-service;server_urls=http://localhost:8200'</pre></div><h5><a id="setup-attach-cli-usage-list"></a>List running JVMs<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><p>Lists all currently running JVMs, including their PID and their main class name or the path to their jar file.</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">java -jar apm-agent-attach-standalone.jar --list</pre></div><h5><a id="setup-attach-cli-usage-options"></a>Options<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h5><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="strong strong"><strong>-l, --list</strong></span></span></dt><dd>Lists all running JVMs. Same output as <code class="literal">jps -l</code>.</dd><dt><span class="term"><span class="strong strong"><strong>-p, --pid &lt;pid&gt;</strong></span></span></dt><dd><p class="simpara">PID of the JVM to attach. If not provided, attaches to all currently running JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--continuous</code>, <code class="literal">--exclude</code>, <code class="literal">--include</code> and <code class="literal">--args-provider</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-c, --continuous</strong></span></span></dt><dd><p class="simpara">If provided, this program continuously runs and attaches to all running and starting JVMs which match the <code class="literal">--exclude</code> and <code class="literal">--include</code> filters.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--pid</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-e, --exclude &lt;exclude_pattern&gt;…​</strong></span></span></dt><dd><p class="simpara">A list of regular expressions of fully qualified main class names or paths to JARs of applications the java agent should not be attached to.
(Matches the output of <code class="literal">jps -l</code>)</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-i, --include &lt;include_pattern&gt;…​</strong></span></span></dt><dd><p class="simpara">A list of regular expressions of fully qualified main class names or paths to JARs of applications the java agent should be attached to.
(Matches the output of <code class="literal">jps -l</code>)</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--pid</code> and requires the <code class="literal">jps</code> command to be installed</p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-a, --args &lt;agent_arguments&gt;</strong></span></span></dt><dd><p class="simpara">If set, the arguments are used to configure the agent on the attached JVM (agentArguments of agentmain).</p><p class="simpara">The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--args-provider</code></p></div></div></dd><dt><span class="term"><span class="strong strong"><strong>-C --config &lt;key=value&gt;…​</strong></span></span></dt><dd><p class="simpara">This repeatable option sets one agent configuration option.</p><p class="simpara">Example: <code class="literal">--config server_urls=http://localhost:8200,http://localhost:8201</code></p></dd><dt><span class="term"><span class="strong strong"><strong>-A, --args-provider &lt;args_provider_script&gt;</strong></span></span></dt><dd><p class="simpara">The name of a program which is called when a new JVM starts up.
The program gets the pid and the main class name or path to the JAR file as an argument
and returns an arg string which is used to configure the agent on the attached JVM (agentArguments of agentmain).
When returning a non-zero status code from this program, the agent will not be attached to the starting JVM.</p><p class="simpara">The syntax of the arguments is <code class="literal">key1=value1;key2=value1,value2</code>.
See <a class="xref" href="configuration.html" title="Configuration"><em>Configuration</em></a> for all available configuration options.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This option cannot be used in conjunction with <code class="literal">--pid</code> and <code class="literal">--args</code></p></div></div></dd></dl></div><h4><a id="setup-attach-cli-docker"></a>Docker<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Use this script to automatically attach to all docker containers running on a host.
This script does not return but continuously listens for starting containers which it also attaches to.</p><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">This script is experimental and might not work with all containers.
Especially the <code class="literal">jq --raw-output .[0].Config.Cmd[0]) == java</code> might vary.</p></div></div><p><strong>attach.sh. </strong>
</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">#!/usr/bin/env bash
set -ex

attach () {
    # only attempt attachment if this looks like a java container
    if [[ $(docker inspect ${container_id} | jq --raw-output .[0].Config.Cmd[0]) == java ]]
    then
        echo attaching to $(docker ps --no-trunc | grep ${container_id})
        docker cp ./apm-agent-attach-*-standalone.jar ${container_id}:/apm-agent-attach-standalone.jar
        docker exec ${container_id} java -jar /apm-agent-attach-standalone.jar --config
    fi
}

# attach to running containers
for container_id in $(docker ps --quiet --no-trunc) ; do
    attach
done

# listen for starting containers and attach to those
docker events --filter 'event=start' --format '{{.ID}}' |
while IFS= read -r container_id
do
    attach
done</pre></div><p>
</p><h4><a id="setup-attach-cli-troubleshooting"></a>Troubleshooting<a xmlns="" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-attach-cli.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>If you get a message like <code class="literal">no main manifest attribute, in apm-agent-attach.jar</code>,
you are using the wrong artifact.
Use the one which ends in <code class="literal">-standalone.jar</code>.</p></div><div xmlns="" class="navfooter"><span class="prev"><a href="setup-javaagent.html">
              « 
              Manual setup with <code xmlns="http://www.w3.org/1999/xhtml" class="literal">-javaagent</code> flag</a>
           
        </span><span class="next">
           
          <a href="setup-attach-api.html">Programmatic API setup to self-attach
               »
            </a></span></div></body></html>