<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Get started with Lambda (Experimental) | APM Java Agent Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="APM Java Agent Reference [master]"/>
<link rel="up" href="setup.html" title="Set up the Agent"/>
<link rel="prev" href="ssl-configuration.html" title="SSL/TLS communication with APM Server"/>
<link rel="next" href="supported-technologies-details.html" title="Supported technologies"/>
<meta name="DC.type" content="Learn/Docs/APM Java Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">APM Java Agent Reference [master]</a></span>
»
<span class="breadcrumb-link"><a href="setup.html">Set up the Agent</a></span>
»
<span class="breadcrumb-node">Get started with Lambda (Experimental)</span>
</div>
<div class="navheader">
<span class="prev">
<a href="ssl-configuration.html">« SSL/TLS communication with APM Server</a>
</span>
<span class="next">
<a href="supported-technologies-details.html">Supported technologies »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="aws-lambda"></a>Get started with Lambda (Experimental)<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h2>
</div></div></div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>This functionality is experimental and may be changed or removed completely in a future release. Elastic will take a best effort approach to fix any issues, but experimental features are not subject to the support SLA of official GA features.</p>
</div>
</div>
<p>Getting Elastic APM set up for your lambda functions is easy,
and there are various ways you can tweak it to fit your needs.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In order to get the full AWS Lambda tracing capabilities, use with APM Server 7.16 or higher. Using
older versions provides most value, but some relevant metadata fields will not be indexed.</p>
</div>
</div>
<h4><a id="aws-lambda-installation"></a>Installation<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Setting up your Lambda function is a two-step process.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="aws-lambda.html#aws-lambda-extension" title="Install the Elastic APM Lambda extension">Install the Elastic APM Lambda extension</a>
</li>
<li class="listitem">
<a class="xref" href="aws-lambda.html#aws-lambda-instrumenting" title="Installing the Elastic APM Java Agent layer">Installing the Elastic APM Java Agent layer</a>
</li>
</ol>
</div>
<h4><a id="aws-lambda-extension"></a>Install the Elastic APM Lambda extension<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Elastic uses a Lambda extension to forward data to APM Server in a way that does not interfere with the
execution of your Lambda function.</p>
<p>See the <a href="https://github.com/elastic/apm-aws-lambda/blob/main/docs/aws-lambda-extension.asciidoc" class="ulink" target="_top">installation documentation</a> to get started.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Not all environment variables specified within <a href="https://github.com/elastic/apm-aws-lambda/blob/main/docs/aws-lambda-extension.asciidoc#the-necessary-variables" class="ulink" target="_top">The Necessary Variables</a>
section of the extension documentation need to be configured. The Java agent utilizes a <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-modify.html" class="ulink" target="_top">wrapper script</a>
to set some of these up, so follow the next section to see which are required.</p>
</div>
</div>
<h4><a id="aws-lambda-instrumenting"></a>Installing the Elastic APM Java Agent layer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>The Java Agent is installed as an AWS Layer as well. It is distributed as a ZIP archive containing two files:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The Java Agent jar file
</li>
<li class="listitem">
A wrapper script that sets up the runtime to enable automatic attachment of the agent
</li>
</ul>
</div>
<p>Follow these steps to ensure proper Java Agent attachment to your Lambda function:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Download the <code class="literal">elastic-apm-java-aws-lambda-layer-&lt;VERSION&gt;.zip</code> archive from our
<a href="https://github.com/elastic/apm-agent-java/releases" class="ulink" target="_top">GitHub Releases page</a>.
</li>
<li class="listitem">
Publish the downloaded ZIP archive as an <a href="https://docs.aws.amazon.com/lambda/latest/dg/invocation-layers.html?icmpid=docs_lambda_help" class="ulink" target="_top">AWS Lambda Layer</a>.
</li>
<li class="listitem">
Configure your function to use the Java Agent layer.
</li>
<li class="listitem">
<p>Within your Function configuration, configure the following environment variables:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">AWS_LAMBDA_EXEC_WRAPPER</code> (required): set this variable&#8217;s value to <code class="literal">/opt/elastic-apm-handler</code>, so that Lambda starts the runtime with this script.
</li>
<li class="listitem">
<code class="literal">ELASTIC_APM_LAMBDA_APM_SERVER</code> (required): this will tell the Elastic APM Extension where to send data to.
</li>
<li class="listitem">
<a class="xref" href="config-reporter.html#config-secret-token" title="secret_token"><code class="literal">ELASTIC_APM_SECRET_TOKEN</code></a> or <a class="xref" href="config-reporter.html#config-api-key" title="api_key"><code class="literal">ELASTIC_APM_API_KEY</code></a> (required): one of these needs to be set
as the authentication method that the extension uses when sending data to the URL configured via <code class="literal">ELASTIC_APM_LAMBDA_APM_SERVER</code>
</li>
<li class="listitem">
<a class="xref" href="config-stacktrace.html#config-application-packages" title="application_packages"><code class="literal">ELASTIC_APM_APPLICATION_PACKAGES</code></a> (recommended): setting this may improve cold start times.
</li>
</ol>
</div>
</li>
<li class="listitem">
Fine-tune the Java agent with any of the available <a class="xref" href="configuration.html" title="Configuration">configuration options</a>.
</li>
</ol>
</div>
<p>That&#8217;s it, if you&#8217;ve done all of the above you are set to go!
Your Lambda function invocations should be traced from now on.</p>
<h4><a id="aws-lambda-performance-monitoring"></a>Performance monitoring<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Elastic APM automatically measures the performance of your lambda function executions.
It records traces for database queries, external HTTP requests,
and other slow operations that happen during execution.</p>
<p>By default, the agent will trace <a class="xref" href="setup.html#supported-technologies" title="Supported technologies">the usual supported technologies</a>.
To trace other events, take a look at <a class="xref" href="java-method-monitoring.html" title="How to find slow methods">additional method tracing options</a>, however note that
due to its asynchronous nature, the <a class="xref" href="method-sampling-based.html" title="Sampling-based profiler">Sampling Profiler</a> is not a valid option for AWS Lambda.</p>
<h4><a id="aws-lambda-error-monitoring"></a>Error monitoring<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<p>Whenever an <code class="literal">Exception</code> is thrown by your function handler method, the agent will send an error event to the APM Server
and the corresponding transaction will be recorded as a failed transaction.
Errors related to traced spans will be sent as well.</p>
<h4><a id="aws-lambda-caveats"></a>Caveats<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-java/edit/master/docs/setup-aws-lambda.asciidoc">edit</a></h4>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
System and custom metrics are not collected for Lambda functions. This is both because most of those are irrelevant
and because the interval-based event sending model is not suitable for FaaS environments.
</li>
<li class="listitem">
Cold starts can be significantly slower when the agent is installed. The higher memory limit you would allow for your
Function, the smaller this effect would be. This doesn&#8217;t affect memory usage for subsequent Function invocations,
it is only relevant for cold starts.
</li>
<li class="listitem">
The <a class="xref" href="method-sampling-based.html" title="Sampling-based profiler">Sampling Profiler</a> feature would not work because it relies on profiling sessions and
subsequent asynchronous processing of the collected data.
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="ssl-configuration.html">« SSL/TLS communication with APM Server</a>
</span>
<span class="next">
<a href="supported-technologies-details.html">Supported technologies »</a>
</span>
</div>
</div>
</body>
</html>
