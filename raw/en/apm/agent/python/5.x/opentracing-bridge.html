<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Elastic APM OpenTracing bridge
        | APM Python Agent Reference [5.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="APM Python Agent Reference [5.x]" /><link rel="up" href="index.html" title="APM Python Agent Reference [5.x]" /><link rel="prev" href="metric-sets.html" title="Metric Sets" /><link rel="next" href="advanced-topics.html" title="Advanced Topics" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/APM Python Agent/Reference/5.x" /><meta xmlns="" name="DC.subject" content="APM" /><meta xmlns="" name="DC.identifier" content="5.x" /></head><body><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Python Agent Reference
      [5.x]
    </a></span> » <span class="breadcrumb-node">Elastic APM OpenTracing bridge</span></div><div xmlns="" class="navheader"><span class="prev"><a href="metric-sets.html">
              « 
              Metric Sets</a>
           
        </span><span class="next">
           
          <a href="advanced-topics.html">Advanced Topics
               »
            </a></span></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="opentracing-bridge"></a>Elastic APM OpenTracing bridge<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h1></div></div></div><p>The Elastic APM OpenTracing bridge allows to create Elastic APM <code class="literal">Transactions</code> and <code class="literal">Spans</code>,
using the OpenTracing API.
In other words,
it translates the calls to the OpenTracing API to Elastic APM and thus allows for reusing existing instrumentation.</p><p>The first span of a service will be converted to an Elastic APM
<a class="ulink" href="https://www.elastic.co/guide/en/apm/get-started/current/transactions.html" target="_top"><code class="literal">Transaction</code></a>,
subsequent spans are mapped to Elastic APM
<a class="ulink" href="https://www.elastic.co/guide/en/apm/get-started/current/transaction-spans.html" target="_top"><code class="literal">Span</code></a>.</p><h3><a id="opentracing-getting-started"></a>Getting started<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>The first step in getting started with the OpenTracing API bridge is to install the <code class="literal">opentracing</code> library:</p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">pip install elastic-apm[opentracing]</pre></div><p>Or if you already have installed <code class="literal">elastic-apm</code></p><div xmlns="" class="pre_wrapper lang-bash"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-bash">pip install opentracing&gt;=2.0.0</pre></div><h3><a id="opentracing-init-tracer"></a>Initialize tracer<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><div xmlns="" class="pre_wrapper lang-python"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-python">from elasticapm.contrib.opentracing import Tracer

tracer = Tracer();</pre></div><p><code class="literal">Tracer</code> accepts the following optional arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">client_instance</code>: an already instantiated Elastic APM client</li><li class="listitem"><code class="literal">config</code>: a configuration dictionary, which will be used to instantiate a new Elastic APM client,
e.g. <code class="literal">{"SERVER_URL": "https://example.org"}</code>. See <a class="link" href="configuration.html" title="Configuration">configuration</a> for more information.</li><li class="listitem"><code class="literal">scope_manager</code>: a scope manager instance. Defaults to <code class="literal">ThreadLocalScopeManager</code> (see</li></ul></div><h3><a id="opentracing-elastic-apm-tags"></a>Elastic APM specific tags<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>Elastic APM defines some tags which are not included in the OpenTracing API but are relevant in the context of Elastic APM.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">type</code> - sets the type of the transaction,
for example <code class="literal">request</code>, <code class="literal">ext</code> or <code class="literal">db</code></li><li class="listitem"><code class="literal">user.id</code> - sets the user id,
appears in the "User" tab in the transaction details in the Elastic APM UI</li><li class="listitem"><code class="literal">user.email</code> - sets the user email,
appears in the "User" tab in the transaction details in the Elastic APM UI</li><li class="listitem"><code class="literal">user.username</code> - sets the user name,
appears in the "User" tab in the transaction details in the Elastic APM UI</li><li class="listitem"><code class="literal">result</code> - sets the result of the transaction. Overrides the default value of <code class="literal">success</code>.</li></ul></div><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">these tags need to be set on the first span of an operation (e.g. an incoming request of your webapp).</p></div></div><h3><a id="opentracing-caveats"></a>Caveats<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>Not all features of the OpenTracing API are supported.</p><h4><a id="opentracing-scope-managers"></a>Scope Managers<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Currently, only the <code class="literal">ThreadLocalScopeManager</code> is supported.
Using other scope managers will lead to unpredictable and possibly app-breaking behaviour.</p><h4><a id="opentracing-instrumentation"></a>Instrumentation<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>It is recommended to not use the built-in instrumentations of Elastic APM together with third-party OpenTracing instrumentations
like <a class="ulink" href="https://pypi.org/project/opentracing_instrumentation/" target="_top">opentracing_instrumentation</a> in the same service.
If you would like to use such instrumentations, we recommend to disable the built-in instrumentation using the <a class="link" href="configuration.html#config-instrument" title="instrument"><code class="literal">instrument</code></a> config option.</p><h4><a id="opentracing-propagation"></a>Context propagation<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>This bridge only supports the formats <code class="literal">Format.Builtin.TEXT_MAP</code> and <code class="literal">Format.Builtin.HTTP_HEADERS</code>.
<code class="literal">Format.Builtin.BINARY</code> is currently not supported.</p><h4><a id="opentracing-references"></a>Span References<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Currently, this bridge only supports <code class="literal">child_of</code> references.
Other references,
like <code class="literal">follows_from</code> are not supported yet.</p><h4><a id="opentracing-baggage"></a>Baggage<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>The <code class="literal">Span.set_baggage_item(key, value)</code> method is not supported.
Baggage items are silently dropped.</p><h4><a id="opentracing-logs"></a>Logs<a xmlns="" href="https://github.com/elastic/apm-agent-python/edit/5.x/docs/opentracing.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Only exception logging is supported.
Logging an Exception on the OpenTracing span will create an Elastic APM
<a class="ulink" href="https://www.elastic.co/guide/en/apm/get-started/current/errors.html" target="_top"><code class="literal">Error</code></a>.
Example:</p><div xmlns="" class="pre_wrapper lang-python"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-python">with tracer.start_active_span("transaction") as tx_scope:
    try:
        raise ValueError("oops")
    except ValueError:
        exc_type, exc_val, exc_tb = sys.exc_info()[:3]
        tx_scope.span.log_kv({
            "python.exception.type": exc_type,
            "python.exception.val": exc_val,
            "python.exception.tb": exc_tb
        })</pre></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="metric-sets.html">
              « 
              Metric Sets</a>
           
        </span><span class="next">
           
          <a href="advanced-topics.html">Advanced Topics
               »
            </a></span></div></body></html>