<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Log correlation in Elasticsearch
        | APM Python Agent Reference [master]
      | Elastic
    </title><link rel="home" href="index.html" title="APM Python Agent Reference [master]" /><link rel="up" href="advanced-topics.html" title="Advanced Topics" /><link rel="prev" href="logging-integrations.html" title="Logging integrations" /><link rel="next" href="api.html" title="Public API" /><meta name="DC.type" content="Learn/Docs/APM Python Agent/Reference/master" /><meta name="DC.subject" content="APM" /><meta name="DC.identifier" content="master" /></head><body><div class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Python Agent Reference
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="advanced-topics.html">Advanced Topics</a></span> » <span class="breadcrumb-node">Log correlation in Elasticsearch</span></div><div class="navheader"><span class="prev"><a href="logging-integrations.html">
              « 
              Logging integrations</a>
           
        </span><span class="next">
           
          <a href="api.html">Public API
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="log-correlation"></a>Log correlation in Elasticsearch<a href="https://github.com/elastic/apm-agent-python/edit/master/docs/logging.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>In order to correlate logs from your app with transactions captured by the
Elastic APM Python Agent, your logs must contain one or more of the following
identifiers:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">transaction.id</code></li><li class="listitem"><code class="literal">trace.id</code></li><li class="listitem"><code class="literal">span.id</code></li></ul></div><p>If you’re using structured logging, either <a class="ulink" href="https://docs.python.org/3/howto/logging-cookbook.html#implementing-structured-logging" target="_top">with a custom solution</a>
or with <a class="ulink" href="http://www.structlog.org/en/stable/" target="_top">structlog</a> (recommended), then this
is fairly easy. Throw the <a class="ulink" href="http://www.structlog.org/en/stable/api.html#structlog.processors.JSONRenderer" target="_top">JSONRenderer</a>
in, and use <a class="ulink" href="/blog/structured-logging-filebeat" target="_top">Filebeat</a>
to pull these logs into Elasticsearch.</p><p>Without structured logging the task gets a little trickier. Here we
recommend first making sure your LogRecord objects have the elasticapm
attributes (see <a class="xref" href="logging-integrations.html#logging" title="logging"><code class="literal">logging</code></a>), and then you’ll want to combine some specific
formatting with a Grok pattern, either in Elasticsearch using
<a class="ulink" href="/guide/en/elasticsearch/reference/current/grok-processor.html" target="_top">the grok processor</a>,
or in <a class="ulink" href="http://www.elastic.co/guide/en/logstash/current/plugins-filters-grok.html" target="_top">logstash with a plugin</a>.</p><p>Say you have a <a class="ulink" href="https://docs.python.org/3/library/logging.html#logging.Formatter" target="_top">Formatter</a>
that looks like this:</p><div class="pre_wrapper lang-python"><pre class="programlisting prettyprint lang-python">import logging

fh = logging.FileHandler('spam.log')
formatter = logging.Formatter("%(asctime)s - %(name)s - %(levelname)s - %(message)s")
fh.setFormatter(formatter)</pre></div><p>You can add the APM identifiers by simply switching out the <code class="literal">Formatter</code> object
for the one that we provide:</p><div class="pre_wrapper lang-python"><pre class="programlisting prettyprint lang-python">import logging
from elasticapm.handlers.logging import Formatter

fh = logging.FileHandler('spam.log')
formatter = Formatter("%(asctime)s - %(name)s - %(levelname)s - %(message)s")
fh.setFormatter(formatter)</pre></div><p>This will automatically append apm-specific fields to your format string:</p><div class="pre_wrapper lang-python"><pre class="programlisting prettyprint lang-python">formatstring = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
formatstring = formatstring + " | elasticapm " \
                              "transaction.id=%(elasticapm_transaction_id)s " \
                              "trace.id=%(elasticapm_trace_id)s " \
                              "span.id=%(elasticapm_span_id)s"</pre></div><p>Then, you could use a grok pattern like this (for the
<a class="ulink" href="/guide/en/elasticsearch/reference/current/grok-processor.html" target="_top">Elasticsearch Grok Processor</a>):</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">{
  "description" : "...",
  "processors": [
    {
      "grok": {
        "field": "message",
        "patterns": ["%{GREEDYDATA:msg} | elasticapm transaction.id=%{DATA:transaction.id} trace.id=%{DATA:trace.id} span.id=%{DATA:span.id}"]
      }
    }
  ]
}</pre></div></div><div class="navfooter"><span class="prev"><a href="logging-integrations.html">
              « 
              Logging integrations</a>
           
        </span><span class="next">
           
          <a href="api.html">Public API
               »
            </a></span></div></body></html>
