<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Public API
        | APM Ruby Agent Reference [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="APM Ruby Agent Reference [master]" /><link rel="up" href="index.html" title="APM Ruby Agent Reference [master]" /><link rel="prev" href="supported-technologies.html" title="Supported technologies" /><link rel="next" href="debugging.html" title="Debugging the agent itself" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/APM Ruby Agent/Reference/master" /><meta name="DC.subject" content="APM" /><meta name="DC.identifier" content="master" /></head><body><div class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">APM Ruby Agent Reference
      [master]
    </a></span> » <span class="breadcrumb-node">Public API</span></div><div class="navheader"><span class="prev"><a href="supported-technologies.html">
              « 
              Supported technologies</a>
           
        </span><span class="next">
           
          <a href="debugging.html">Debugging the agent itself
               »
            </a></span></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="api"></a>Public API<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h1></div></div></div><p>Although most usage is covered automatically, Elastic APM also has a public
API that allows custom usage.</p><h3><a id="agent-life-cycle"></a>Agent life cycle<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p>Controlling when the agent starts and stops.</p><h4><a id="api-agent-start"></a><code class="literal">ElasticAPM.start</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>To create and start an ElasticAPM agent use <code class="literal">ElasticAPM.start</code>:</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">ElasticAPM.start(server_url: 'http://localhost:8200')</pre></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">config</code>: An optional hash or <code class="literal">ElasticAPM::Config</code> instance with configuration
options.  See <a class="link" href="configuration.html" title="Configuration">Configuration</a>.</li></ul></div><p>If you are using <a class="link" href="getting-started-rails.html" title="Getting started with Rails">Ruby on Rails</a> this is done
automatically for you.
If not see <a class="link" href="getting-started-rack.html" title="Getting started with Rack">Getting started with Rack</a>.</p><h4><a id="api-agent-stop"></a><code class="literal">ElasticAPM.stop</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Stop the currently running agent. Use this inside <code class="literal">at_exit</code> in your
<a class="link" href="getting-started-rack.html" title="Getting started with Rack">Rack app</a> to gracefully shut down.</p><h4><a id="api-agent-running"></a><code class="literal">ElasticAPM.running?</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Returns whether the ElasticAPM Agent is currently running.</p><h4><a id="api-agent-agent"></a><code class="literal">ElasticAPM.agent</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Returns the currently running agent or nil.</p><h3><a id="_instrumentation"></a>Instrumentation<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><h4><a id="api-agent-current-transaction"></a><code class="literal">ElasticAPM.current_transaction</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Returns the current <code class="literal">ElasticAPM::Transaction</code> or nil.</p><h4><a id="api-agent-start_transaction"></a><code class="literal">ElasticAPM.start_transaction</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Start a <span class="emphasis"><em>transaction</em></span> eg. an incoming web request or a background job.</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby"># call with block
ElasticAPM.start_transaction('Name')
do_work # ...
ElasticAPM.end_transaction('result')</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: A name for your transaction. Transactions are grouped by name. <span class="strong strong"><strong>Required</strong></span>.</li><li class="listitem"><code class="literal">type</code>: A <code class="literal">type</code> for your transaction eg. <code class="literal">db.postgresql.sql</code>.</li><li class="listitem"><code class="literal">context:</code>: An optional <a class="link" href="api.html#api-context" title="Context">Context</a> used to enrich the
transaction with information about the current request.</li><li class="listitem"><code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.</li></ul></div><p>Returns the transaction.</p><h4><a id="api-agent-end_transaction"></a><code class="literal">ElasticAPM.end_transaction</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Ends the currently running transaction.</p><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">result</code>: A <code class="literal">String</code> result of the transaction, eg. <code class="literal">'success'</code>.</li></ul></div><h4><a id="api-agent-with_transaction"></a><code class="literal">ElasticAPM.with_transaction</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Wrap a block in a Transaction, starting and ending around the block</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">ElasticAPM.with_transaction 'Do things' do |transaction|
  do_work # ...

  transaction.result = 'success'
end</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: A name for your transaction. Transactions are grouped by name. <span class="strong strong"><strong>Required</strong></span>.</li><li class="listitem"><code class="literal">type</code>: A <code class="literal">type</code> for your transaction eg. <code class="literal">db.postgresql.sql</code>.</li><li class="listitem"><code class="literal">context:</code>: An optional <a class="link" href="api.html#api-context" title="Context">Context</a> used to enrich the
transaction with information about the current request.</li><li class="listitem"><code class="literal">trace_context:</code>: An optional <code class="literal">TraceContext</code> object for Distributed Tracing.</li><li class="listitem"><code class="literal">&amp;block</code>: A block to wrap. Optionally yields the transaction.</li></ul></div><p>Returns the return value of the given block.</p><h4><a id="api-agent-start_span"></a><code class="literal">ElasticAPM.start_span</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Start a new span.</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">ElasticAPM.with_transaction 'Do things' do
  ElasticAPM.start_span 'Do one of the things'
  Database.query # ...
  ElasticAPM.end_span
end</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: A name for your span. <span class="strong strong"><strong>Required</strong></span>.</li><li class="listitem"><code class="literal">type</code>: The type of work eg. <code class="literal">db.postgresql.query</code>.</li><li class="listitem"><code class="literal">context</code>: An instance of <code class="literal">Span::Context</code>.</li><li class="listitem"><code class="literal">include_stacktrace</code>: Whether or not to collect a Stacktrace.</li><li class="listitem"><code class="literal">&amp;block</code>: An optional block to wrap with the span.
The block is passed the span as an optional argument.</li></ul></div><p>Returns the created span.</p><h4><a id="api-agent-end_span"></a><code class="literal">ElasticAPM.end_span</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Ends the currently running span.</p><h4><a id="api-agent-with_span"></a><code class="literal">ElasticAPM.with_span</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Wraps a block in a Span.</p><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: A name for your span. <span class="strong strong"><strong>Required</strong></span>.</li><li class="listitem"><code class="literal">type</code>: The type of work eg. <code class="literal">db.postgresql.query</code>.</li><li class="listitem"><code class="literal">context</code>: An instance of <code class="literal">Span::Context</code>.</li><li class="listitem"><code class="literal">include_stacktrace</code>: Whether or not to collect a Stacktrace.</li><li class="listitem"><code class="literal">&amp;block</code>: An optional block to wrap with the span.
The block is passed the span as an optional argument.</li></ul></div><p>Returns the return value of the given block.</p><h4><a id="api-agent-build-context"></a><code class="literal">ElasticAPM.build_context</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Build a new <span class="emphasis"><em>Context</em></span> from a Rack <code class="literal">env</code>.</p><p>A context provides information about the current request, response, user and more.</p><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">rack_env</code>: An instance of Rack::Env</li><li class="listitem"><code class="literal">for_type</code>: Symbol representing type of event, eg. <code class="literal">:transaction</code> or <code class="literal">error</code></li></ul></div><p>Returns the built context.</p><h3><a id="_errors"></a>Errors<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><h4><a id="api-agent-report"></a><code class="literal">ElasticAPM.report</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Send an <code class="literal">Exception</code> to Elastic APM.</p><p>If reported inside a transaction, the context from that will be added.</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">begin
  do_a_thing_and_fail
rescue Exception =&gt; e
  ElasticAPM.report(e)
end</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">exception</code>: An instance of <code class="literal">Exception</code>. <span class="strong strong"><strong>Required</strong></span>.</li><li class="listitem"><code class="literal">handled</code>: Whether the error was <span class="emphasis"><em>handled</em></span> eg. wasn’t rescued and was represented
to the user. Default: <code class="literal">true</code>.</li></ul></div><p>Returns <code class="literal">[String]</code> ID of the generated <code class="literal">[ElasticAPM::Error]</code> object.</p><h4><a id="api-agent-report-message"></a><code class="literal">ElasticAPM.report_message</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Send a custom message to Elastic APM.</p><p>If reported inside a transaction, the context from that will be added.</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">ElasticAPM.report_message('This should probably never happen?!')</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">message</code>: A custom error string. <span class="strong strong"><strong>Required</strong></span>.</li></ul></div><p>Returns <code class="literal">[String]</code> ID of the generated <code class="literal">[ElasticAPM::Error]</code> object.</p><h3><a id="api-context"></a>Context<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><h4><a id="api-agent-set-tag"></a><code class="literal">ElasticAPM.set_tag</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Add a tag to the current transaction.
Tags are basic key-value pairs that are indexed in your Elasticsearch database
and therefore searchable.</p><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>Before using custom tags, ensure you understand the different types of
<a class="ulink" href="https://www.elastic.co/guide/en/apm/get-started/current/metadata.html" target="_top">metadata</a> that are available.</p></div></div><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">before_action do
  ElasticAPM.set_tag(:company_id, current_user.company.id)
end</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">key</code>: A string key. Note that <code class="literal">.</code>, <code class="literal">*</code> or <code class="literal">"</code> will be converted to <code class="literal">_</code>.</li><li class="listitem"><code class="literal">value</code>: A string value.</li></ul></div><p>Returns the set <code class="literal">value</code>.</p><div class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>Be aware that tags are indexed in Elasticsearch. Using too many unique keys will result in <span class="strong strong"><strong><a class="ulink" href="https://www.elastic.co/blog/found-crash-elasticsearch#mapping-explosion" target="_top">Mapping explosion</a></strong></span>.</p></div></div><h4><a id="api-agent-set-custom-context"></a><code class="literal">ElasticAPM.set_custom_context</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Add custom context to the current transaction.
Use this to further specify a context that will help you track or diagnose what’s
going on inside your app.</p><div class="tip admon"><div class="icon"><img alt="Tip" src="images/icons/tip.png" /></div><div class="admon_content"><p>Before using custom context, ensure you understand the different types of
<a class="ulink" href="https://www.elastic.co/guide/en/apm/get-started/current/metadata.html" target="_top">metadata</a> that are available.</p></div></div><p>If called several times during a transaction the custom context will be destructively
merged with <code class="literal">merge!</code>.</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">before_action do
  ElasticAPM.set_custom_context(company: current_user.company.to_h)
end</pre></div><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">context</code>: A hash of JSON-compatible key-values. Can be nested.</li></ul></div><p>Returns current custom context.</p><h4><a id="api-agent-set-user"></a><code class="literal">ElasticAPM.set_user</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Add the current user to the current transaction’s context.</p><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">user</code>: An object representing the user</li></ul></div><p>Returns the given user</p><h3><a id="_data"></a>Data<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><h4><a id="api-agent-add-filter"></a><code class="literal">ElasticAPM.add_filter</code><a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Provide a filter to transform payloads before sending.</p><p>Arguments:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">key</code>: A unique key identifying the filter</li><li class="listitem"><code class="literal">callable</code>: An object or proc (responds to <code class="literal">.call(payload)</code>)</li></ul></div><p>Return the altered payload.</p><p>If <code class="literal">nil</code> is returned all subsequent filters will be skipped and the post request cancelled.</p><p>Example:</p><div class="pre_wrapper lang-ruby"><pre class="programlisting prettyprint lang-ruby">ElasticAPM.add_filter(:filter_pings) do |payload|
  payload[:transactions]&amp;.reject! do |t|
    t[:name] == 'PingsController#index'
  end
  payload
end</pre></div><h3><a id="api-transaction"></a>Transaction<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p><code class="literal">ElasticAPM.transaction</code> returns a <code class="literal">Transaction</code> (if the agent is running).</p><h4><a id="_properties"></a>Properties<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: String</li><li class="listitem"><code class="literal">type</code>: String</li><li class="listitem"><code class="literal">result</code>: String</li><li class="listitem"><code class="literal">trace_id</code>: String (readonly)</li></ul></div><h4><a id="api-transaction-sampled_"></a>#sampled?<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>Whether the transaction is <span class="emphasis"><em>sampled</em></span> eg. it includes stacktraces for its spans.</p><h4><a id="api-transaction-ensure_parent_id"></a>#ensure_parent_id<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><p>If the transaction does not have a parent-ID yet, calling this method generates
a new ID, sets it as the parent-ID of this transaction, and returns it as a
<code class="literal">String</code>.</p><p>This enables the correlation of the spans the JavaScript Real User Monitoring
(RUM) agent creates for the initial page load with the transaction of the
backend service.</p><p>If your service generates the HTML page dynamically, initializing the
JavaScript RUM agent with the value of this method allows analyzing the time
spent in the browser vs in the backend services.</p><p>To enable the JavaScript RUM agent, initilialize the RUM agent with the Ruby
agent’a current transaction:</p><div class="pre_wrapper lang-html"><pre class="programlisting prettyprint lang-html">&lt;script src="elastic-apm-js-base/dist/bundles/elastic-apm-js-base.umd.min.js"&gt;&lt;/script&gt;
&lt;script&gt;
  var elasticApm = initApm({
    serviceName: '',
    serverUrl: 'http://localhost:8200',
    pageLoadTraceId: "&lt;%= ElasticAPM.current_transaction&amp;.trace_id %&gt;",
    pageLoadSpanId: "&lt;%= ElasticAPM.current_transaction&amp;.ensure_parent_id %&gt;",
    pageLoadSampled: &lt;%= ElasticAPM.current_transaction&amp;.sampled? %&gt;
  })
&lt;/script&gt;</pre></div><p>See the <a class="ulink" href="https://www.elastic.co/guide/en/apm/agent/rum-js/current" target="_top">JavaScript RUM agent documentation</a> for more information.</p><h3><a id="api-span"></a>Span<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><h4><a id="_properties_2"></a>Properties<a href="https://github.com/elastic/apm-agent-ruby/edit/master/docs/api.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">name</code>: String</li><li class="listitem"><code class="literal">type</code>: String</li></ul></div></div><div class="navfooter"><span class="prev"><a href="supported-technologies.html">
              « 
              Supported technologies</a>
           
        </span><span class="next">
           
          <a href="debugging.html">Debugging the agent itself
               »
            </a></span></div></body></html>
