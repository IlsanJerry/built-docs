<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>module/apmpgx | APM Go Agent Reference [2.x] | Elastic</title>
<link rel="home" href="index.html" title="APM Go Agent Reference [2.x]"/>
<link rel="up" href="index.html" title="APM Go Agent Reference [2.x]"/>
<link rel="prev" href="builtin-modules.html" title="Built-in instrumentation modules"/>
<link rel="next" href="custom-instrumentation.html" title="Custom instrumentation"/>
<meta name="DC.type" content="Learn/Docs/APM Go Agent/Reference/2.x"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="2.x"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">APM Go Agent Reference [2.x]</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="builtin-modules.html">« Built-in instrumentation modules</a>
</span>
<span class="next">
<a href="custom-instrumentation.html">Custom instrumentation »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h1 class="title"><a id="builtin-modules-apmpgx"></a>module/apmpgx<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-go/edit/2.x/docs/instrumenting.asciidoc">edit</a></h1>
</div></div></div>
<p>Package apmpgx provides a means of instrumenting the
<a href="https://github.com/jackc/pgx" class="ulink" target="_top">Pgx</a> for v4.17+,
so that SQL queries are reported as spans within the current transaction.
Also this lib have extended support of pgx, such as COPY FROM queries and BATCH which have their own span types:
<code class="literal">db.postgresql.copy</code> and <code class="literal">db.postgresql.batch</code> accordingly.</p>
<p>To report <code class="literal">pgx</code> queries, create <code class="literal">pgx</code> connection, and then provide config to <code class="literal">apmpgx.Instrument()</code>. If logger is presented in config,
then traces will be written to log. (It&#8217;s safe to use without logger)</p>
<p>Spans will be created for queries as long as they have context associated, and the
context includes a transaction.</p>
<p>Example with pool:</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
    "github.com/jackc/pgx/v4/pgxpool"

    "go.elastic.com/apm/module/apmpgx/v2"
)

func main() {
    c, err := pgxpool.ParseConfig("dsn_string")
    ...
    pool, err := pgxpool.ParseConfig("dsn")
    ...
    // set custom logger before instrumenting
    apmpgx.Instrument(pool.ConnConfig)
    ...
}</pre>
</div>
<p>Example without pool:</p>
<div class="pre_wrapper lang-go">
<pre class="programlisting prettyprint lang-go">import (
    "github.com/jackc/pgx/v4"

    "go.elastic.com/apm/module/apmpgx/v2"
)

func main() {
    c, err := pgx.Connect(context.Background, "dsn_string")
    ...
    // set custom logger before instrumenting
    apmpgx.Instrument(c.Config())
    ...
}</pre>
</div>


</div>
<div class="navfooter">
<span class="prev">
<a href="builtin-modules.html">« Built-in instrumentation modules</a>
</span>
<span class="next">
<a href="custom-instrumentation.html">Custom instrumentation »</a>
</span>
</div>
</div>
</body>
</html>
