<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Step 2: Add permissions to your AWS Lambda function | Monitoring AWS Lambda Functions | Elastic</title>
<link rel="home" href="index.html" title="Monitoring AWS Lambda Functions"/>
<link rel="up" href="aws-lambda-secrets-manager.html" title="Using AWS Secrets Manager to manage APM authentication keys"/>
<link rel="prev" href="aws-lambda-secrets-manager-create-secret.html" title="Step 1: Create a secret in the AWS Secrets Manager."/>
<link rel="next" href="_step_3_configure_the_elastic_apm_aws_lambda_extension.html" title="Step 3: Configure the Elastic APM AWS Lambda extension"/>
<meta name="DC.type" content="Learn/Docs/APM AWS Lambda extension/Reference"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="index.html">Monitoring AWS Lambda Functions</a></span><span class="chevron-right">›</span>
<span class="breadcrumb-link"><a href="aws-lambda-secrets-manager.html">Using AWS Secrets Manager to manage APM authentication keys</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="aws-lambda-secrets-manager-create-secret.html">« Step 1: Create a secret in the AWS Secrets Manager.</a>
</span>
<span class="next">
<a href="_step_3_configure_the_elastic_apm_aws_lambda_extension.html">Step 3: Configure the Elastic APM AWS Lambda extension »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="aws-lambda-secrets-manager-permissions"></a>Step 2: Add permissions to your AWS Lambda function<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-aws-lambda/edit/main/docs/monitoring-aws-lambda.asciidoc">edit</a></h2>
</div></div></div>
<p>For your Lambda function to be able to retrieve the authentication key from the AWS Secrets Manager, you need to provide the following permissions to your Lambda function.</p>
<div class="tabs" data-tab-group="os">
  <div role="tablist" aria-label="dependency">
    <button role="tab"
            aria-selected="true"
            aria-controls="console-tab-add-permissions"
            id="console-add-permissions">
      AWS Web Console
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="cli-tab-add-permissions"
            id="cli-add-permissions"
            tabindex="-1">
      AWS CLI
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="sam-tab-add-permissions"
            id="sam-add-permissions"
            tabindex="-1">
      SAM
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="serverless-tab-add-permissions"
            id="serverless-add-permissions"
            tabindex="-1">
      Serverless
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="terraform-tab-add-permissions"
            id="terraform-add-permissions"
            tabindex="-1">
      Terraform
    </button>
  </div>
  <div tabindex="0"
      role="tabpanel"
      id="console-tab-add-permissions"
      name="lambda-tabpanel"
      aria-labelledby="console-add-permissions">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
In the Web Console of your AWS Lambda function navigate to <code class="literal">Configuration</code> &#8594; <code class="literal">Permissions</code> and click on the link in the <code class="literal">Execution Role</code> section.
This will lead you to the Web Console for the corresponding IAM role.
</li>
<li class="listitem">
<p>Select <code class="literal">Create inline policy</code> in the <code class="literal">Add permission</code> dropdown button and select the <code class="literal">JSON</code> tab to define the following JSON-based policy:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": [
                "THE_ARN_OF_YOUR_SECRET"
            ]
        },
        { <a id="CO3-1"></a><i class="conum" data-value="1"></i>
            "Effect": "Allow",
            "Action": [
                "kms:Decrypt"
            ],
            "Resource": [
                "THE_ARN_OF_YOUR_CUSTOM_KMS_KEY"
            ]
        }
    ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO3-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This permission is ONLY needed if you use a custom KMS encryption key for your secret</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
Review and save the policy.
</li>
</ul>
</div>
  </div>
  <div tabindex="0"
      role="tabpanel"
      id="cli-tab-add-permissions"
      name="lambda-tabpanel"
      aria-labelledby="cli-add-permissions"
      hidden="">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>Create a policy file (<code class="literal">smElasticApmPolicy.json</code>) with the following content:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": [
                "THE_ARN_OF_YOUR_SECRET"
            ]
        },
        { <a id="CO4-1"></a><i class="conum" data-value="1"></i>
            "Effect": "Allow",
            "Action": [
                "kms:Decrypt"
            ],
            "Resource": [
                "THE_ARN_OF_YOUR_CUSTOM_KMS_KEY"
            ]
        }
    ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO4-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This permission is ONLY needed if you use a custom KMS encryption key for your secret</p>
</td>
</tr>
</table>
</div>
</li>
<li class="listitem">
<p>Retrieve the execution role name of your Lambda function with the following command:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">aws lambda get-function-configuration --function-name THE_NAME_OF_YOUR_FUNCTION | grep "Role"</pre>
</div>
</li>
<li class="listitem">
<p>Attach the new policy to the execution role:</p>
<div class="pre_wrapper lang-bash">
<pre class="programlisting prettyprint lang-bash">aws iam put-role-policy \
  --role-name NAME_OR_ARN_OF_THE_EXECUTION_ROLE \
  --policy-name SecretsManagerAPMKeyPolicy \
  --policy-document file://smElasticApmPolicy.json</pre>
</div>
</li>
</ul>
</div>
  </div>
  <div tabindex="0"
      role="tabpanel"
      id="sam-tab-add-permissions"
      name="lambda-tabpanel"
      aria-labelledby="sam-add-permissions"
      hidden="">
<p>In your SAM <code class="literal">template.yml</code> file add the following policy to give the Lambda function access to the stored secret:</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">...
AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Resources:
  yourLambdaFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      ...
      Policies:
      - Statement:
        - Sid: SecretsManagerGetSecretValue
          Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: 'THE_ARN_OF_YOUR_SECRET'
        - Sid: KMSDecrypt <a id="CO5-1"></a><i class="conum" data-value="1"></i>
          Effect: Allow
          Action:
            - kms:Decrypt
          Resource: 'THE_ARN_OF_YOUR_CUSTOM_KMS_KEY'
...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO5-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This permission is ONLY needed if you use a custom KMS encryption key for your secret</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
      role="tabpanel"
      id="serverless-tab-add-permissions"
      name="lambda-tabpanel"
      aria-labelledby="serverless-add-permissions"
      hidden="">
<p>In your serverless file add the following policy to give the Lambda function access to the stored secret:</p>
<div class="pre_wrapper lang-yml">
<pre class="programlisting prettyprint lang-yml">...
provider:
  iam:
    role:
      statements:
        - Effect: Allow
          Action: 'secretsmanager:GetSecretValue'
          Resource: 'THE_ARN_OF_YOUR_SECRET'
        - Effect: Allow <a id="CO6-1"></a><i class="conum" data-value="1"></i>
          Action: 'kms:Decrypt'
          Resource: 'THE_ARN_OF_YOUR_CUSTOM_KMS_KEY'
...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO6-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This permission is ONLY needed if you use a custom KMS encryption key for your secret</p>
</td>
</tr>
</table>
</div>
  </div>
  <div tabindex="0"
      role="tabpanel"
      id="terraform-tab-add-permissions"
      name="lambda-tabpanel"
      aria-labelledby="terraform-add-permissions"
      hidden="">
<p>Add the following policy and policy attachement resources to your terraform file to
give the Lambda function access to the stored secret:</p>
<div class="pre_wrapper lang-terraform">
<pre class="programlisting prettyprint lang-terraform">...
resource "aws_iam_role" "lambda_role" {
  // Here is your Lambda execution role
  ...
}

resource "aws_iam_policy" "secrets_manager_elastic_apm_policy" {
  name        = "secrets_manager_elastic_apm_policy"
  description = "Allows the lambda function to access the APM authentication key stored in AWS Secrets Manager."

  policy = &lt;&lt;EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Effect": "Allow",
      "Resource": "THE_ARN_OF_YOUR_SECRET"
    },
    { <a id="CO7-1"></a><i class="conum" data-value="1"></i>
      "Action": [
        "kms:Decrypt"
      ],
      "Effect": "Allow",
      "Resource": "THE_ARN_OF_YOUR_CUSTOM_KMS_KEY"
    }
  ]
}
EOF
}

resource "aws_iam_policy_attachment" "secrets_manager_elastic_apm_policy_attach" {
  role      = aws_iam_role.lambda_role.name
  policy_arn = aws_iam_policy.secrets_manager_elastic_apm_policy.arn
}
...</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO7-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This permission is ONLY needed if you use a custom KMS encryption key for your secret</p>
</td>
</tr>
</table>
</div>
  </div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="aws-lambda-secrets-manager-create-secret.html">« Step 1: Create a secret in the AWS Secrets Manager.</a>
</span>
<span class="next">
<a href="_step_3_configure_the_elastic_apm_aws_lambda_extension.html">Step 3: Configure the Elastic APM AWS Lambda extension »</a>
</span>
</div>
</div>
</body>
</html>
