<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Painless examples for transforms | Elasticsearch Reference [7.x] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [7.x]"/>
<link rel="up" href="transforms.html" title="Transforming data"/>
<link rel="prev" href="transform-examples.html" title="Transform examples"/>
<link rel="next" href="transform-troubleshooting.html" title="Troubleshooting transforms"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.x"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="7.x"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [7.x]</a></span>
»
<span class="breadcrumb-link"><a href="data-rollup-transform.html">Roll up or transform your data</a></span>
»
<span class="breadcrumb-link"><a href="transforms.html">Transforming data</a></span>
»
<span class="breadcrumb-node">Painless examples for transforms</span>
</div>
<div class="navheader">
<span class="prev">
<a href="transform-examples.html">« Transform examples</a>
</span>
<span class="next">
<a href="transform-troubleshooting.html">Troubleshooting transforms »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="transform-painless-examples"></a>Painless examples for transforms<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/transform/painless-examples.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>These examples demonstrate how to use Painless in transforms. You can learn
more about the Painless scripting language in the
<a href="/guide/en/elasticsearch/painless/7.x/painless-guide.html" class="ulink" target="_top">Painless guide</a>.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="transform-painless-examples.html#painless-top-hits" title="Getting top hits by using scripted metric">Getting top hits by using scripted metric</a>
</li>
<li class="listitem">
<a class="xref" href="transform-painless-examples.html#painless-time-features" title="Getting time features as scripted fields">Getting time features as scripted fields</a>
</li>
<li class="listitem">
<a class="xref" href="transform-painless-examples.html#painless-group-by" title="Using Painless in group_by">Using Painless in <code class="literal">group_by</code></a>
</li>
<li class="listitem">
<a class="xref" href="transform-painless-examples.html#painless-bucket-script" title="Getting duration by using bucket script">Getting duration by using bucket script</a>
</li>
</ul>
</div>
<h4><a id="painless-top-hits"></a>Getting top hits by using scripted metric<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/transform/painless-examples.asciidoc">edit</a></h4>
<p>This snippet shows how to find the latest document, in other words the document
with the earliest timestamp. From a technical perspective, it helps to achieve
the function of a <a class="xref" href="search-aggregations-metrics-top-hits-aggregation.html" title="Top Hits Aggregation">Top Hits Aggregation</a> by using
scripted metric aggregation which provides a metric output.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"latest_doc": {
  "scripted_metric": {
    "init_script": "state.timestamp_latest = 0L; state.last_doc = ''", <a id="CO456-1"></a><i class="conum" data-value="1"></i>
    "map_script": """ <a id="CO456-2"></a><i class="conum" data-value="2"></i>
      def current_date = doc['@timestamp'].getValue().toInstant().toEpochMilli();
      if (current_date &gt; state.timestamp_latest)
      {state.timestamp_latest = current_date;
      state.last_doc = new HashMap(params['_source']);}
    """,
    "combine_script": "return state", <a id="CO456-3"></a><i class="conum" data-value="3"></i>
    "reduce_script": """ <a id="CO456-4"></a><i class="conum" data-value="4"></i>
      def last_doc = '';
      def timestamp_latest = 0L;
      for (s in states) {if (s.timestamp_latest &gt; (timestamp_latest))
      {timestamp_latest = s.timestamp_latest; last_doc = s.last_doc;}}
      return last_doc
    """
  }
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO456-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">init_script</code> creates a long type <code class="literal">timestamp_latest</code> and a string type
<code class="literal">last_doc</code> in the <code class="literal">state</code> object.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO456-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">map_script</code> defines <code class="literal">current_date</code> based on the timestamp of the
document, then compares <code class="literal">current_date</code> with <code class="literal">state.timestamp_latest</code>, finally
returns <code class="literal">state.last_doc</code> from the shard. By using <code class="literal">new HashMap(...)</code> we copy the
source document, this is important whenever you want to pass the full source
object from one phase to the next.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO456-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">combine_script</code> returns <code class="literal">state</code> from each shard.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO456-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">reduce_script</code> iterates through the value of <code class="literal">s.timestamp_latest</code>
returned by each shard and returns the document with the latest timestamp
(<code class="literal">last_doc</code>). In the response, the top hit (in other words, the <code class="literal">latest_doc</code>) is
nested below the <code class="literal">latest_doc</code> field.</p>
</td>
</tr>
</table>
</div>
<p>Check the
<a class="xref" href="search-aggregations-metrics-scripted-metric-aggregation.html#scripted-metric-aggregation-scope" title="Scope of scripts">scope of scripts</a>
for detailed explanation on the respective scripts.</p>
<p>You can retrieve the last value in a similar way:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"latest_value": {
  "scripted_metric": {
    "init_script": "state.timestamp_latest = 0L; state.last_value = ''",
    "map_script": """
      def current_date = doc['date'].getValue().toInstant().toEpochMilli();
      if (current_date &gt; state.timestamp_latest)
      {state.timestamp_latest = current_date;
      state.last_value = params['_source']['value'];}
    """,
    "combine_script": "return state",
    "reduce_script": """
      def last_value = '';
      def timestamp_latest = 0L;
      for (s in states) {if (s.timestamp_latest &gt; (timestamp_latest))
      {timestamp_latest = s.timestamp_latest; last_value = s.last_value;}}
      return last_value
    """
  }
}</pre>
</div>
<h4><a id="painless-time-features"></a>Getting time features as scripted fields<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/transform/painless-examples.asciidoc">edit</a></h4>
<p>This snippet shows how to extract time based features by using Painless. The
snippet uses an index where <code class="literal">@timestamp</code> is defined as a <code class="literal">date</code> type field.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">"script_fields": {
    "hour_of_day": { <a id="CO457-1"></a><i class="conum" data-value="1"></i>
      "script": {
        "lang": "painless",
        "source": """
          ZonedDateTime date =  doc['@timestamp'].value; <a id="CO457-2"></a><i class="conum" data-value="2"></i>
          return date.getHour(); <a id="CO457-3"></a><i class="conum" data-value="3"></i>
        """
      }
    },
    "month_of_year": { <a id="CO457-4"></a><i class="conum" data-value="4"></i>
      "script": {
        "lang": "painless",
        "source": """
          ZonedDateTime date =  doc['@timestamp'].value; <a id="CO457-5"></a><i class="conum" data-value="5"></i>
          return date.getMonthValue(); <a id="CO457-6"></a><i class="conum" data-value="6"></i>
        """
      }
    }
  }</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Contains the Painless script that returns the hour of the day.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Sets <code class="literal">date</code> based on the timestamp of the document.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Returns the hour value from <code class="literal">date</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Contains the Painless script that returns the month of the year.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-5"><i class="conum" data-value="5"></i></a></p>
</td>
<td align="left" valign="top">
<p>Sets <code class="literal">date</code> based on the timestamp of the document.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO457-6"><i class="conum" data-value="6"></i></a></p>
</td>
<td align="left" valign="top">
<p>Returns the month value from <code class="literal">date</code>.</p>
</td>
</tr>
</table>
</div>
<h4><a id="painless-group-by"></a>Using Painless in <code class="literal">group_by</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/transform/painless-examples.asciidoc">edit</a></h4>
<p>It is possible to base the <code class="literal">group_by</code> property of a transform on the output of
a script. The following example uses the Kibana sample web logs dataset. The goal
here is to make the transform output easier to understand through normalizing
the value of the fields that the data is grouped by.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _transform/_preview
{
  "source": {
    "index": [ <a id="CO458-1"></a><i class="conum" data-value="1"></i>
      "kibana_sample_data_logs"
    ]
  },
  "pivot": {
    "group_by": {
      "agent": {
        "terms": {
          "script": { <a id="CO458-2"></a><i class="conum" data-value="2"></i>
            "source": """String agent = doc['agent.keyword'].value;
            if (agent.contains("MSIE")) {
              return "internet explorer";
            } else if (agent.contains("AppleWebKit")) {
              return "safari";
            } else if (agent.contains('Firefox')) {
              return "firefox";
            } else { return agent }""",
            "lang": "painless"
          }
        }
      }
    },
    "aggregations": { <a id="CO458-3"></a><i class="conum" data-value="3"></i>
      "200": {
        "filter": {
          "term": {
            "response": "200"
          }
        }
      },
      "404": {
        "filter": {
          "term": {
            "response": "404"
          }
        }
      },
      "503": {
        "filter": {
          "term": {
            "response": "503"
          }
        }
      }
    }
  },
  "dest": { <a id="CO458-4"></a><i class="conum" data-value="4"></i>
    "index": "pivot_logs"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1151.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO458-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specifies the source index or indices.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO458-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The script defines an <code class="literal">agent</code> string based on the <code class="literal">agent</code> field of the
documents, then iterates through the values. If an <code class="literal">agent</code> field contains
"MSIE", than the script returns "Internet Explorer". If it contains
<code class="literal">AppleWebKit</code>, it returns "safari". It returns "firefox" if the field value
contains "Firefox". Finally, in every other case, the value of the field is
returned.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO458-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>The aggregations object contains filters that narrow down the results to
documents that contains <code class="literal">200</code>, <code class="literal">404</code>, or <code class="literal">503</code> values in the <code class="literal">response</code> field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO458-4"><i class="conum" data-value="4"></i></a></p>
</td>
<td align="left" valign="top">
<p>Specifies the destination index of the transform.</p>
</td>
</tr>
</table>
</div>
<p>The API returns the following result:</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">{
  "preview" : [
    {
      "agent" : "firefox",
      "200" : 4931,
      "404" : 259,
      "503" : 172
    },
    {
      "agent" : "internet explorer",
      "200" : 3674,
      "404" : 210,
      "503" : 126
    },
    {
      "agent" : "safari",
      "200" : 4227,
      "404" : 332,
      "503" : 143
    }
  ],
  "mappings" : {
    "properties" : {
      "200" : {
        "type" : "long"
      },
      "agent" : {
        "type" : "keyword"
      },
      "404" : {
        "type" : "long"
      },
      "503" : {
        "type" : "long"
      }
    }
  }
}</pre>
</div>
<p>You can see that the <code class="literal">agent</code> values are simplified so it is easier to interpret
them. The table below shows how normalization modifies the output of the
transform in our example compared to the non-normalized values.</p>
<div class="informaltable">
<table border="1" cellpadding="4px" width="50%">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Non-normalized <code class="literal">agent</code> value</th>
<th align="left" valign="top">Normalized <code class="literal">agent</code> value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)"</p></td>
<td align="left" valign="top"><p>"internet explorer"</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>"Mozilla/5.0 (X11; Linux i686) AppleWebKit/534.24 (KHTML, like Gecko) Chrome/11.0.696.50 Safari/534.24"</p></td>
<td align="left" valign="top"><p>"safari"</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>"Mozilla/5.0 (X11; Linux x86_64; rv:6.0a1) Gecko/20110421 Firefox/6.0a1"</p></td>
<td align="left" valign="top"><p>"firefox"</p></td>
</tr>
</tbody>
</table>
</div>
<h4><a id="painless-bucket-script"></a>Getting duration by using bucket script<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/transform/painless-examples.asciidoc">edit</a></h4>
<p>This example shows you how to get the duration of a session by client IP from a
data log by using
<a href="/guide/en/elasticsearch/reference/7.x/search-aggregations-pipeline-bucket-script-aggregation.html" class="ulink" target="_top">bucket script</a>.
The example uses the Kibana sample web logs dataset.</p>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _data_frame/transforms/data_log
{
  "source": {
    "index": "kibana_sample_data_logs"
  },
  "dest": {
    "index": "data-logs-by-client"
  },
  "pivot": {
    "group_by": {
      "machine.os": {"terms": {"field": "machine.os.keyword"}},
      "machine.ip": {"terms": {"field": "clientip"}}
    },
    "aggregations": {
      "time_frame.lte": {
        "max": {
          "field": "timestamp"
        }
      },
      "time_frame.gte": {
        "min": {
          "field": "timestamp"
        }
      },
      "time_length": { <a id="CO459-1"></a><i class="conum" data-value="1"></i>
        "bucket_script": {
          "buckets_path": { <a id="CO459-2"></a><i class="conum" data-value="2"></i>
            "min": "time_frame.gte.value",
            "max": "time_frame.lte.value"
          },
          "script": "params.max - params.min" <a id="CO459-3"></a><i class="conum" data-value="3"></i>
        }
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/1152.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO459-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>To define the length of the sessions, we use a bucket script.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO459-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The bucket path is a map of script variables and their associated path to
the buckets you want to use for the variable. In this particular case, <code class="literal">min</code> and
<code class="literal">max</code> are variables mapped to <code class="literal">time_frame.gte.value</code> and <code class="literal">time_frame.lte.value</code>.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO459-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Finally, the script substracts the start date of the session from the end
date which results in the duration of the session.</p>
</td>
</tr>
</table>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="transform-examples.html">« Transform examples</a>
</span>
<span class="next">
<a href="transform-troubleshooting.html">Troubleshooting transforms »</a>
</span>
</div>
</div>
</body>
</html>
