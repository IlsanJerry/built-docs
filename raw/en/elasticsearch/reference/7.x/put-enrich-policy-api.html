<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Put enrich policy API
        | Elasticsearch Reference [7.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch Reference [7.x]" /><link rel="up" href="enrich-apis.html" title="Enrich APIs" /><link rel="prev" href="enrich-apis.html" title="Enrich APIs" /><link rel="next" href="delete-enrich-policy-api.html" title="Delete enrich policy API" /><meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/7.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="7.x" /></head><body><div class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [7.x]
    </a></span> » <span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span> » <span class="breadcrumb-link"><a href="enrich-apis.html">Enrich APIs</a></span> » <span class="breadcrumb-node">Put enrich policy API</span></div><div class="navheader"><span class="prev"><a href="enrich-apis.html">
              « 
              Enrich APIs</a>
           
        </span><span class="next">
           
          <a href="delete-enrich-policy-api.html">Delete enrich policy API
               »
            </a></span></div><div class="xpack section"><div class="titlepage"><div><div><h2 class="title"><a id="put-enrich-policy-api"></a>Put enrich policy API<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2></div></div></div><p>Creates an enrich policy.</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /_enrich/policy/my-policy
{
    "match": {
        "indices": "users",
        "match_field": "email",
        "enrich_fields": ["first_name", "last_name", "city", "zip", "state"]
    }
}</pre></div><div class="console_widget" data-snippet="snippets/1412.console"></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-request"></a>Request<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p><code class="literal">PUT /_enrich/policy/&lt;enrich-policy&gt;</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-prereqs"></a>Prerequisites<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>If you use Elasticsearch security features, you must have:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">read</code> index privileges for any indices used</li><li class="listitem">The <code class="literal">enrich_user</code> <a class="ulink" href="/guide/en/elastic-stack-overview/7.x/built-in-roles.html" target="_top">built-in role</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-desc"></a>Description<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Use the put enrich policy API
to create a new enrich policy.</p><p>An <span class="strong strong"><strong>enrich policy</strong></span> is a set of rules the enrich processor uses
to append the appropriate data to incoming documents.
An enrich policy contains:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The <span class="strong strong"><strong>policy type</strong></span>,
which determines how the processor enriches incoming documents</li><li class="listitem">A list of source indices</li><li class="listitem">The <span class="strong strong"><strong>match field</strong></span> used to match incoming documents</li><li class="listitem"><span class="strong strong"><strong>Enrich fields</strong></span> appended to incoming documents
from matching documents</li></ul></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="_update_an_enrich_policy"></a>Update an enrich policy<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>You cannot update an existing enrich policy.
Instead, you can:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Create and execute a new enrich policy.</li><li class="listitem">Replace the previous enrich policy
with the new enrich policy
in any in-use enrich processors.</li><li class="listitem">Use the <a class="link" href="delete-enrich-policy-api.html" title="Delete enrich policy API">delete enrich policy</a> API
to delete the previous enrich policy.</li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-path-params"></a>Path parameters<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">&lt;enrich-policy&gt;</code></span></dt><dd>(Required, string)
Enrich policy name
used to limit the request.</dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-request-body"></a>Request body<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">&lt;policy-type&gt;</code></span></dt><dd><p class="simpara">(Required, enrich policy object)
The parameter key is the enrich policy type.
The enrich policy type indicates
how the enrich processor matches incoming documents
to documents in the enrich index.</p><p class="simpara">Valid key values are:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">match</code></span></dt><dd>Match documents in the enrich index
using a <a class="link" href="query-dsl-term-query.html" title="Term query">term query</a> for the <code class="literal">match_field</code>.
See <a class="xref" href="ingest-enriching-data.html#enrich-setup" title="Set up an enrich processor">Set up an enrich processor</a> for an example.</dd><dt><span class="term"><code class="literal">geo_match</code></span></dt><dd>Match documents in the enrich index
using a <a class="link" href="query-dsl-geo-shape-query.html" title="Geo-shape query"><code class="literal">geo_shape</code> query</a> for the <code class="literal">match_field</code>.
See <a class="xref" href="put-enrich-policy-api.html#put-enrich-policy-geo-match-ex" title="geo_match policy type"><code class="literal">geo_match</code> policy type</a> for an example.</dd></dl></div><p class="simpara">The parameter value is the enrich policy.
The enrich policy is a set of rules
used to create an <a class="link" href="ingest-enriching-data.html#execute-enrich-policy" title="Execute an enrich policy">enrich index</a>.
The enrich processor also uses these rules
to append field data to incoming documents.</p><p class="simpara">Parameters include:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">indices</code></span></dt><dd>(Required, array of strings)
Source indices used to create the enrich index.</dd><dt><span class="term"><code class="literal">query</code></span></dt><dd>(Optional, string)
Query type used to find and select documents in the enrich index.
Valid value is <a class="link" href="query-dsl-match-all-query.html" title="Match all query"><code class="literal">match_all</code></a> (default).</dd><dt><span class="term"><code class="literal">match_field</code></span></dt><dd>(Required, string)
Field used to match incoming documents
to documents in the enrich index.</dd><dt><span class="term"><code class="literal">enrich_fields</code></span></dt><dd>(Required, Array of string)
Fields appended to incoming documents
from matching documents in the enrich index.</dd></dl></div></dd></dl></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="put-enrich-policy-api-example"></a>Examples<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="put-enrich-policy-geo-match-ex"></a><code class="literal">geo_match</code> policy type<a href="https://github.com/elastic/elasticsearch/edit/7.x/docs/reference/ingest/apis/enrich/put-enrich-policy.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h4></div></div></div><p>You can use the <code class="literal">geo_match</code> enrich policy type
to enrich incoming documents
based on matching geo_shapes.
For example,
you can add postal codes
to incoming documents
based on a set of coordinates.</p><p>To see how the <code class="literal">geo_match</code> policy type works,
try the following example.</p><p>Use the <a class="link" href="indices-create-index.html" title="Create index API">create index API</a>
to create a source index.
The field mappings for the source index
must contain:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">A <a class="link" href="geo-shape.html" title="Geo-shape datatype"><code class="literal">geo_shape</code></a> field
which the enrich processor can use to match incoming documents</li><li class="listitem">One or more enrich fields
you’d like to append to incoming documents</li></ul></div><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /postal_codes
{
    "mappings": {
        "properties": {
            "location": {
                "type": "geo_shape"
            },
            "postal_code": {
                "type": "keyword"
            }
        }
    }
}</pre></div><div class="console_widget" data-snippet="snippets/1413.console"></div><p>Use the <a class="link" href="docs-index_.html" title="Index API">index API</a>
to index data to this source index.</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /postal_codes/_doc/1?refresh=wait_for
{
    "location": {
        "type": "envelope",
        "coordinates": [[13.0, 53.0], [14.0, 52.0]]
    },
    "postal_code": "96598"
}</pre></div><div class="console_widget" data-snippet="snippets/1414.console"></div><p>Use the put enrich policy API
to create an enrich policy
with the <code class="literal">geo_match</code> policy type.
This policy must include:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">One or more source indices</li><li class="listitem">A <code class="literal">match_field</code>,
the <code class="literal">geo_shape</code> field from the source indices
used to match incoming documents</li><li class="listitem">Enrich fields from the source indices
you’d like to append to incoming documents</li></ul></div><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /_enrich/policy/postal_policy
{
    "geo_match": {
        "indices": "postal_codes",
        "match_field": "location",
        "enrich_fields": ["location","postal_code"]
    }
}</pre></div><div class="console_widget" data-snippet="snippets/1415.console"></div><p>Use the <a class="link" href="execute-enrich-policy-api.html" title="Execute enrich policy API">execute enrich policy API</a>
to create an enrich index for the policy.</p><p>The <span class="emphasis"><em>enrich index</em></span> contains documents from the policy’s source indices.
Enrich indices always begin with <code class="literal">.enrich-*</code>,
are read-only,
and are <a class="link" href="indices-forcemerge.html" title="Force merge API">force merged</a>.</p><div class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>Enrich indices should be used by the <a class="link" href="enrich-processor.html" title="Enrich Processor">enrich processor</a> only.
Avoid using enrich indices for other purposes.</p></div></div><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">POST /_enrich/policy/postal_policy/_execute</pre></div><div class="console_widget" data-snippet="snippets/1416.console"></div><p>Use the <a class="link" href="put-pipeline-api.html" title="Put pipeline API">put pipeline API</a>
to create an ingest pipeline.
In the pipeline,
add an <a class="link" href="enrich-processor.html" title="Enrich Processor">enrich processor</a>
that includes:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">Your enrich policy</li><li class="listitem">The <code class="literal">field</code> of incoming documents used
to match the geo_shape of documents from the enrich index.</li><li class="listitem">The <code class="literal">target_field</code> used
to store appended enrich data for incoming documents.</li><li class="listitem">The <code class="literal">shape_relation</code>,
which indicates how the processor matches geo_shapes in incoming documents
to geo_shapes in documents from the enrich index.
See <a class="xref" href="query-dsl-geo-shape-query.html#_spatial_relations" title="Spatial Relations">Spatial Relations</a> for valid options and more information.</li></ul></div><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /_ingest/pipeline/postal_lookup
{
  "description": "Enrich postal codes",
  "processors": [
    {
      "enrich": {
        "policy_name": "postal_policy",
        "field": "geo_location",
        "target_field": "geo_data",
        "shape_relation": "INTERSECTS"
      }
    }
  ]
}</pre></div><div class="console_widget" data-snippet="snippets/1417.console"></div><p>Use the ingest pipeline
to index a document.
The incoming document
should include the <code class="literal">field</code>
specified in your enrich processor.</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">PUT /users/_doc/0?pipeline=postal_lookup
{
    "first_name": "Mardy",
    "last_name": "Brown",
    "geo_location": "POINT (13.5 52.5)"
}</pre></div><div class="console_widget" data-snippet="snippets/1418.console"></div><p>To verify the enrich processor matched
and appended the appropriate field data,
use the <a class="link" href="docs-get.html" title="Get API">get API</a>
to view the indexed document.</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">GET /users/_doc/0</pre></div><div class="console_widget" data-snippet="snippets/1419.console"></div><p>The API returns the following response:</p><div class="pre_wrapper lang-console-result"><pre class="programlisting prettyprint lang-console-result">{
  "found": true,
  "_index": "users",
  "_type": "_doc",
  "_id": "0",
  "_version": 1,
  "_seq_no": 55,
  "_primary_term": 1,
  "_source": {
    "geo_data": {
      "location": {
        "type": "envelope",
        "coordinates": [[13.0, 53.0], [14.0, 52.0]]
      },
      "postal_code": "96598"
    },
    "first_name": "Mardy",
    "last_name": "Brown",
    "geo_location": "POINT (13.5 52.5)"
  }
}</pre></div></div></div></div><div class="navfooter"><span class="prev"><a href="enrich-apis.html">
              « 
              Enrich APIs</a>
           
        </span><span class="next">
           
          <a href="delete-enrich-policy-api.html">Delete enrich policy API
               »
            </a></span></div></body></html>
