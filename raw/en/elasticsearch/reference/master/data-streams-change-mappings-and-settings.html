<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Change mappings and settings of backing indices | Elasticsearch Reference [master] | Elastic</title>
<link rel="home" href="index.html" title="Elasticsearch Reference [master]"/>
<link rel="up" href="data-streams.html" title="Data streams"/>
<link rel="prev" href="use-a-data-stream.html" title="Use a data stream"/>
<link rel="next" href="search-your-data.html" title="Search your data"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference [master]</a></span>
»
<span class="breadcrumb-link"><a href="data-streams.html">Data streams</a></span>
»
<span class="breadcrumb-node">Change mappings and settings of backing indices</span>
</div>
<div class="navheader">
<span class="prev">
<a href="use-a-data-stream.html">« Use a data stream</a>
</span>
<span class="next">
<a href="search-your-data.html">Search your data »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="data-streams-change-mappings-and-settings"></a>Change mappings and settings of backing indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/data-streams/change-mappings-and-settings.asciidoc">edit</a></h2>
</div></div></div>

<p>Each data stream has a <a class="xref" href="set-up-a-data-stream.html#create-a-data-stream-template" title="Create an index template for a data stream">matching index
template</a>. Mappings and index settings from this template are applied to new
backing indices created for the stream. This includes the stream&#8217;s first
backing index, which is auto-generated when the stream is created.</p>
<p>Before creating a data stream, we recommend you carefully consider which
mappings and settings to include in this template. However, if you later need to
change the mappings or settings of a data stream&#8217;s backing indices, you have a
couple options:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<p>To apply changes to future backing indices, simply update the index
template used by the data stream. Mapping and setting changes will be
automatically applied to any backing indices created after the update.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p><code class="literal">logs_data_stream</code> is an existing index template used by the
<code class="literal">logs</code> data stream.</p>
<p>The following <a class="xref" href="indices-templates.html" title="Index templates">put index template API</a> makes several
changes to the <code class="literal">logs_data_stream</code> template:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
It changes the <code class="literal">@timestamp</code> field mapping from the <code class="literal">date</code> field datatype to
the <code class="literal">date_nanos</code> datatype.
</li>
<li class="listitem">
It adds new <code class="literal">sort.field</code> and <code class="literal">sort.order</code> index settings.
</li>
</ul>
</div>
<a id="dd7e1e01baa6f23b45028d66a9d0936d"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_index_template/logs_data_stream
{
  "index_patterns": [ "logs*" ],
  "data_stream": {
    "timestamp_field": "@timestamp"
  },
  "template": {
    "mappings": {
      "properties": {
        "@timestamp": {
          "type": "date_nanos"                 <a id="CO17-1"></a><i class="conum" data-value="1"></i>
        }
      }
    },
    "settings": {
      "index.lifecycle.name": "logs_policy",
      "sort.field" : [ "@timestamp"],          <a id="CO17-2"></a><i class="conum" data-value="2"></i>
      "sort.order" : [ "desc"]                 <a id="CO17-3"></a><i class="conum" data-value="3"></i>
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/101.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Changes the <code class="literal">@timestamp</code> field mapping to the <code class="literal">date_nanos</code> datatype.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Adds the <code class="literal">sort.field</code> index setting.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO17-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Adds the <code class="literal">sort.order</code> index setting.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
<p>If wanted, you can <a class="xref" href="use-a-data-stream.html#manually-roll-over-a-data-stream" title="Manually roll over a data stream">roll over the data
stream</a> to immediately apply the new mappings and settings to the data stream&#8217;s
write index. This affects any new data added to the stream after the rollover.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following <a class="xref" href="indices-rollover-index.html" title="Rollover index API">rollover API</a> request rolls over the
<code class="literal">logs</code> data stream. This creates a new write index with mappings and index
settings from the recently updated <code class="literal">logs_data_stream</code> template.</p>
<a id="1311af3d6ce524cf7bf6bbc6438e6632"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /logs/_rollover/</pre>
</div>
<div class="console_widget" data-snippet="snippets/102.console"></div>
</div>
</details>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You cannot use these methods to change the mapping of a data stream&#8217;s
<a class="xref" href="set-up-a-data-stream.html#create-a-data-stream-template" title="Create an index template for a data stream">timestamp field</a>. To change the timestamp
field&#8217;s mapping, you must reindex the data stream. See
<a class="xref" href="data-streams-change-mappings-and-settings.html#data-streams-use-reindex-to-change-mappings-settings" title="Use reindex to change mappings or settings">Use reindex to change mappings or settings</a>.</p>
</div>
</div>
</li>
<li class="listitem">
To apply mapping and setting changes to all existing backing indices and
future ones, you must create a new data stream and reindex your data into it.
See <a class="xref" href="data-streams-change-mappings-and-settings.html#data-streams-use-reindex-to-change-mappings-settings" title="Use reindex to change mappings or settings">Use reindex to change mappings or settings</a>.
</li>
</ul>
</div>
<h3><a id="data-streams-use-reindex-to-change-mappings-settings"></a>Use reindex to change mappings or settings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/data-streams/change-mappings-and-settings.asciidoc">edit</a></h3>
<p>To change the mappings or settings for every backing index in a data stream, you
must first create or update an index template so that it contains the
changes. You can then reindex the existing data stream into a new one matching
the template. This applies the mapping and setting changes in the template
to each document and backing index of the data stream destination. These changes
also affect any future backing index created by the new stream.</p>
<p>Follow these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Choose a name or wildcard (<code class="literal">*</code>) pattern for a new data stream. This new data
stream will contain data from your existing stream.</p>
<p>You can use the resolve index API to check if the name or pattern matches any
existing indices, index aliases, or data streams. If so, you should consider
using another name or pattern.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following resolve index API request checks for any existing indices, index
aliases, or data streams that start with <code class="literal">new_logs</code>. If not, the <code class="literal">new_logs*</code>
wildcard pattern can be used to create a new data stream.</p>
<a id="ee5060d63a1b93aef6a4a879b647b4d4"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_resolve/index/new_logs*</pre>
</div>
<div class="console_widget" data-snippet="snippets/103.console"></div>
<p>The API returns the following response, indicating no existing targets match
this pattern.</p>
<a id="c0e49c54fab32435e388fc5591a52718"></a>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "indices" : [ ],
  "aliases" : [ ],
  "data_streams" : [ ]
}</pre>
</div>
</div>
</details>
</li>
<li class="listitem">
<p>Create or update an index template. This template should contain the
mappings and settings you&#8217;d like to apply to the new data stream&#8217;s backing
indices.</p>
<p>This index template must meet the
<a class="xref" href="set-up-a-data-stream.html#create-a-data-stream-template" title="Create an index template for a data stream">requirements for a data stream template</a>. It
should also contain your previously chosen name or wildcard pattern in the
<code class="literal">index_patterns</code> property.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If you are only adding or changing a few things, we recommend you create a
new template by copying an existing one and modifying it as needed.</p>
</div>
</div>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p><code class="literal">logs_data_stream</code> is an existing index template used by the
<code class="literal">logs</code> data stream.</p>
<p>The following <a class="xref" href="indices-templates.html" title="Index templates">put index template API</a> request creates
a new index template, <code class="literal">new_logs_data_stream</code>. <code class="literal">new_logs_data_stream</code>
uses the <code class="literal">logs_data_stream</code> template as its basis, with the following changes:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">index_patterns</code> wildcard pattern matches any index or data stream
starting with <code class="literal">new_logs</code>.
</li>
<li class="listitem">
The <code class="literal">@timestamp</code> field mapping uses the <code class="literal">date_nanos</code> field datatype rather
than the <code class="literal">date</code> datatype.
</li>
<li class="listitem">
The template includes <code class="literal">sort.field</code> and <code class="literal">sort.order</code> index settings, which were
not in the original <code class="literal">logs_data_stream</code> template.
</li>
</ul>
</div>
<a id="b8f69ee58caccfd7dac98bb130ec74ed"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_index_template/new_logs_data_stream
{
  "index_patterns": [ "new_logs*" ],
  "data_stream": {
    "timestamp_field": "@timestamp"
  },
  "template": {
    "mappings": {
      "properties": {
        "@timestamp": {
          "type": "date_nanos"                 <a id="CO18-1"></a><i class="conum" data-value="1"></i>
        }
      }
    },
    "settings": {
      "index.lifecycle.name": "logs_policy",
      "sort.field" : [ "@timestamp"],          <a id="CO18-2"></a><i class="conum" data-value="2"></i>
      "sort.order" : [ "desc"]                 <a id="CO18-3"></a><i class="conum" data-value="3"></i>
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/104.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Changes the <code class="literal">@timestamp</code> field mapping to the <code class="literal">date_nanos</code> field datatype.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Adds the <code class="literal">sort.field</code> index setting.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO18-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Adds the <code class="literal">sort.order</code> index setting.</p>
</td>
</tr>
</table>
</div>
</div>
</details>
</li>
<li class="listitem">
<p>Use the <a class="xref" href="indices-create-data-stream.html" title="Create data stream API">create data stream API</a> to manually
create the new data stream. The name of the data stream must match the name or
wildcard pattern defined in the new template&#8217;s <code class="literal">index_patterns</code> property.</p>
<p>We do not recommend <a class="xref" href="set-up-a-data-stream.html#index-documents-to-create-a-data-stream" title="Example: Index documents to create a data stream">indexing new data
to create this data stream</a>. Later, you will reindex older data from an
existing data stream into this new stream. This could result in one or more
backing indices that contains a mix of new and old data.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Mixing new and old data in a data stream<a id="data-stream-mix-new-old-data"></a></h3>
<p>While mixing new and old data is safe, it could interfere with data retention.
If you delete older indices, you could accidentally delete a backing index that
contains both new and old data. To prevent premature data loss, you would need
to retain such a backing index until you are ready to delete its newest data.</p>
</div>
</div>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following create data stream API request targets <code class="literal">new_logs</code>, which matches
the wildcard pattern for the <code class="literal">new_logs_data_stream</code> template. Because no
existing index or data stream uses this name, this request creates the
<code class="literal">new_logs</code> data stream.</p>
<a id="3ab064461259c1ccc49f719bdbff9d2d"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_data_stream/new_logs</pre>
</div>
<div class="console_widget" data-snippet="snippets/105.console"></div>
</div>
</details>
</li>
<li class="listitem">
If you do not want to mix new and old data in your new data stream, pause the
indexing of new documents. While mixing old and new data is safe, it could
interfere with data retention. See <a class="xref" href="data-streams-change-mappings-and-settings.html#data-stream-mix-new-old-data" title="Mixing new and old data in a data stream">Mixing new and
old data in a data stream</a>.
</li>
<li class="listitem">
<p>If you use ILM to <a class="xref" href="getting-started-index-lifecycle-management.html" title="Tutorial: Automate rollover with ILM">automate
rollover</a>, reduce the ILM poll interval. This ensures the current write
index doesn’t grow too large while waiting for the rollover check. By default,
ILM checks rollover conditions every 10 minutes.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following <a class="xref" href="cluster-update-settings.html" title="Cluster update settings API">update cluster settings API</a> request
lowers the <code class="literal">indices.lifecycle.poll_interval</code> setting to <code class="literal">1m</code> (one minute).</p>
<a id="a7164a0da5e76e422c6c8252c0699c4d"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_cluster/settings
{
  "transient": {
    "indices.lifecycle.poll_interval": "1m"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/106.console"></div>
</div>
</details>
</li>
<li class="listitem">
<p>Reindex your data to the new data stream using an <code class="literal">op_type</code> of <code class="literal">create</code>.</p>
<p>If you want to partition the data in the order in which it was originally
indexed, you can run separate reindex requests. These reindex requests can use
individual backing indices as the source. You can use the
<a class="xref" href="indices-get-data-stream.html" title="Get data stream API">get data stream API</a> to retrieve a list of backing
indices.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>You plan to reindex data from the <code class="literal">logs</code> data stream into the newly created
<code class="literal">new_logs</code> data stream. However, you want to submit a separate reindex request
for each backing index in the <code class="literal">logs</code> data stream, starting with the oldest
backing index. This preserves the order in which the data was originally
indexed.</p>
<p>The following get data stream API request retrieves information about the <code class="literal">logs</code>
data stream, including a list of its backing indices.</p>
<a id="7e8438023b41733747a2f9976c634f68"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET /_data_stream/logs</pre>
</div>
<div class="console_widget" data-snippet="snippets/107.console"></div>
<p>The API returns the following response. Note the <code class="literal">indices</code> property contains an
array of the stream&#8217;s current backing indices. The oldest backing index,
<code class="literal">.ds-logs-000001</code>, is the first item in the array.</p>
<a id="e245b9dfc43d661a37084650434c24ac"></a>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">[
  {
    "name": "logs",
    "timestamp_field": "@timestamp",
    "indices": [
      {
        "index_name": ".ds-logs-000001",
        "index_uuid": "DXAE-xcCQTKF93bMm9iawA"
      },
      {
        "index_name": ".ds-logs-000002",
        "index_uuid": "Wzxq0VhsQKyPxHhaK3WYAg"
      }
    ],
    "generation": 2
  }
]</pre>
</div>
<p>The following <a class="xref" href="docs-reindex.html" title="Reindex API">reindex API</a> request copies documents from
<code class="literal">.ds-logs-000001</code> to the <code class="literal">new_logs</code> data stream. Note the request&#8217;s <code class="literal">op_type</code> is
<code class="literal">create</code>.</p>
<a id="e7ae44963d6adcbbfbe377868cb52b6b"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_reindex
{
  "source": {
    "index": ".ds-logs-000001"
  },
  "dest": {
    "index": "new_logs",
    "op_type": "create"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/108.console"></div>
</div>
</details>
<p>You can also use a query to reindex only a subset of documents with each
request.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following <a class="xref" href="docs-reindex.html" title="Reindex API">reindex API</a> request copies documents from the
<code class="literal">logs</code> data stream to the <code class="literal">new_logs</code> data stream. The request uses a
<a class="xref" href="query-dsl-range-query.html" title="Range query"><code class="literal">range</code> query</a> to only reindex documents with a
timestamp within the last week. Note the request&#8217;s <code class="literal">op_type</code> is <code class="literal">create</code>.</p>
<a id="3b6c9619b318fd4ebd8db984faef41b7"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST /_reindex
{
  "source": {
    "index": "logs",
    "query": {
      "range": {
        "@timestamp": {
          "gte": "now-7d/d",
          "lte": "now/d"
        }
      }
    }
  },
  "dest": {
    "index": "new_logs",
    "op_type": "create"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/109.console"></div>
</div>
</details>
</li>
<li class="listitem">
<p>If you previously changed your ILM poll interval, change it back to its
original value when reindexing is complete. This prevents unnecessary load on
the master node.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following update cluster settings API request resets the
<code class="literal">indices.lifecycle.poll_interval</code> setting to its default value, 10 minutes.</p>
<a id="97d3523e74b9c0121f28907f5545c22c"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT /_cluster/settings
{
  "transient": {
    "indices.lifecycle.poll_interval": null
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/110.console"></div>
</div>
</details>
</li>
<li class="listitem">
Resume indexing using the new data stream. Searches on this stream will now
query your new data and the reindexed data.
</li>
<li class="listitem">
<p>Once you have verified that all reindexed data is available in the new
data stream, you can safely remove the old stream.</p>
<details>
<summary class="title"><span class="strong strong"><strong>Example</strong></span></summary>
<div class="content">
<p>The following <a class="xref" href="indices-delete-data-stream.html" title="Delete data stream API">delete data stream API</a> request
deletes the <code class="literal">logs</code> data stream. This request also deletes the stream&#8217;s backing
indices and any data they contain.</p>
<a id="9c863e1f9c2e91f78b6486ccb9cb42e7"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">DELETE /_data_stream/logs</pre>
</div>
<div class="console_widget" data-snippet="snippets/111.console"></div>
</div>
</details>
</li>
</ol>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="use-a-data-stream.html">« Use a data stream</a>
</span>
<span class="next">
<a href="search-your-data.html">Search your data »</a>
</span>
</div>
</div>
</body>
</html>
