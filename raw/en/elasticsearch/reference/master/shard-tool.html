<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">elasticsearch-shard
        | Elasticsearch Reference [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [master]" /><link rel="up" href="commands.html" title="Command line tools" /><link rel="prev" href="setup-passwords.html" title="elasticsearch-setup-passwords" /><link rel="next" href="syskeygen.html" title="elasticsearch-syskeygen" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="master" /></head><body><div xmlns="" class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="commands.html">Command line tools</a></span> » <span class="breadcrumb-node">elasticsearch-shard</span></div><div xmlns="" class="navheader"><span class="prev"><a href="setup-passwords.html">
              « 
              elasticsearch-setup-passwords</a>
           
        </span><span class="next">
           
          <a href="syskeygen.html">elasticsearch-syskeygen
               »
            </a></span></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="shard-tool"></a>elasticsearch-shard<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/commands/shard-tool.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>In some cases the Lucene index or translog of a shard copy can become
corrupted. The <code class="literal">elasticsearch-shard</code> command enables you to remove corrupted
parts of the shard if a good copy of the shard cannot be recovered
automatically or restored from backup.</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">You will lose the corrupted data when you run <code class="literal">elasticsearch-shard</code>.  This tool
should only be used as a last resort if there is no way to recover from another
copy of the shard or restore a snapshot.</p></div></div><p>When Elasticsearch detects that a shard’s data is corrupted, it fails that
shard copy and refuses to use it. Under normal conditions, the shard is
automatically recovered from another copy. If no good copy of the shard is
available and you cannot restore from backup, you can use <code class="literal">elasticsearch-shard</code>
to remove the corrupted data and restore access to any remaining data in
unaffected segments.</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">Stop Elasticsearch before running <code class="literal">elasticsearch-shard</code>.</p></div></div><p>To remove corrupted shard data use the <code class="literal">remove-corrupted-data</code> subcommand.</p><p>There are two ways to specify the path:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">Specify the index name and shard name with the <code class="literal">--index</code> and <code class="literal">--shard-id</code>
options.</li><li class="listitem">Use the <code class="literal">--dir</code> option to specify the full path to the corrupted index or
translog files.</li></ul></div><h3><a id="_removing_corrupted_data"></a>Removing corrupted data<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/commands/shard-tool.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3><p><code class="literal">elasticsearch-shard</code> analyses the shard copy and provides an overview of the
corruption found. To proceed you must then confirm that you want to remove the
corrupted data.</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p xmlns="http://www.w3.org/1999/xhtml">Back up your data before running <code class="literal">elasticsearch-shard</code>. This is a destructive
operation that removes corrupted data from the shard.</p></div></div><div xmlns="" class="pre_wrapper lang-txt"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-txt">$ bin/elasticsearch-shard remove-corrupted-data --index twitter --shard-id 0


    WARNING: Elasticsearch MUST be stopped before running this tool.

  Please make a complete backup of your index before using this tool.


Opening Lucene index at /var/lib/elasticsearchdata/indices/P45vf_YQRhqjfwLMUvSqDw/0/index/

 &gt;&gt; Lucene index is corrupted at /var/lib/elasticsearchdata/indices/P45vf_YQRhqjfwLMUvSqDw/0/index/

Opening translog at /var/lib/elasticsearchdata/indices/P45vf_YQRhqjfwLMUvSqDw/0/translog/


 &gt;&gt; Translog is clean at /var/lib/elasticsearchdata/indices/P45vf_YQRhqjfwLMUvSqDw/0/translog/


  Corrupted Lucene index segments found - 32 documents will be lost.

            WARNING:              YOU WILL LOSE DATA.

Continue and remove docs from the index ? Y

WARNING: 1 broken segments (containing 32 documents) detected
Took 0.056 sec total.
Writing...
OK
Wrote new segments file "segments_c"
Marking index with the new history uuid : 0pIBd9VTSOeMfzYT6p0AsA
Changing allocation id V8QXk-QXSZinZMT-NvEq4w to tjm9Ve6uTBewVFAlfUMWjA

You should run the following command to allocate this shard:

POST /_cluster/reroute
{
  "commands" : [
    {
      "allocate_stale_primary" : {
        "index" : "index42",
        "shard" : 0,
        "node" : "II47uXW2QvqzHBnMcl2o_Q",
        "accept_data_loss" : false
      }
    }
  ]
}

You must accept the possibility of data loss by changing parameter `accept_data_loss` to `true`.

Deleted corrupt marker corrupted_FzTSBSuxT7i3Tls_TgwEag from /var/lib/elasticsearchdata/indices/P45vf_YQRhqjfwLMUvSqDw/0/index/</pre></div><p>When you use <code class="literal">elasticsearch-shard</code> to drop the corrupted data, the shard’s
allocation ID changes. After restarting the node, you must use the
<a class="link" href="cluster-reroute.html" title="Cluster Reroute">cluster reroute API</a> to tell Elasticsearch to use the new
ID. The <code class="literal">elasticsearch-shard</code> command shows the request that
you need to submit.</p><p>You can also use the <code class="literal">-h</code> option to get a list of all options and parameters
that the <code class="literal">elasticsearch-shard</code> tool supports.</p></div><div xmlns="" class="navfooter"><span class="prev"><a href="setup-passwords.html">
              « 
              elasticsearch-setup-passwords</a>
           
        </span><span class="next">
           
          <a href="syskeygen.html">elasticsearch-syskeygen
               »
            </a></span></div></body></html>