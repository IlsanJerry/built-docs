<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Rollup search
        | Elasticsearch Reference [master]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [master]" /><link rel="up" href="rollup-apis.html" title="Rollup APIs" /><link rel="prev" href="rollup-get-rollup-index-caps.html" title="Get rollup index capabilities API" /><link rel="next" href="rollup-job-config.html" title="Rollup job configuration" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="master" /></head><body><div xmlns="" class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="rest-apis.html">REST APIs</a></span> » <span class="breadcrumb-link"><a href="rollup-apis.html">Rollup APIs</a></span> » <span class="breadcrumb-node">Rollup search</span></div><div xmlns="" class="navheader"><span class="prev"><a href="rollup-get-rollup-index-caps.html">
              « 
              Get rollup index capabilities API</a>
           
        </span><span class="next">
           
          <a href="rollup-job-config.html">Rollup job configuration
               »
            </a></span></div><div class="xpack section"><div class="titlepage"><div><div><h2 class="title"><a id="rollup-search"></a>Rollup search<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a><a xmlns="" class="xpack_tag" href="/subscriptions"></a></h2></div></div></div><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><p>This functionality is experimental and may be changed or removed completely in a future release. Elastic will take a best effort approach to fix any issues, but experimental features are not subject to the support SLA of official GA features.</p></div></div><p>The Rollup Search endpoint allows searching rolled-up data using the standard query DSL.  The Rollup Search endpoint
is needed because, internally, rolled-up documents utilize a different document structure than the original data.  The
Rollup Search endpoint rewrites standard query DSL into a format that matches the rollup documents, then takes the response
and rewrites it back to what a client would expect given the original query.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_request_21"></a>Request<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p><code class="literal">GET {index}/_rollup_search</code></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_path_parameters_10"></a>Path Parameters<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">index</code></span></dt><dd>(string) Index, indices or index-pattern to execute a rollup search against.  This can include both rollup and non-rollup
indices.</dd></dl></div><p>Rules for the <code class="literal">index</code> parameter:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">At least one index/index-pattern must be specified.  This can be either a rollup or non-rollup index.  Omitting the index parameter,
or using <code class="literal">_all</code>, is not permitted</li><li class="listitem">Multiple non-rollup indices may be specified</li><li class="listitem">Only one rollup index may be specified.  If more than one are supplied an exception will be thrown</li><li class="listitem">Index patterns may be used, but if they match more than one rollup index an exception will be thrown.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_request_body_5"></a>Request Body<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The request body supports a subset of features from the regular Search API.  It supports:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">query</code> param for specifying an DSL query, subject to some limitations (see <a class="xref" href="rollup-search-limitations.html" title="Rollup Search Limitations"><em>Rollup Search Limitations</em></a> and <a class="xref" href="rollup-agg-limitations.html" title="Rollup Aggregation Limitations"><em>Rollup Aggregation Limitations</em></a></li><li class="listitem"><code class="literal">aggregations</code> param for specifying aggregations</li></ul></div><p>Functionality that is not available:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">size</code>: because rollups work on pre-aggregated data, no search hits can be returned and so size must be set to zero or
omitted entirely.</li><li class="listitem"><code class="literal">highlighter</code>, <code class="literal">suggestors</code>, <code class="literal">post_filter</code>, <code class="literal">profile</code>, <code class="literal">explain</code> are similarly disallowed</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_historical_only_search_example"></a>Historical-only search example<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Imagine we have an index named <code class="literal">sensor-1</code> full of raw data, and we have created a rollup job with the following configuration:</p><div xmlns="" class="pre_wrapper lang-console"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-console">PUT _rollup/job/sensor
{
    "index_pattern": "sensor-*",
    "rollup_index": "sensor_rollup",
    "cron": "*/30 * * * * ?",
    "page_size" :1000,
    "groups" : {
      "date_histogram": {
        "field": "timestamp",
        "fixed_interval": "1h",
        "delay": "7d"
      },
      "terms": {
        "fields": ["node"]
      }
    },
    "metrics": [
        {
            "field": "temperature",
            "metrics": ["min", "max", "sum"]
        },
        {
            "field": "voltage",
            "metrics": ["avg"]
        }
    ]
}</pre></div><div xmlns="" class="console_widget" data-snippet="snippets/1546.console"></div><p>This rolls up the <code class="literal">sensor-*</code> pattern and stores the results in <code class="literal">sensor_rollup</code>.  To search this rolled up data, we
need to use the <code class="literal">_rollup_search</code> endpoint.  However, you’ll notice that we can use regular query DSL to search the
rolled-up data:</p><div xmlns="" class="pre_wrapper lang-console"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-console">GET /sensor_rollup/_rollup_search
{
    "size": 0,
    "aggregations": {
        "max_temperature": {
            "max": {
                "field": "temperature"
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet="snippets/1547.console"></div><p>The query is targeting the <code class="literal">sensor_rollup</code> data, since this contains the rollup data as configured in the job.  A <code class="literal">max</code>
aggregation has been used on the <code class="literal">temperature</code> field, yielding the following response:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
  "took" : 102,
  "timed_out" : false,
  "terminated_early" : false,
  "_shards" : ... ,
  "hits" : {
    "total" : {
        "value": 0,
        "relation": "eq"
    },
    "max_score" : 0.0,
    "hits" : [ ]
  },
  "aggregations" : {
    "max_temperature" : {
      "value" : 202.0
    }
  }
}</pre></div><p>The response is exactly as you’d expect from a regular query + aggregation; it provides some metadata about the request
(<code class="literal">took</code>, <code class="literal">_shards</code>, etc), the search hits (which is always empty for rollup searches), and the aggregation response.</p><p>Rollup searches are limited to functionality that was configured in the rollup job.  For example, we are not able to calculate
the average temperature because <code class="literal">avg</code> was not one of the configured metrics for the <code class="literal">temperature</code> field.  If we try
to execute that search:</p><div xmlns="" class="pre_wrapper lang-console"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-console">GET sensor_rollup/_rollup_search
{
    "size": 0,
    "aggregations": {
        "avg_temperature": {
            "avg": {
                "field": "temperature"
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet="snippets/1548.console"></div><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "error" : {
        "root_cause" : [
            {
                "type" : "illegal_argument_exception",
                "reason" : "There is not a rollup job that has a [avg] agg with name [avg_temperature] which also satisfies all requirements of query.",
                "stack_trace": ...
            }
        ],
        "type" : "illegal_argument_exception",
        "reason" : "There is not a rollup job that has a [avg] agg with name [avg_temperature] which also satisfies all requirements of query.",
        "stack_trace": ...
    },
    "status": 400
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_searching_both_historical_rollup_and_non_rollup_data"></a>Searching both historical rollup and non-rollup data<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/master/docs/reference/rollup/apis/rollup-search.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The Rollup Search API has the capability to search across both "live", non-rollup data as well as the aggregated rollup
data.  This is done by simply adding the live indices to the URI:</p><div xmlns="" class="pre_wrapper lang-console"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-console">GET sensor-1,sensor_rollup/_rollup_search <a id="CO515-1"></a><i xmlns="" class="conum" data-value="1"></i>
{
    "size": 0,
    "aggregations": {
        "max_temperature": {
            "max": {
                "field": "temperature"
            }
        }
    }
}</pre></div><div xmlns="" class="console_widget" data-snippet="snippets/1549.console"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO515-1"><i xmlns="" class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>Note the URI now searches <code class="literal">sensor-1</code> and <code class="literal">sensor_rollup</code> at the same time</p></td></tr></table></div><p>When the search is executed, the Rollup Search endpoint will do two things:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">The original request will be sent to the non-rollup index unaltered</li><li class="listitem">A rewritten version of the original request will be sent to the rollup index.</li></ol></div><p>When the two responses are received, the endpoint will then rewrite the rollup response and merge the two together.
During the merging process, if there is any overlap in buckets between the two responses, the buckets from the non-rollup
index will be used.</p><p>The response to the above query will look as expected, despite spanning rollup and non-rollup indices:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
  "took" : 102,
  "timed_out" : false,
  "terminated_early" : false,
  "_shards" : ... ,
  "hits" : {
    "total" : {
        "value": 0,
        "relation": "eq"
    },
    "max_score" : 0.0,
    "hits" : [ ]
  },
  "aggregations" : {
    "max_temperature" : {
      "value" : 202.0
    }
  }
}</pre></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="rollup-get-rollup-index-caps.html">
              « 
              Get rollup index capabilities API</a>
           
        </span><span class="next">
           
          <a href="rollup-job-config.html">Rollup job configuration
               »
            </a></span></div></body></html>