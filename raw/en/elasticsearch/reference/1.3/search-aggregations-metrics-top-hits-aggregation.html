<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Top hits Aggregation
        | Elasticsearch Reference [1.3]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch Reference [1.3]" /><link rel="up" href="search-aggregations.html" title="Aggregations" /><link rel="prev" href="search-aggregations-metrics-geobounds-aggregation.html" title="Geo Bounds Aggregation" /><link rel="next" href="search-aggregations-bucket-global-aggregation.html" title="Global Aggregation" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Elasticsearch/Reference/1.3" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="1.3" /></head><body><div xmlns="" class="page_header">You are looking at documentation for an older release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch Reference
      [1.3]
    </a></span> » <span class="breadcrumb-link"><a href="search.html">Search APIs</a></span> » <span class="breadcrumb-link"><a href="search-aggregations.html">Aggregations</a></span> » <span class="breadcrumb-node">Top hits Aggregation</span></div><div xmlns="" class="navheader"><span class="prev"><a href="search-aggregations-metrics-geobounds-aggregation.html">
              « 
              Geo Bounds Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-global-aggregation.html">Global Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="search-aggregations-metrics-top-hits-aggregation"></a>Top hits Aggregation<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/1.3/docs/reference/search/aggregations/metrics/tophits-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><div xmlns="" class="note admon"><div class="icon"><img alt="Note" src="images/icons/note.png" /></div><div class="admon_content"><p>Added in 1.3.0. </p></div></div><p>A <code class="literal">top_hits</code> metric aggregator keeps track of the most relevant document being aggregated. This aggregator is intended
to be used as a sub aggregator, so that the top matching documents can be aggregated per bucket.</p><p>The <code class="literal">top_hits</code> aggregator can effectively be used to group result sets by certain fields via a bucket aggregator.
One or more bucket aggregators determines by which properties a result set get sliced into.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_options"></a>Options<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/1.3/docs/reference/search/aggregations/metrics/tophits-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><code class="literal">from</code> - The offset from the first result you want to fetch.</li><li class="listitem"><code class="literal">size</code> - The maximum number of top matching hits to return per bucket. By default the top three matching hits are returned.</li><li class="listitem"><code class="literal">sort</code> - How the top matching hits should be sorted. By default the hits are sorted by the score of the main query.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_supported_per_hit_features"></a>Supported per hit features<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/1.3/docs/reference/search/aggregations/metrics/tophits-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>The top_hits aggregation returns regular search hits, because of this many per hit features can be supported:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><a class="link" href="search-request-highlighting.html" title="Highlighting">Highlighting</a></li><li class="listitem"><a class="link" href="search-request-explain.html" title="Explain">Explain</a></li><li class="listitem"><a class="link" href="search-request-named-queries-and-filters.html" title="Named Queries and Filters">Named filters and queries</a></li><li class="listitem"><a class="link" href="search-request-source-filtering.html" title="Source filtering">Source filtering</a></li><li class="listitem"><a class="link" href="search-request-script-fields.html" title="Script Fields">Script fields</a></li><li class="listitem"><a class="link" href="search-request-fielddata-fields.html" title="Field Data Fields">Fielddata fields</a></li><li class="listitem"><a class="link" href="search-request-version.html" title="Version">Include versions</a></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_example_2"></a>Example<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/1.3/docs/reference/search/aggregations/metrics/tophits-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>In the following example we group the questions by tag and per tag we show the last active question. For each question
only the title field is being included in the source.</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
    "aggs": {
        "top-tags": {
            "terms": {
                "field": "tags",
                "size": 3
            },
            "aggs": {
                "top_tag_hits": {
                    "top_hits": {
                        "sort": [
                            {
                                "last_activity_date": {
                                    "order": "desc"
                                }
                            }
                        ],
                        "_source": {
                            "include": [
                                "title"
                            ]
                        },
                        "size" : 1
                    }
                }
            }
        }
    }
}</pre></div><p>Possible response snippet:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">"aggregations": {
  "top-tags": {
     "buckets": [
        {
           "key": "windows-7",
           "doc_count": 25365,
           "top_tags_hits": {
              "hits": {
                 "total": 25365,
                 "max_score": 1,
                 "hits": [
                    {
                       "_index": "stack",
                       "_type": "question",
                       "_id": "602679",
                       "_score": 1,
                       "_source": {
                          "title": "Windows port opening"
                       },
                       "sort": [
                          1370143231177
                       ]
                    }
                 ]
              }
           }
        },
        {
           "key": "linux",
           "doc_count": 18342,
           "top_tags_hits": {
              "hits": {
                 "total": 18342,
                 "max_score": 1,
                 "hits": [
                    {
                       "_index": "stack",
                       "_type": "question",
                       "_id": "602672",
                       "_score": 1,
                       "_source": {
                          "title": "Ubuntu RFID Screensaver lock-unlock"
                       },
                       "sort": [
                          1370143379747
                       ]
                    }
                 ]
              }
           }
        },
        {
           "key": "windows",
           "doc_count": 18119,
           "top_tags_hits": {
              "hits": {
                 "total": 18119,
                 "max_score": 1,
                 "hits": [
                    {
                       "_index": "stack",
                       "_type": "question",
                       "_id": "602678",
                       "_score": 1,
                       "_source": {
                          "title": "If I change my computers date / time, what could be affected?"
                       },
                       "sort": [
                          1370142868283
                       ]
                    }
                 ]
              }
           }
        }
     ]
  }
}</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_field_collapse_example"></a>Field collapse example<a xmlns="" href="https://github.com/elastic/elasticsearch/edit/1.3/docs/reference/search/aggregations/metrics/tophits-aggregation.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h3></div></div></div><p>Field collapsing or result grouping is a feature that logically groups a result set into groups and per group returns
top documents. The ordering of the groups is determined by the relevancy of the first document in a group. In
Elasticsearch this can be implemented via a bucket aggregator that wraps a <code class="literal">top_hits</code> aggregator as sub-aggregator.</p><p>In the example below we search across crawled webpages. For each webpage we store the body and the domain the webpage
belong to. By defining a <code class="literal">terms</code> aggregator on the <code class="literal">domain</code> field we group the result set of webpages by domain. The
<code class="literal">top_docs</code> aggregator is then defined as sub-aggregator, so that the top matching hits are collected per bucket.</p><p>Also a <code class="literal">max</code> aggregator is defined which is used by the <code class="literal">terms</code> aggregator’s order feature the return the buckets by
relevancy order of the most relevant document in a bucket.</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
  "query": {
    "match": {
      "body": "elections"
    }
  },
  "aggs": {
    "top-sites": {
      "terms": {
        "field": "domain",
        "order": {
          "top_hit": "desc"
        }
      },
      "aggs": {
        "top_tags_hits": {
          "top_hits": {}
        },
        "top_hit" : {
          "max": {
            "script": "_score"
          }
        }
      }
    }
  }
}</pre></div><p>At the moment the <code class="literal">max</code> (or <code class="literal">min</code>) aggregator is needed to make sure the buckets from the <code class="literal">terms</code> aggregator are
ordered according to the score of the most relevant webpage per domain. The <code class="literal">top_hits</code> aggregator isn’t a metric aggregator
and therefore can’t be used in the <code class="literal">order</code> option of the <code class="literal">terms</code> aggregator.</p></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="search-aggregations-metrics-geobounds-aggregation.html">
              « 
              Geo Bounds Aggregation</a>
           
        </span><span class="next">
           
          <a href="search-aggregations-bucket-global-aggregation.html">Global Aggregation
               »
            </a></span></div></body></html>