<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Extended Example
        | Elasticsearch: The Definitive Guide [master]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [master]" /><link rel="up" href="_looking_at_time.html" title="Looking at Time" /><link rel="prev" href="_returning_empty_buckets.html" title="Returning Empty Buckets" /><link rel="next" href="_the_sky_8217_s_the_limit.html" title="The Sky’s the Limit" /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/master" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="master" /><meta name="robots" content="noindex,nofollow" /></head><body><div class="page_header">This information may not apply to the latest version of Elasticsearch.
For the most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [master]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="_looking_at_time.html">Looking at Time</a></span> » <span class="breadcrumb-node">Extended Example</span></div><div class="navheader"><span class="prev"><a href="_returning_empty_buckets.html">
              « 
              Returning Empty Buckets</a>
           
        </span><span class="next">
           
          <a href="_the_sky_8217_s_the_limit.html">The Sky’s the Limit
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_extended_example"></a>Extended Example<a href="https://github.com/elastic/elasticsearch-definitive-guide/edit/master/300_Aggregations/35_date_histogram.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>Just as we’ve seen a dozen times already, buckets can be nested in buckets for
more-sophisticated behavior.<a id="id-1.7.6.16.2.1" class="indexterm"></a>
<a id="id-1.7.6.16.2.2" class="indexterm"></a>
<a id="id-1.7.6.16.2.3" class="indexterm"></a><a id="id-1.7.6.16.2.4" class="indexterm"></a>
<a id="id-1.7.6.16.2.5" class="indexterm"></a>  For illustration, we’ll build an aggregation
that shows the total sum of prices for all makes, listed by quarter.  Let’s also
calculate the sum of prices per individual make per quarter, so we can see
which car type is bringing in the most money to our business:</p><div class="pre_wrapper lang-sense"><pre class="programlisting prettyprint lang-sense">GET /cars/transactions/_search
{
   "size" : 0,
   "aggs": {
      "sales": {
         "date_histogram": {
            "field": "sold",
            "interval": "quarter", <a id="CO196-1"></a><i class="conum" data-value="1"></i>
            "format": "yyyy-MM-dd",
            "min_doc_count" : 0,
            "extended_bounds" : {
                "min" : "2014-01-01",
                "max" : "2014-12-31"
            }
         },
         "aggs": {
            "per_make_sum": {
               "terms": {
                  "field": "make"
               },
               "aggs": {
                  "sum_price": {
                     "sum": { "field": "price" } <a id="CO196-2"></a><i class="conum" data-value="2"></i>
                  }
               }
            },
            "total_sum": {
               "sum": { "field": "price" } <a id="CO196-3"></a><i class="conum" data-value="3"></i>
            }
         }
      }
   }
}</pre></div><div class="sense_widget" data-snippet="snippets/300_Aggregations/35_date_histogram.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO196-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>Note that we changed the interval from <code class="literal">month</code> to <code class="literal">quarter</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO196-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>Calculate the sum per make.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO196-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>And the total sum of all makes combined together.</p></td></tr></table></div><p>This returns a (heavily truncated) response:</p><div class="pre_wrapper lang-js"><pre class="programlisting prettyprint lang-js">{
....
"aggregations": {
   "sales": {
      "buckets": [
         {
            "key_as_string": "2014-01-01",
            "key": 1388534400000,
            "doc_count": 2,
            "total_sum": {
               "value": 105000
            },
            "per_make_sum": {
               "buckets": [
                  {
                     "key": "bmw",
                     "doc_count": 1,
                     "sum_price": {
                        "value": 80000
                     }
                  },
                  {
                     "key": "ford",
                     "doc_count": 1,
                     "sum_price": {
                        "value": 25000
                     }
                  }
               ]
            }
         },
...
}</pre></div><p>We can take this response and put it into a graph, <a id="id-1.7.6.16.7.1" class="indexterm"></a><a id="id-1.7.6.16.7.2" class="indexterm"></a>showing a line chart for
total sale price, and a bar chart for each individual make (per quarter), as shown in <a class="xref" href="_extended_example.html#date-histo-ts2" title="Figure 38. Sales per quarter, with distribution per make">Figure 38, “Sales per quarter, with distribution per make”</a>.</p><div class="figure"><a id="date-histo-ts2"></a><p class="title"><strong>Figure 38. Sales per quarter, with distribution per make</strong></p><div class="figure-contents"><div class="mediaobject"><img src="images/elas_29in02.png" alt="Sales per quarter, with distribution per make" /></div></div></div></div><div class="navfooter"><span class="prev"><a href="_returning_empty_buckets.html">
              « 
              Returning Empty Buckets</a>
           
        </span><span class="next">
           
          <a href="_the_sky_8217_s_the_limit.html">The Sky’s the Limit
               »
            </a></span></div></body></html>
