<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Adding a Metric to the Mix
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="_aggregation_test_drive.html" title="Aggregation Test-Drive" /><link rel="prev" href="_aggregation_test_drive.html" title="Aggregation Test-Drive" /><link rel="next" href="_buckets_inside_buckets.html" title="Buckets Inside Buckets" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="1.x" /><meta xmlns="" name="robots" content="noindex,nofollow" /></head><body><div xmlns="" class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="_aggregation_test_drive.html">Aggregation Test-Drive</a></span> » <span class="breadcrumb-node">Adding a Metric to the Mix</span></div><div xmlns="" class="navheader"><span class="prev"><a href="_aggregation_test_drive.html">
              « 
              Aggregation Test-Drive</a>
           
        </span><span class="next">
           
          <a href="_buckets_inside_buckets.html">Buckets Inside Buckets
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_adding_a_metric_to_the_mix"></a>Adding a Metric to the Mix<a xmlns="" href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/21_add_metric.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>The previous example told us the number of documents in each bucket, which is
useful.  <a id="id-1.7.4.22.2.1" class="indexterm"></a>
<a id="id-1.7.4.22.2.2" class="indexterm"></a>
<a id="id-1.7.4.22.2.3" class="indexterm"></a>But often, our applications require more-sophisticated metrics about
the documents.<a id="id-1.7.4.22.2.4" class="indexterm"></a>
<a id="id-1.7.4.22.2.5" class="indexterm"></a> For example, what is the average price of cars in each bucket?</p><p>To get this information, we need to tell Elasticsearch which metrics to calculate,
and on which fields. <a id="id-1.7.4.22.3.1" class="indexterm"></a>
<a id="id-1.7.4.22.3.2" class="indexterm"></a> This requires <span class="emphasis"><em>nesting</em></span> metrics inside the buckets.
Metrics will calculate mathematical statistics based on the values of documents
within a bucket.</p><p>Let’s go ahead and add <a id="id-1.7.4.22.4.1" class="indexterm"></a>an <code class="literal">average</code> metric to our car example:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
   "aggs": {
      "colors": {
         "terms": {
            "field": "color"
         },
         "aggs": { <a id="CO187-1"></a><i xmlns="" class="conum" data-value="1"></i>
            "avg_price": { <a id="CO187-2"></a><i xmlns="" class="conum" data-value="2"></i>
               "avg": {
                  "field": "price" <a id="CO187-3"></a><i xmlns="" class="conum" data-value="3"></i>
               }
            }
         }
      }
   }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/300_Aggregations/20_basic_example.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-1"><i xmlns="" class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
We add a new <code class="literal">aggs</code> level to hold the metric.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-2"><i xmlns="" class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
We then give the metric a name: <code class="literal">avg_price</code>.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO187-3"><i xmlns="" class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>
And finally, we define it as an <code class="literal">avg</code> metric over the <code class="literal">price</code> field.
</p></td></tr></table></div><p>As you can see, we took the previous example and tacked on a new <code class="literal">aggs</code> level.
This new aggregation level allows us to nest the <code class="literal">avg</code> metric inside the
<code class="literal">terms</code> bucket.  Effectively, this means we will generate an average for each
color.</p><p>Just like the <code class="literal">colors</code> example, we need to name our metric (<code class="literal">avg_price</code>) so we
can retrieve the values later.  Finally, we specify the metric itself (<code class="literal">avg</code>)
and what field we want the average to be calculated on (<code class="literal">price</code>):</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "avg_price": { <a id="CO188-1"></a><i xmlns="" class="conum" data-value="1"></i>
                  "value": 32500
               }
            },
            {
               "key": "blue",
               "doc_count": 2,
               "avg_price": {
                  "value": 20000
               }
            },
            {
               "key": "green",
               "doc_count": 2,
               "avg_price": {
                  "value": 21000
               }
            }
         ]
      }
   }
...
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO188-1"><i xmlns="" class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
New <code class="literal">avg_price</code> element in response
</p></td></tr></table></div><p>Although the response has changed minimally, the data we get out of it has grown
substantially.  Before, we knew there were four red cars.  Now we know that the
average price of red cars is $32,500.  This is something that you can plug directly
into reports or graphs.</p></div><div xmlns="" class="navfooter"><span class="prev"><a href="_aggregation_test_drive.html">
              « 
              Aggregation Test-Drive</a>
           
        </span><span class="next">
           
          <a href="_buckets_inside_buckets.html">Buckets Inside Buckets
               »
            </a></span></div></body></html>