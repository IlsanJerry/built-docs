<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Post Filter
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="_filtering_queries_and_aggregations.html" title="Filtering Queries and Aggregations" /><link rel="prev" href="_filter_bucket.html" title="Filter Bucket" /><link rel="next" href="_recap.html" title="Recap" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="1.x" /><meta xmlns="" name="robots" content="noindex,nofollow" /></head><body><div xmlns="" class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="_filtering_queries_and_aggregations.html">Filtering Queries and Aggregations</a></span> » <span class="breadcrumb-node">Post Filter</span></div><div xmlns="" class="navheader"><span class="prev"><a href="_filter_bucket.html">
              « 
              Filter Bucket</a>
           
        </span><span class="next">
           
          <a href="_recap.html">Recap
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_post_filter"></a>Post Filter<a xmlns="" href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/45_filtering.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>So far, we have a way to filter both the search results and aggregations (a
<code class="literal">filtered</code> query), as well as filtering individual portions of the aggregation
(<code class="literal">filter</code> bucket).</p><p>You may be thinking to yourself, "hmm…is there a way to filter <span class="emphasis"><em>just</em></span> the search
results but not the aggregation?"<a id="id-1.7.8.5.3.2" class="indexterm"></a>
<a id="id-1.7.8.5.3.3" class="indexterm"></a><a id="id-1.7.8.5.3.4" class="indexterm"></a>  The answer is to use a <code class="literal">post_filter</code>.</p><p>This is a top-level search-request element that accepts a filter.  The filter is
applied <span class="emphasis"><em>after</em></span> the query has executed (hence the <code class="literal">post</code> moniker: it runs
<span class="emphasis"><em>post query</em></span> execution).  Because it operates after the query has executed,
it does not affect the query scope—and thus does not affect the aggregations
either.</p><p>We can use this behavior to apply additional filters to our search
criteria that don’t affect things like categorical facets in your UI.  Let’s
design another search page for our car dealer.  This page will allow the user
to search for a car and filter by color.  Color choices are populated via an
aggregation:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
    "query": {
        "match": {
            "make": "ford"
        }
    },
    "post_filter": {    <a id="CO200-1"></a><i xmlns="" class="conum" data-value="1"></i>
        "term" : {
            "color" : "green"
        }
    },
    "aggs" : {
        "all_colors": {
            "terms" : { "field" : "color" }
        }
    }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/300_Aggregations/45_filtering.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO200-1"><i xmlns="" class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
The <code class="literal">post_filter</code> element is a <code class="literal">top-level</code> element and filters just the search hits.
</p></td></tr></table></div><p>The <code class="literal">query</code> portion is finding all <code class="literal">ford</code> cars.  We are then building a list of
colors with a <code class="literal">terms</code> aggregation.  Because aggregations operate in the query
scope, the list of colors will correspond with the colors that Ford cars are
painted.</p><p>Finally, the <code class="literal">post_filter</code> will filter the search results to show only green
<code class="literal">ford</code> cars.  This happens <span class="emphasis"><em>after</em></span> the query is executed, so the aggregations
are unaffected.</p><p>This is often important for coherent UIs.  Imagine that a user clicks a category in
your UI (for example, green).  The expectation is that the search results are filtered,
but <span class="emphasis"><em>not</em></span> the UI options.  If you applied a <code class="literal">filtered</code> query, the UI would
instantly transform to show <span class="emphasis"><em>only</em></span> <code class="literal">green</code> as an option—not what the user wants!</p><div xmlns="" class="warning admon"><div class="icon"><img alt="Warning" src="images/icons/warning.png" /></div><div class="admon_content"><h3>Performance consideration</h3><p xmlns="http://www.w3.org/1999/xhtml">Use a <code class="literal">post_filter</code> <span class="emphasis"><em>only</em></span> if you need to differentially filter search results
and aggregations. <a id="id-1.7.8.5.12.2.3" class="indexterm"></a>
<a id="id-1.7.8.5.12.2.4" class="indexterm"></a>Sometimes people will use <code class="literal">post_filter</code> for regular searches.</p><p xmlns="http://www.w3.org/1999/xhtml">Don’t do this!  The nature of the <code class="literal">post_filter</code> means it runs <span class="emphasis"><em>after</em></span> the query,
so any performance benefit of filtering (such as caches) is lost completely.</p><p xmlns="http://www.w3.org/1999/xhtml">The <code class="literal">post_filter</code> should be used only in combination with aggregations, and only
when you need differential filtering.</p></div></div></div><div xmlns="" class="navfooter"><span class="prev"><a href="_filter_bucket.html">
              « 
              Filter Bucket</a>
           
        </span><span class="next">
           
          <a href="_recap.html">Recap
               »
            </a></span></div></body></html>