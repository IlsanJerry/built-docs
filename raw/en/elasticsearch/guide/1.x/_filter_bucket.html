<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns="">Filter Bucket
        | Elasticsearch: The Definitive Guide [1.x]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [1.x]" /><link rel="up" href="_filtering_queries_and_aggregations.html" title="Filtering Queries and Aggregations" /><link rel="prev" href="_filtered_query.html" title="Filtered Query" /><link rel="next" href="_post_filter.html" title="Post Filter" /><meta xmlns="" name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta xmlns="" name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/1.x" /><meta xmlns="" name="DC.subject" content="Elasticsearch" /><meta xmlns="" name="DC.identifier" content="1.x" /><meta xmlns="" name="robots" content="noindex,nofollow" /></head><body><div xmlns="" class="page_header">This information applies to version 1.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div xmlns="" class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [1.x]
    </a></span> » <span class="breadcrumb-link"><a href="aggregations.html">Aggregations</a></span> » <span class="breadcrumb-link"><a href="_filtering_queries_and_aggregations.html">Filtering Queries and Aggregations</a></span> » <span class="breadcrumb-node">Filter Bucket</span></div><div xmlns="" class="navheader"><span class="prev"><a href="_filtered_query.html">
              « 
              Filtered Query</a>
           
        </span><span class="next">
           
          <a href="_post_filter.html">Post Filter
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="_filter_bucket"></a>Filter Bucket<a xmlns="" href="https://github.com/elastic/elasticsearch-definitive-guide/edit/1.x/300_Aggregations/45_filtering.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>But what if you would like to filter just the aggregation results?<a id="id-1.7.8.4.2.1" class="indexterm"></a>
<a id="id-1.7.8.4.2.2" class="indexterm"></a><a id="id-1.7.8.4.2.3" class="indexterm"></a>
<a id="id-1.7.8.4.2.4" class="indexterm"></a>  Imagine we
are building the search page for our car dealership.  We want to display
search results according to what the user searches for.  But we also want
to enrich the page by including the average price of cars (matching the search)
that were sold in the last month.</p><p>We can’t use simple scoping here, since there are two different criteria.  The
search results must match <code class="literal">ford</code>, but the aggregation results must match <code class="literal">ford</code>
AND <code class="literal">sold &gt; now - 1M</code>.</p><p>To solve this problem, we can use a special bucket called <code class="literal">filter</code>.<a id="id-1.7.8.4.4.2" class="indexterm"></a><a id="id-1.7.8.4.4.3" class="indexterm"></a>
<a id="id-1.7.8.4.4.4" class="indexterm"></a>  You specify
a filter, and when documents match the filter’s criteria, they are added to the
bucket.</p><p>Here is the resulting query:</p><div xmlns="" class="pre_wrapper lang-js"><pre xmlns="http://www.w3.org/1999/xhtml" class="programlisting prettyprint lang-js">GET /cars/transactions/_search?search_type=count
{
   "query":{
      "match": {
         "make": "ford"
      }
   },
   "aggs":{
      "recent_sales": {
         "filter": { <a id="CO199-1"></a><i xmlns="" class="conum" data-value="1"></i>
            "range": {
               "sold": {
                  "from": "now-1M"
               }
            }
         },
         "aggs": {
            "average_price":{
               "avg": {
                  "field": "price" <a id="CO199-2"></a><i xmlns="" class="conum" data-value="2"></i>
               }
            }
         }
      }
   }
}</pre></div><div xmlns="" class="sense_widget" data-snippet="snippets/300_Aggregations/45_filtering.json"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO199-1"><i xmlns="" class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>
Using the <code class="literal">filter</code> bucket to apply a filter in addition to the <code class="literal">query</code> scope.
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO199-2"><i xmlns="" class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>
This <code class="literal">avg</code> metric will therefore average only docs that are both <code class="literal">ford</code> and sold in the last month.
</p></td></tr></table></div><p>Since the <code class="literal">filter</code> bucket operates like any other bucket, you are free to nest
other buckets and metrics inside.  All nested components will "inherit" the filter.
This allows you to filter selective portions of the aggregation as required.</p></div><div xmlns="" class="navfooter"><span class="prev"><a href="_filtered_query.html">
              « 
              Filtered Query</a>
           
        </span><span class="next">
           
          <a href="_post_filter.html">Post Filter
               »
            </a></span></div></body></html>