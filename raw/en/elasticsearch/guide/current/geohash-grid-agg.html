<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Geohash Grid Aggregation
        | Elasticsearch: The Definitive Guide [2.x]
      | Elastic
    </title><link rel="home" href="index.html" title="Elasticsearch: The Definitive Guide [2.x]" /><link rel="up" href="geo-aggs.html" title="Geo Aggregations" /><link rel="prev" href="geo-distance-agg.html" title="Geo Distance Aggregation" /><link rel="next" href="geo-bounds-agg.html" title="Geo Bounds Aggregation" /><meta name="DC.type" content="Learn/Docs/Legacy/Elasticsearch/Definitive Guide/2.x" /><meta name="DC.subject" content="Elasticsearch" /><meta name="DC.identifier" content="2.x" /><meta name="robots" content="noindex,nofollow" /></head><body><div class="page_header">This information applies to version 2.x of Elasticsearch. For the
most up to date information, see the current version of the
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">
Elasticsearch Reference</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elasticsearch: The Definitive Guide
      [2.x]
    </a></span> » <span class="breadcrumb-link"><a href="geoloc.html">Geolocation</a></span> » <span class="breadcrumb-link"><a href="geo-aggs.html">Geo Aggregations</a></span> » <span class="breadcrumb-node">Geohash Grid Aggregation</span></div><div class="navheader"><span class="prev"><a href="geo-distance-agg.html">
              « 
              Geo Distance Aggregation</a>
           
        </span><span class="next">
           
          <a href="geo-bounds-agg.html">Geo Bounds Aggregation
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="geohash-grid-agg"></a>Geohash Grid Aggregation</h2></div></div></div><p>The number of results returned by a query may be far too many to display each
geo-point individually on a map.<a id="id-1.8.5.6.2.1" class="indexterm"></a><a id="id-1.8.5.6.2.2" class="indexterm"></a> The <code class="literal">geohash_grid</code> aggregation buckets nearby
geo-points together by calculating the geohash for each point, at the level of
precision that you define.</p><p>The result is a grid of cells—​one cell per geohash—​that can be
displayed on a map. By changing the precision of the geohash, you can
summarize information across the whole world, by country, or by city block.</p><p>The aggregation is <span class="emphasis"><em>sparse</em></span>—it<a id="id-1.8.5.6.4.2" class="indexterm"></a> returns only cells that contain documents.
If your geohashes are too precise and too many buckets are generated, it will
return, by default, the 10,000 most populous cells—​those containing the
most documents.<a id="id-1.8.5.6.4.3" class="indexterm"></a> However, it still needs to generate <span class="emphasis"><em>all</em></span> the buckets in
order to figure out which are the most populous 10,000.  You need to control
the number of buckets generated by doing the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Limit the result with a <code class="literal">geo_bounding_box</code> query.</li><li class="listitem">Choose an appropriate <code class="literal">precision</code> for the size of your bounding box.</li></ol></div><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">GET /attractions/restaurant/_search
{
  "size" : 0,
  "query": {
    "constant_score": {
      "filter": {
        "geo_bounding_box": {
          "location": { <a id="CO241-1"></a><i class="conum" data-value="1"></i>
            "top_left": {
              "lat":  40.8,
              "lon": -74.1
            },
            "bottom_right": {
              "lat":  40.4,
              "lon": -73.7
            }
          }
        }
      }
    }
  },
  "aggs": {
    "new_york": {
      "geohash_grid": { <a id="CO241-2"></a><i class="conum" data-value="2"></i>
        "field":     "location",
        "precision": 5
      }
    }
  }
}</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO241-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>The bounding box limits the scope of the search to the greater New York area.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO241-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>Geohashes of precision <code class="literal">5</code> are approximately 5km x 5km.</p></td></tr></table></div><p>Geohashes with precision <code class="literal">5</code> measure about 25km<sup>2</sup> each, so 10,000 cells at
this precision would cover 250,000km<sup>2</sup>.  The bounding box that we specified
measures approximately 44km x 33km, or about 1,452km<sup>2</sup>, so we are well within
safe limits; we definitely won’t create too many buckets in memory.</p><p>The response from the preceding request looks like this:</p><div class="pre_wrapper lang-json"><pre class="programlisting prettyprint lang-json">...
"aggregations": {
  "new_york": {
     "buckets": [ <a id="CO242-1"></a><i class="conum" data-value="1"></i>
        {
           "key": "dr5rs",
           "doc_count": 2
        },
        {
           "key": "dr5re",
           "doc_count": 1
        }
     ]
  }
}
...</pre></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO242-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>Each bucket contains the geohash as the <code class="literal">key</code>.</p></td></tr></table></div><p>Again, we didn’t specify any sub-aggregations, so all we got back was the
document count. We could have asked for popular restaurant types, average
price, or other details.</p><div class="tip admon"><div class="icon"></div><div class="admon_content"><p>To plot these buckets on a map, you need a library that
understands how to convert a geohash into the equivalent bounding box or
central point. Libraries exist in JavaScript and other languages
that will perform this conversion for you, but you can also use information from
<a class="xref" href="geo-bounds-agg.html" title="Geo Bounds Aggregation">Geo Bounds Aggregation</a> to perform a similar job.</p></div></div></div><div class="navfooter"><span class="prev"><a href="geo-distance-agg.html">
              « 
              Geo Distance Aggregation</a>
           
        </span><span class="next">
           
          <a href="geo-bounds-agg.html">Geo Bounds Aggregation
               »
            </a></span></div></body></html>
