<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mutual TLS authentication between Kibana and Elasticsearch | Kibana Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="Kibana Guide [master]"/>
<link rel="up" href="using-kibana-with-security.html" title="Configuring security in Kibana"/>
<link rel="prev" href="configuring-tls.html" title="Encrypting communications in Kibana"/>
<link rel="next" href="xpack-security-audit-logging.html" title="Audit Logging"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/master"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Kibana Guide [master]</a></span>
»
<span class="breadcrumb-link"><a href="setup.html">Set Up Kibana</a></span>
»
<span class="breadcrumb-link"><a href="using-kibana-with-security.html">Configuring security in Kibana</a></span>
»
<span class="breadcrumb-node">Mutual TLS authentication between Kibana and Elasticsearch</span>
</div>
<div class="navheader">
<span class="prev">
<a href="configuring-tls.html">« Encrypting communications in Kibana</a>
</span>
<span class="next">
<a href="xpack-security-audit-logging.html">Audit Logging »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="elasticsearch-mutual-tls"></a>Mutual TLS authentication between Kibana and Elasticsearch<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/security/securing-communications/elasticsearch-mutual-tls.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>

<p>In a standard Transport Layer Security (TLS/SSL) configuration, the server presents a signed certificate to authenticate itself to the
client. In a mutual TLS configuration, the client also presents a signed certificate to authenticate itself to the server.</p>
<p>When X-Pack security is enabled on your cluster, each request that Kibana makes to Elasticsearch must be authenticated. Most requests made through Kibana to
Elasticsearch are authenticated by using the credentials of the logged-in user. There are, however, a few internal requests that the Kibana server
needs to make to the Elasticsearch cluster. For this reason, you must configure credentials for the Kibana server to use for those requests.</p>
<p>If Kibana has <code class="literal">elasticsearch.username</code> and <code class="literal">elasticsearch.password</code> configured, it will attempt to use these to authenticate to Elasticsearch via the
<a href="/guide/en/elasticsearch/reference/master/native-realm.html" class="ulink" target="_top">Native realm</a>. However, Kibana also supports mutual TLS authentication with Elasticsearch via a <a href="/guide/en/elasticsearch/reference/master/pki-realm.html" class="ulink" target="_top">Public
Key Infrastructure (PKI) realm</a>. To do so, Elasticsearch needs to verify the signature on the Kibana client certificate, and it also needs to map the
certificate&#8217;s distinguished name (DN) to the appropriate <code class="literal">kibana_system</code> role.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Using a PKI realm is a gold feature. For a comparison of the Elastic license levels, see <a href="/subscriptions" class="ulink" target="_top">the
subscription page</a>.</p>
</div>
</div>
<p>To configure Kibana and Elasticsearch to use mutual TLS authentication:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="using-kibana-with-security.html" title="Configuring security in Kibana">Set up Kibana to work with X-Pack security</a> with a username and password.
</li>
<li class="listitem">
<a class="xref" href="configuring-tls.html#configuring-tls-kib-es" title="Encrypting traffic between Kibana and Elasticsearch">Set up TLS encryption between Kibana and Elasticsearch</a>. At a minimum, this requires a server certificate for Elasticsearch.
</li>
<li class="listitem">
<p>Create a client certificate and private key for Kibana to use when connecting to Elasticsearch.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>This is not the same as the <a class="xref" href="configuring-tls.html#configuring-tls-browser-kib" title="Encrypting traffic between the browser and Kibana">server certificate</a> that Kibana will present to web browsers.</p>
</div>
</div>
<p>You may choose to generate a certificate and private key using <a href="/guide/en/elasticsearch/reference/master/certutil.html" class="ulink" target="_top">the Elasticsearch certutil tool</a>. At this point, you will have
already set up a certificate authority (CA) to sign the Elasticsearch server certificate. You may choose to use the same CA to sign the Kibana client
certificate. You would do this like so:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">bin/elasticsearch-certutil cert -ca elastic-stack-ca.p12 -name kibana-client</pre>
</div>
<p>This will generate a certificate and private key in a PKCS #12 keystore named <code class="literal">kibana-client.p12</code>. The certificate has a Common Name (CN) of
"kibana-client".</p>
<p>You will also need to use the CA certificate when setting up the PKI realm in Elasticsearch. While you could use the CA keystore in the above example
for this purpose, it is bad practice to expose the CA&#8217;s private key in such a manner. Instead, you can extract the CA certificate (without
its private key) like so:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">openssl pkcs12 -in kibana-client.p12 -cacerts -nokeys -out ca.crt</pre>
</div>
</li>
<li class="listitem">
<p>Configure a PKI realm and a Native realm in your Elasticsearch cluster:</p>
<p>By default, Elasticsearch provides a Native realm. However, to support both a PKI realm (for Kibana) and a Native realm (for end users), you must
configure each realm in <code class="literal">elasticsearch.yml</code>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.authc.realms.pki.realm1.order: 1
xpack.security.authc.realms.pki.realm1.certificate_authorities: "/path/to/ca.crt"
xpack.security.authc.realms.native.realm2.order: 2</pre>
</div>
</li>
<li class="listitem">
<p>Configure your Elasticsearch cluster to request client certificates:</p>
<p>By default, Elasticsearch will not request a client certificate when establishing a TLS connection. To change this, you must set up optional client
certificate authentication in <code class="literal">elasticsearch.yml</code>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">xpack.security.http.ssl.client_authentication: "optional"</pre>
</div>
</li>
<li class="listitem">
Restart your Elasticsearch cluster.
</li>
<li class="listitem">
<p>Use Kibana to create a <a class="xref" href="role-mappings.html" title="Role mappings">role mapping</a> for your new client certificate:</p>
<p>This role mapping will assign the <code class="literal">kibana_system</code> role to any user that matches the included mapping rule, which is set to equal the client
certificate&#8217;s DN attribute:</p>
<p class="screenshot"><span class="image"><img src="user/security/images/mutual-tls-role-mapping.png" alt="Role mapping for the Kibana client certificate"></span></p>
</li>
<li class="listitem">
<p>Configure Kibana to use the client certificate:</p>
<p>Assuming you used the Elasticsearch certutil tool to generate a certificate and private key in a PKCS #12 keystore, add the following values to
<code class="literal">kibana.yml</code>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">elasticsearch.ssl.keystore.path: "/path/to/kibana-client.p12"
elasticsearch.ssl.keystore.password: "decryption password"</pre>
</div>
<p>The decryption password should match what you entered when prompted by the Elasticsearch certutil tool.</p>
<p>You must also remove the <code class="literal">elasticsearch.username</code> and <code class="literal">elasticsearch.password</code> values from the configuration file. Otherwise, Kibana will
attempt to use those to authenticate via the Native realm.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>Alternatively, Kibana also supports using a client certificate and private key in PEM format with the <code class="literal">elasticsearch.ssl.certificate</code>
and <code class="literal">elasticsearch.ssl.key</code> settings. For more information, see <a class="xref" href="settings.html" title="Configuring Kibana">Kibana configuration settings</a>.</p>
</div>
</div>
</li>
<li class="listitem">
Restart Kibana.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>The steps above enable Kibana to authenticate to Elasticsearch using a certificate. However, end users will only be able to authenticate to
Kibana with a username and password. To allow end users to authenticate to Kibana using certificates, see <a class="xref" href="kibana-authentication.html#pki-authentication" title="Public key infrastructure (PKI) authentication">Kibana PKI
authentication</a>.</p>
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="configuring-tls.html">« Encrypting communications in Kibana</a>
</span>
<span class="next">
<a href="xpack-security-audit-logging.html">Audit Logging »</a>
</span>
</div>
</div>
</body>
</html>
