<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ES query | Kibana Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="Kibana Guide [master]"/>
<link rel="up" href="alert-types.html" title="Alerts"/>
<link rel="prev" href="alert-type-index-threshold.html" title="Index threshold"/>
<link rel="next" href="geo-alerting.html" title="Geo alerting"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/master"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Kibana Guide [master]</a></span>
»
<span class="breadcrumb-link"><a href="alerting-getting-started.html">Alerting and Actions</a></span>
»
<span class="breadcrumb-link"><a href="alert-types.html">Alerts</a></span>
»
<span class="breadcrumb-node">ES query</span>
</div>
<div class="navheader">
<span class="prev">
<a href="alert-type-index-threshold.html">« Index threshold</a>
</span>
<span class="next">
<a href="geo-alerting.html">Geo alerting »</a>
</span>
</div>
<div class="section xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="alert-type-es-query"></a>ES query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/stack-alerts/es-query.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>The ES query alert type is designed to run a user-configured Elasticsearch query over indices, compare the number of matches to a configured threshold, and schedule
actions to run when the threshold condition is met.</p>
<h4><a id="_creating_the_alert_2"></a>Creating the alert<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/stack-alerts/es-query.asciidoc">edit</a></h4>
<p>An ES query alert can be created from the <span class="strong strong"><strong>Create</strong></span> button in the <a class="xref" href="alert-management.html" title="Managing Alerts">alert management UI</a>. Fill in the <a class="xref" href="defining-alerts.html#defining-alerts-general-details" title="General alert details">general alert details</a>, then select <span class="strong strong"><strong>ES query</strong></span>.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/alert-types-es-query-select.png" alt="Choosing an ES query alert type">
</div>
</div>
<h4><a id="_defining_the_conditions_2"></a>Defining the conditions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/stack-alerts/es-query.asciidoc">edit</a></h4>
<p>The ES query alert has 5 clauses that define the condition to detect.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/alert-types-es-query-conditions.png" alt="Four clauses define the condition to detect">
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
Index
</span>
</dt>
<dd>
This clause requires an <span class="strong strong"><strong>index or index pattern</strong></span> and a <span class="strong strong"><strong>time field</strong></span> that will be used for the <span class="strong strong"><strong>time window</strong></span>.
</dd>
<dt>
<span class="term">
Size
</span>
</dt>
<dd>
This clause specifies the number of documents to pass to the configured actions when the the threshold condition is met.
</dd>
<dt>
<span class="term">
ES query
</span>
</dt>
<dd>
This clause specifies the ES DSL query to execute. The number of documents that match this query will be evaulated against the threshold
condition. Aggregations are not supported at this time.
</dd>
<dt>
<span class="term">
Threshold
</span>
</dt>
<dd>
This clause defines a threshold value and a comparison operator  (<code class="literal">is above</code>, <code class="literal">is above or equals</code>, <code class="literal">is below</code>, <code class="literal">is below or equals</code>, or <code class="literal">is between</code>). The number of documents that match the specified query is compared to this threshold.
</dd>
<dt>
<span class="term">
Time window
</span>
</dt>
<dd>
This clause determines how far back to search for documents, using the <span class="strong strong"><strong>time field</strong></span> set in the <span class="strong strong"><strong>index</strong></span> clause. Generally this value should be set to a value higher than the <span class="strong strong"><strong>check every</strong></span> value in the <a class="xref" href="defining-alerts.html#defining-alerts-general-details" title="General alert details">general alert details</a>, to avoid gaps in detection.
</dd>
</dl>
</div>
<h4><a id="_action_variables_3"></a>Action variables<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/stack-alerts/es-query.asciidoc">edit</a></h4>
<p>When the ES query alert condition is met, the following variables are available to use inside each action:</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<code class="literal">context.title</code>
</span>
</dt>
<dd>
A preconstructed title for the alert. Example: <code class="literal">alert term match alert query matched</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.message</code>
</span>
</dt>
<dd>
A preconstructed message for the alert. Example:<br>
<code class="literal">alert 'term match alert' is active:</code><br>
<code class="literal">- Value: 42</code><br>
<code class="literal">- Conditions Met: count greater than 4 over 5m</code><br>
<code class="literal">- Timestamp: 2020-01-01T00:00:00.000Z</code>
</dd>
<dt>
<span class="term">
<code class="literal">context.group</code>
</span>
</dt>
<dd>
The name of the action group associated with the condition. Example: <code class="literal">query matched</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.date</code>
</span>
</dt>
<dd>
The date, in ISO format, that the alert met the condition. Example: <code class="literal">2020-01-01T00:00:00.000Z</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.value</code>
</span>
</dt>
<dd>
The value of the alert that met the condition.
</dd>
<dt>
<span class="term">
<code class="literal">context.conditions</code>
</span>
</dt>
<dd>
A description of the condition. Example: <code class="literal">count greater than 4</code>.
</dd>
<dt>
<span class="term">
<code class="literal">context.hits</code>
</span>
</dt>
<dd>
The most recent ES documents that matched the query. Using the <a href="https://mustache.github.io/" class="ulink" target="_top">Mustache</a> template array syntax, you can iterate over these hits to get values from the ES documents into your actions.
</dd>
</dl>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/alert-types-es-query-example-action-variable.png" alt="Iterate over hits using Mustache template syntax">
</div>
</div>
<h4><a id="_testing_your_query"></a>Testing your query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/master/docs/user/alerting/stack-alerts/es-query.asciidoc">edit</a></h4>
<p>Use the <span class="strong strong"><strong>Test query</strong></span> feature to verify that your query DSL is valid.</p>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
When your query is valid
</span>
</dt>
<dd>
Valid queries will be executed against the configured <span class="strong strong"><strong>index</strong></span> using the configured <span class="strong strong"><strong>time window</strong></span>. The number of documents that
match the query will be displayed.
</dd>
</dl>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/alert-types-es-query-valid.png" alt="Test ES query returns number of matches when valid">
</div>
</div>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
When your query is invalid
</span>
</dt>
<dd>
An error message is shown if the query is invalid.
</dd>
</dl>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="user/alerting/images/alert-types-es-query-invalid.png" alt="Test ES query shows error when invalid">
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="alert-type-index-threshold.html">« Index threshold</a>
</span>
<span class="next">
<a href="geo-alerting.html">Geo alerting »</a>
</span>
</div>
</div>
</body>
</html>
