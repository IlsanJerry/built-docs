<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="Kibana provides you with several options to share *Discover* saved searches, dashboards, *Visualize Library* visualizations, and *Canvas* workpads with others, or on a website.">
<meta name="keywords" content="analyst, concept, task, reporting">
<title>Advanced Osquery | Kibana Guide [master] | Elastic</title>
<link rel="home" href="index.html" title="Kibana Guide [master]"/>
<link rel="up" href="osquery.html" title="Osquery"/>
<link rel="prev" href="osquery.html" title="Osquery"/>
<link rel="next" href="manage-osquery-integration.html" title="Manage the integration"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/master"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="master"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Kibana Guide [master]</a></span>
»
<span class="breadcrumb-link"><a href="osquery.html">Osquery</a></span>
»
<span class="breadcrumb-node">Advanced Osquery</span>
</div>
<div class="navheader">
<span class="prev">
<a href="osquery.html">« Osquery</a>
</span>
<span class="next">
<a href="manage-osquery-integration.html">Manage the integration »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="advanced-osquery"></a>Advanced Osquery<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/main/docs/osquery/advanced-osquery.asciidoc">edit</a></h2>
</div></div></div>
<h3><a id="osquery-map-fields"></a>Map result fields to ECS<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/main/docs/osquery/advanced-osquery.asciidoc">edit</a></h3>
<p>When you save queries or add queries to a pack, you can optionally map Osquery results or static values to fields in
the <a href="/guide/en/ecs/8.3/ecs-reference.html" class="ulink" target="_top">Elastic Common Schema</a> (ECS).
This standardizes your Osquery data for use across detections, machine learning,
and any other areas that rely on ECS-compliant data.
When the query is run, the results include the original <code class="literal">osquery.&lt;fields&gt;</code>
and the mapped ECS fields. For example, if you update a query to map <code class="literal">osquery.name</code> to <code class="literal">user.name</code>, the query results include both fields.</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Edit saved queries or queries in a pack to map fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
For <span class="strong strong"><strong>Saved queries</strong></span>: Open the <span class="strong strong"><strong>Saved queries</strong></span> tab, and then click the edit icon for the query that you want to map.
</li>
<li class="listitem">
For <span class="strong strong"><strong>packs</strong></span>: Open the <span class="strong strong"><strong>Packs</strong></span> tab, edit a pack, and then click the edit icon for the query that you want to map.
</li>
</ul>
</div>
</li>
<li class="listitem">
In the <span class="strong strong"><strong>ECS mapping</strong></span> section, select an <span class="strong strong"><strong>ECS field</strong></span> to map.
</li>
<li class="listitem">
<p>In the <span class="strong strong"><strong>Value</strong></span> column, use the dropdown on the left to choose what type of value to map to the ECS field:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Osquery value</strong></span>: Select an Osquery field. The fields available are based on the SQL query entered, and only include fields that the query returns. When the query runs, the ECS field is set dynamically to the value of the Osquery field selected.
</li>
<li class="listitem">
<span class="strong strong"><strong>Static value</strong></span>: Enter a static value. When the query runs, the ECS field is set to the value entered. For example, static fields can be used to apply <code class="literal">tags</code> or your preferred <code class="literal">event.category</code> to the query results.
</li>
</ul>
</div>
</li>
<li class="listitem">
Map more fields, as needed. To remove any mapped rows, click the delete icon.
</li>
<li class="listitem">
Save your changes.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Some ECS fields are restricted and cannot be mapped. These are not available in the ECS dropdown.
</li>
<li class="listitem">
Some ECS fields are restricted to a set of allowed values, like <a href="/guide/en/ecs/8.3/ecs-event.html#field-event-category" class="ulink" target="_top">event.category</a>. Use the <a href="/guide/en/ecs/8.3/ecs-field-reference.html" class="ulink" target="_top">ECS Field Reference</a> for help when mapping fields.
</li>
<li class="listitem">
Osquery date fields have a variety of data types (including integer, text, or bigint). When mapping an Osquery date field to an ECS date field, you might need to use SQL operators in the query to get an Elasticsearch-compatible
<a href="/guide/en/elasticsearch/reference/master/date.html" class="ulink" target="_top">date</a> type.
</li>
</ul>
</div>
</div>
</div>
<h3><a id="osquery-extended-tables"></a>Extended tables for Kubernetes queries<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/main/docs/osquery/advanced-osquery.asciidoc">edit</a></h3>
<p>In addition to the Osquery schema, the Elastic-provided version of Osquery also includes the following tables to support Kubernetes containers. These can be queried with live or scheduled queries.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">host_users</code>
</li>
<li class="listitem">
<code class="literal">host_groups</code>
</li>
<li class="listitem">
<code class="literal">host_processes</code>
</li>
</ul>
</div>
<p>When querying these tables, the expectation is that the <code class="literal">/etc/passwd</code>, <code class="literal">/etc/group</code>, and <code class="literal">/proc</code> are available in the container under <code class="literal">/hostfs</code> as:
<code class="literal">/hostfs/etc/passwd</code>, <code class="literal">/hostfs/etc/group</code>, and <code class="literal">/hostfs/proc</code>. For information about the fields available in these tables, see the
<a href="https://docs.elastic.co/en/integrations/osquery_manager#exported-fields" class="ulink" target="_top">exported fields</a> reference.</p>
<h3><a id="osquery-status"></a>Osquery status<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/main/docs/osquery/advanced-osquery.asciidoc">edit</a></h3>
<p>A query can have the following status:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<tbody>
<tr>
<td align="left" valign="top"><p>Successful</p></td>
<td align="left" valign="top"><p>The query successfully completed.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Failed</p></td>
<td align="left" valign="top"><p>The query encountered a problem, such as an issue with the query or the agent was disconnected, and might have failed.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Not yet responded</p></td>
<td align="left" valign="top"><p>The query has not been sent to the agent.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>Expired</p></td>
<td align="left" valign="top"><p>The action request timed out. The agent may be offline.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>If an agent is offline, the request status remains <span class="strong strong"><strong>pending</strong></span> as Kibana retries the request.
By default, a query request times out after five minutes. The time out applies to the time it takes
to deliver the action request to an agent to run a query. If the action completes after the timeout period,
the results are still returned.</p>
</div>
</div>
<h3><a id="osquery-results"></a>Osquery results<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/main/docs/osquery/advanced-osquery.asciidoc">edit</a></h3>
<p>When you run live or scheduled queries, the results are automatically
stored in an Elasticsearch index, so that you can search, analyze, and visualize this data in Kibana.
For a list of the Osquery fields that can be returned in query results,
refer to <a href="https://docs.elastic.co/en/integrations/osquery_manager#exported-fields" class="ulink" target="_top">exported fields</a>.
Query results can also include ECS fields, if the query has a defined ECS mapping.</p>
<p>Osquery responses include the following information:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Everything prefaced with <code class="literal">osquery.</code> is part of the query response. These fields are not mapped to ECS by default.
</li>
<li class="listitem">
Results include some ECS fields by default, such as <code class="literal">host.*</code> and <code class="literal">agent.*</code>, which provide information about the host that was queried.
</li>
<li class="listitem">
For live queries, the <code class="literal">action_data.query</code> is the query that was sent.
</li>
<li class="listitem">
For scheduled queries in a pack, the <code class="literal">action_id</code> has the format <code class="literal">pack_&lt;pack-name&gt;_&lt;query-ID&gt;</code>. You can use this information to look up the query that was run.
</li>
<li class="listitem">
By default, all query results are <a href="https://osquery.readthedocs.io/en/stable/deployment/logging/#snapshot-logs" class="ulink" target="_top">snapshot logs</a>
that represent a point in time with a set of results, with no
<a href="https://osquery.readthedocs.io/en/stable/deployment/logging/#differential-logs" class="ulink" target="_top">differentials</a>.
</li>
<li class="listitem">
Osquery data is stored in the <code class="literal">logs-osquery_manager.result-&lt;namespace&gt;</code> datastream, and the result row data is under the <code class="literal">osquery</code> property in the document.
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="osquery.html">« Osquery</a>
</span>
<span class="next">
<a href="manage-osquery-integration.html">Manage the integration »</a>
</span>
</div>
</div>
</body>
</html>
