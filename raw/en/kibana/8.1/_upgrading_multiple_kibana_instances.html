<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="A reference of the reporting settings administrators configure in kibana.yml.">
<meta name="keywords" content="administrator, reference, setup, reporting">
<title>Upgrading multiple Kibana instances | Kibana Guide [8.1] | Elastic</title>
<link rel="home" href="index.html" title="Kibana Guide [8.1]"/>
<link rel="up" href="upgrade.html" title="Upgrade Kibana"/>
<link rel="prev" href="upgrade.html" title="Upgrade Kibana"/>
<link rel="next" href="using-kibana-with-security.html" title="Configure security in Kibana"/>
<meta name="DC.type" content="Learn/Docs/Kibana/Reference/8.1"/>
<meta name="DC.subject" content="Kibana"/>
<meta name="DC.identifier" content="8.1"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Kibana Guide [8.1]</a></span>
»
<span class="breadcrumb-link"><a href="setup.html">Set up</a></span>
»
<span class="breadcrumb-link"><a href="upgrade.html">Upgrade Kibana</a></span>
»
<span class="breadcrumb-node">Upgrading multiple Kibana instances</span>
</div>
<div class="navheader">
<span class="prev">
<a href="upgrade.html">« Upgrade Kibana</a>
</span>
<span class="next">
<a href="using-kibana-with-security.html">Configure security in Kibana »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="_upgrading_multiple_kibana_instances"></a>Upgrading multiple Kibana instances<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h2>
</div></div></div>
<p>When upgrading several Kibana instances connected to the same Elasticsearch cluster,
ensure that all outdated instances are shut down before starting the upgrade.</p>
<p>Rolling upgrades are unsupported in Kibana. However, when outdated instances are shut down, you can start all upgraded instances in parallel,
which allows all instances to participate in the upgrade migration in parallel.</p>
<p>For large deployments with more than 10 Kibana instances, and more than 10,000 saved objects,
you can reduce the upgrade downtime by bringing up a single Kibana instance and waiting for it to
complete the upgrade migration before bringing up the remaining instances.</p>
<h3><a id="preventing-migration-failures"></a>Preventing migration failures<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h3>
<p>Review the common causes of Kibana upgrade failures and how to prevent them.</p>
<h4><a id="_timeout_exception_or_receive_timeout_transport_exception"></a>timeout_exception or receive_timeout_transport_exception<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>There is a known issue in 7.12.0 for users who tried the Fleet beta.
Upgrade migrations fail because of a large number of documents in the <code class="literal">.kibana</code> index, which causes Kibana to log errors such as:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Error: Unable to complete saved object migrations for the [.kibana] index. Please check the health of your Elasticsearch cluster and try again. Error: [receive_timeout_transport_exception]: [instance-0000000002][10.32.1.112:19541][cluster:monitor/task/get] request_id [2648] timed out after [59940ms]

Error: Unable to complete saved object migrations for the [.kibana] index. Please check the health of your Elasticsearch cluster and try again. Error: [timeout_exception]: Timed out waiting for completion of [org.elasticsearch.index.reindex.BulkByScrollTask@6a74c54]</pre>
</div>
<p>For instructions on how to mitigate the known issue, refer to <a href="https://github.com/elastic/kibana/issues/95321" class="ulink" target="_top">the GitHub issue</a>.</p>
<h4><a id="_corrupt_saved_objects"></a>Corrupt saved objects<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>To find and remedy problems caused by corrupt documents, we highly recommend testing your Kibana upgrade in a development cluster,
especially when there are custom integrations that create saved objects in your environment.</p>
<p>Saved objects that are corrupted through manual editing or integrations cause migration
failures with a log message, such as <code class="literal">Unable to migrate the corrupt Saved Object document ...</code>.
For a successful upgrade migration, you must fix or delete corrupt documents.</p>
<p>For example, you receive the following error message:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">Unable to migrate the corrupt saved object document with _id: 'marketing_space:dashboard:e3c5fc71-ac71-4805-bcab-2bcc9cc93275'. To allow migrations to proceed, please delete this document from the [.kibana_7.12.0_001] index.</pre>
</div>
<p>To delete the documents that cause migrations to fail, take the following steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Remove the write block which the migration system has placed on the previous index:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">PUT .kibana_7.12.1_001/_settings
{
  "index": {
    "blocks.write": false
  }
}</pre>
</div>
</li>
<li class="listitem">
<p>Delete the corrupt document:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">DELETE .kibana_7.12.0_001/_doc/marketing_space:dashboard:e3c5fc71-ac71-4805-bcab-2bcc9cc93275</pre>
</div>
</li>
<li class="listitem">
<p>Restart Kibana.</p>
<p>The dashboard with the <code class="literal">e3c5fc71-ac71-4805-bcab-2bcc9cc93275</code> ID that belongs to the <code class="literal">marketing_space</code> space <span class="strong strong"><strong>is no longer available</strong></span>.</p>
</li>
</ol>
</div>
<p>Be sure you have a snapshot before you delete the corrupt document. If you are unable to restore from a snapshot, it is recommended to also delete the <code class="literal">temp</code> and <code class="literal">target</code> indices the migration creates before you restart Kibana and retry the snapshot restore.</p>
<h4><a id="_user_defined_index_templates_that_cause_new_kibana_indices_to_have_incompatible_settings_or_mappings"></a>User defined index templates that cause new <code class="literal">.kibana*</code> indices to have incompatible settings or mappings<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>Matching index templates that specify <code class="literal">settings.refresh_interval</code> or <code class="literal">mappings</code> are known to interfere with Kibana upgrades.</p>
<p>To make sure the index templates won&#8217;t apply to new <code class="literal">.kibana*</code> indices, narrow down the data views of any user-defined index templates.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>In Kibana 6.5.0 and earlier, Kibana creates a <code class="literal">kibana_index_template:.kibana</code> index template
and uses a <code class="literal">.kibana</code> index pattern. You do not need to change or remove the index template.</p>
</div>
</div>
<h4><a id="_an_unhealthy_elasticsearch_cluster"></a>An unhealthy Elasticsearch cluster<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>Problems with your Elasticsearch cluster can prevent Kibana upgrades from succeeding. Ensure that your cluster has:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Enough free disk space, at least twice the amount of storage taken up by the <code class="literal">.kibana</code> and <code class="literal">.kibana_task_manager</code> indices
</li>
<li class="listitem">
Sufficient heap size
</li>
<li class="listitem">
A "green" cluster status
</li>
</ul>
</div>
<h4><a id="_different_versions_of_kibana_connected_to_the_same_elasticsearch_index"></a>Different versions of Kibana connected to the same Elasticsearch index<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>When you perform an upgrade migration of different Kibana versions, the migration can fail.
Ensure that all Kibana instances are running the same version, configuration, and plugins.</p>
<h4><a id="_incompatible_xpack_tasks_index_configuration_setting"></a>Incompatible <code class="literal">xpack.tasks.index</code> configuration setting<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<p>In Kibana 7.5.0 and earlier, when the task manager index is set to <code class="literal">.tasks</code> with the configuration setting <code class="literal">xpack.tasks.index: ".tasks"</code>,
upgrade migrations fail. In Kibana 7.5.1 and later, the incompatible configuration setting prevents upgrade migrations from starting.</p>
<h3><a id="resolve-migrations-failures"></a>Resolving migration failures<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h3>
<p>If Kibana unexpectedly terminates while migrating a saved object index, Kibana automatically attempts to
perform the migration again when the process restarts. Do not delete any saved objects indices to
to fix a failed migration. Unlike previous versions, Kibana 7.12.0 and
later does not require deleting indices to release a failed migration lock.</p>
<p>If upgrade migrations fail repeatedly, refer to
<a class="xref" href="_upgrading_multiple_kibana_instances.html#preventing-migration-failures" title="Preventing migration failures">preventing migration failures</a>.
When you address the root cause for the migration failure,
Kibana automatically retries the migration.
If you&#8217;re unable to resolve a failed migration, contact Support.</p>
<h3><a id="upgrade-migrations-rolling-back"></a>Rolling back to a previous version of Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h3>
<p>If you&#8217;ve followed <a class="xref" href="_upgrading_multiple_kibana_instances.html#preventing-migration-failures" title="Preventing migration failures">preventing migration failures</a>
and <a class="xref" href="_upgrading_multiple_kibana_instances.html#resolve-migrations-failures" title="Resolving migration failures">resolving migration failures</a>, and
Kibana is still unable to successfully upgrade, rollback Kibana until
you&#8217;re able to identify and fix the root cause.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Before you roll back Kibana, ensure that the version you want to roll back to is compatible with
your Elasticsearch cluster. If the version you want to roll back to is not compatible, you must also rollback Elasticsearch.
Any changes made after an upgrade are lost when you roll back to a previous version.</p>
</div>
</div>
<p>To roll back after a failed upgrade migration, you must also rollback the saved object indices to be compatible with the previous Kibana version.</p>
<h4><a id="_roll_back_by_restoring_a_backup_snapshot"></a>Roll back by restoring a backup snapshot<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Before proceeding, <a href="/guide/en/elasticsearch/reference/8.1/snapshots-take-snapshot.html" class="ulink" target="_top">take a snapshot</a> that contains the <code class="literal">kibana</code> feature state.
By default, snapshots include the <code class="literal">kibana</code> feature state.
</li>
<li class="listitem">
To make sure no Kibana instances are performing an upgrade migration, shut down all Kibana instances.
</li>
<li class="listitem">
To delete all saved object indices, use <code class="literal">DELETE /.kibana*</code>.
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/8.1/snapshots-restore-snapshot.html" class="ulink" target="_top">Restore</a> the <code class="literal">kibana</code> feature state from the snapshot.
</li>
<li class="listitem">
Start all Kibana instances on the older version you want to rollback to.
</li>
</ol>
</div>
<h4><a id="_not_recommended_roll_back_without_a_backup_snapshot"></a>(Not recommended) Roll back without a backup snapshot<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h4>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
To make sure no Kibana instances are performing an upgrade migration, shut down all Kibana instances.
</li>
<li class="listitem">
<a href="/guide/en/elasticsearch/reference/8.1/snapshots-take-snapshot.html" class="ulink" target="_top">Take a snapshot</a> that includes the <code class="literal">kibana</code> feature state. By default, snapshots include the <code class="literal">kibana</code> feature state.
</li>
<li class="listitem">
<p>Delete the version-specific indices created by the failed upgrade migration.</p>
<p>For example, to rollback from a failed upgrade
to v7.12.0, use <code class="literal">DELETE /.kibana_7.12.0_*,.kibana_task_manager_7.12.0_*</code>.</p>
</li>
<li class="listitem">
<p>Inspect the output of <code class="literal">GET /_cat/aliases</code>.</p>
<p>If the <code class="literal">.kibana</code> or <code class="literal">.kibana_task_manager</code> aliases are missing, you must create them manually.
Find the latest index from the output of <code class="literal">GET /_cat/indices</code> and create the missing alias to point to the latest index.
For example, if the <code class="literal">.kibana</code> alias is missing, and the latest index is <code class="literal">.kibana_3</code>, create a new alias using <code class="literal">POST /.kibana_3/_aliases/.kibana</code>.</p>
</li>
<li class="listitem">
To remove the write block from the roll back indices, use
<code class="literal">PUT /.kibana,.kibana_task_manager/_settings {"index.blocks.write": false}</code>
</li>
<li class="listitem">
Start Kibana on the older version you want to rollback to.
</li>
</ol>
</div>
<h3><a id="upgrade-migrations-old-indices"></a>Handling old <code class="literal">.kibana_N</code> indices<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/upgrade-migrations.asciidoc">edit</a></h3>
<p>After the migrations complete, multiple Kibana indices are created in Elasticsearch: (<code class="literal">.kibana_1</code>, <code class="literal">.kibana_2</code>, <code class="literal">.kibana_7.12.0</code> etc).
Kibana only uses the index that the <code class="literal">.kibana</code> and <code class="literal">.kibana_task_manager</code> aliases point to.
The other Kibana indices can be safely deleted, but are left around as a matter of historical record, and to facilitate rolling Kibana back to a previous version.</p>
<h3><a id="logging-config-changes"></a>Logging configuration changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/kibana/edit/8.1/docs/setup/upgrade/logging-configuration-changes.asciidoc">edit</a></h3>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p>Kibana 8.0.0 and later uses a new logging system. Before you upgrade, read the documentation for your Kibana version.</p>
</div>
</div>
<div class="informaltable">
<a id="logging-pattern-format-old-and-new-example"></a>
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter</th>
<th align="left" valign="top">Log record in <span class="strong strong"><strong>pattern</strong></span> format</th>
<th align="left" valign="top">Legacy log record in <span class="strong strong"><strong>text</strong></span> format</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>@timestamp</p></td>
<td align="left" valign="top"><p>ISO8601_TZ <code class="literal">2012-01-31T23:33:22.011-05:00</code></p></td>
<td align="left" valign="top"><p>Absolute <code class="literal">23:33:22.011</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>logger</p></td>
<td align="left" valign="top"><p><code class="literal">parent.child</code></p></td>
<td align="left" valign="top"><p><code class="literal">['parent', 'child']</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>level</p></td>
<td align="left" valign="top"><p><code class="literal">DEBUG</code></p></td>
<td align="left" valign="top"><p><code class="literal">['debug']</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>meta</p></td>
<td align="left" valign="top"><p>stringified JSON object <code class="literal">{"to": "v8"}</code></p></td>
<td align="left" valign="top"><p>N/A</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>pid</p></td>
<td align="left" valign="top"><p>can be configured as <code class="literal">%pid</code></p></td>
<td align="left" valign="top"><p>N/A</p></td>
</tr>
</tbody>
</table>
</div>
<div class="informaltable">
<a id="logging-json-format-old-and-new-example"></a>
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Parameter</th>
<th align="left" valign="top">Log record in <span class="strong strong"><strong>json</strong></span> format</th>
<th align="left" valign="top">Legacy log record <span class="strong strong"><strong>json</strong></span> format</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>@timestamp</p></td>
<td align="left" valign="top"><p>ISO8601_TZ <code class="literal">2012-01-31T23:33:22.011-05:00</code></p></td>
<td align="left" valign="top"><p>ISO8601 <code class="literal">2012-01-31T23:33:22.011Z</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>logger</p></td>
<td align="left" valign="top"><p><code class="literal">log.logger: parent.child</code></p></td>
<td align="left" valign="top"><p><code class="literal">tags: ['parent', 'child']</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>level</p></td>
<td align="left" valign="top"><p><code class="literal">log.level: DEBUG</code></p></td>
<td align="left" valign="top"><p><code class="literal">tags: ['debug']</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>meta</p></td>
<td align="left" valign="top"><p>merged in log record  <code class="literal">{... "to": "v8"}</code></p></td>
<td align="left" valign="top"><p>merged in log record  <code class="literal">{... "to": "v8"}</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>pid</p></td>
<td align="left" valign="top"><p><code class="literal">process.pid: 12345</code></p></td>
<td align="left" valign="top"><p><code class="literal">pid: 12345</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>type</p></td>
<td align="left" valign="top"><p>N/A</p></td>
<td align="left" valign="top"><p><code class="literal">type: log</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p>error</p></td>
<td align="left" valign="top"><p><code class="literal">{ message, name, stack }</code></p></td>
<td align="left" valign="top"><p><code class="literal">{ message, name, stack, code, signal }</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="upgrade.html">« Upgrade Kibana</a>
</span>
<span class="next">
<a href="using-kibana-with-security.html">Configure security in Kibana »</a>
</span>
</div>
</div>
</body>
</html>
