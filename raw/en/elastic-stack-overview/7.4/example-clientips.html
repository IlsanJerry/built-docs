<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Finding suspicious client IPs by using scripted metrics
        | Elastic Stack Overview [7.4]
      | Elastic
    </title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><link rel="home" href="index.html" title="Elastic Stack Overview [7.4]" /><link rel="up" href="dataframe-examples.html" title="Transform examples" /><link rel="prev" href="example-airline.html" title="Finding air carriers with the most delays" /><link rel="next" href="dataframe-troubleshooting.html" title="Troubleshooting transforms" /><meta name="description" content="Get started with the documentation for Elasticsearch, Kibana, Logstash, Beats, X-Pack, Elastic Cloud, Elasticsearch for Apache Hadoop, and our language clients." /><meta name="DC.type" content="Learn/Docs/Elastic Stack/Overview/7.4" /><meta name="DC.subject" content="Elastic Stack" /><meta name="DC.identifier" content="7.4" /></head><body><div class="page_header">You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">Elastic Stack Overview
      [7.4]
    </a></span> » <span class="breadcrumb-link"><a href="ml-dataframes.html">Transforms</a></span> » <span class="breadcrumb-link"><a href="dataframe-examples.html">Transform examples</a></span> » <span class="breadcrumb-node">Finding suspicious client IPs by using scripted metrics</span></div><div class="navheader"><span class="prev"><a href="example-airline.html">
              « 
              Finding air carriers with the most delays</a>
           
        </span><span class="next">
           
          <a href="dataframe-troubleshooting.html">Troubleshooting transforms
               »
            </a></span></div><div class="section"><div class="titlepage"><div><div><h2 class="title"><a id="example-clientips"></a>Finding suspicious client IPs by using scripted metrics<a href="https://github.com/elastic/stack-docs/edit/7.4/docs/en/stack/data-frames/dataframe-examples.asciidoc" class="edit_me" title="Edit this page on GitHub" rel="nofollow">edit</a></h2></div></div></div><p>With transforms, you can use
<a class="ulink" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.4/search-aggregations-metrics-scripted-metric-aggregation.html" target="_top">scripted
metric aggregations</a> on your data. These aggregations are flexible and make
it possible to perform very complex processing. Let’s use scripted metrics to
identify suspicious client IPs in the web log sample dataset.</p><p>We transform the data such that the new index contains the sum of bytes and the
number of distinct URLs, agents, incoming requests by location, and geographic
destinations for each client IP. We also use a scripted field to count the
specific types of HTTP responses that each client IP receives. Ultimately, the
example below transforms web log data into an entity centric index where the
entity is <code class="literal">clientip</code>.</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">POST _data_frame/transforms/_preview
{
  "source": {
    "index": "kibana_sample_data_logs",
    "query": { <a id="CO59-1"></a><i class="conum" data-value="1"></i>
      "range" : {
        "timestamp" : {
          "gte" : "now-30d/d"
        }
      }
    }
  },
  "dest" : { <a id="CO59-2"></a><i class="conum" data-value="2"></i>
    "index" : "sample_weblogs_by_clientip"
  },
  "pivot": {
    "group_by": {  <a id="CO59-3"></a><i class="conum" data-value="3"></i>
      "clientip": { "terms": { "field": "clientip" } }
      },
    "aggregations": {
      "url_dc": { "cardinality": { "field": "url.keyword" }},
      "bytes_sum": { "sum": { "field": "bytes" }},
      "geo.src_dc": { "cardinality": { "field": "geo.src" }},
      "agent_dc": { "cardinality": { "field": "agent.keyword" }},
      "geo.dest_dc": { "cardinality": { "field": "geo.dest" }},
      "responses.total": { "value_count": { "field": "timestamp" }},
      "responses.counts": { <a id="CO59-4"></a><i class="conum" data-value="4"></i>
        "scripted_metric": {
          "init_script": "state.responses = ['error':0L,'success':0L,'other':0L]",
          "map_script": """
            def code = doc['response.keyword'].value;
            if (code.startsWith('5') || code.startsWith('4')) {
              state.responses.error += 1 ;
            } else if(code.startsWith('2')) {
              state.responses.success += 1;
            } else {
              state.responses.other += 1;
            }
            """,
          "combine_script": "state.responses",
          "reduce_script": """
            def counts = ['error': 0L, 'success': 0L, 'other': 0L];
            for (responses in states) {
              counts.error += responses['error'];
              counts.success += responses['success'];
              counts.other += responses['other'];
            }
            return counts;
            """
          }
        },
      "timestamp.min": { "min": { "field": "timestamp" }},
      "timestamp.max": { "max": { "field": "timestamp" }},
      "timestamp.duration_ms": { <a id="CO59-5"></a><i class="conum" data-value="5"></i>
        "bucket_script": {
          "buckets_path": {
            "min_time": "timestamp.min.value",
            "max_time": "timestamp.max.value"
          },
          "script": "(params.max_time - params.min_time)"
        }
      }
    }
  }
}</pre></div><div class="console_widget" data-snippet="snippets/82.console"></div><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-1"><i class="conum" data-value="1"></i></a> </p></td><td valign="top" align="left"><p>This range query limits the transform to documents that are within the last
30 days at the point in time the transform checkpoint is processed.
For batch data frames this occurs once.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-2"><i class="conum" data-value="2"></i></a> </p></td><td valign="top" align="left"><p>This is the destination index for the data frame. It is ignored by
<code class="literal">_preview</code>.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-3"><i class="conum" data-value="3"></i></a> </p></td><td valign="top" align="left"><p>The data is grouped by the <code class="literal">clientip</code> field.</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-4"><i class="conum" data-value="4"></i></a> </p></td><td valign="top" align="left"><p>This <code class="literal">scripted_metric</code> performs a distributed operation on the web log data
to count specific types of HTTP responses (error, success, and other).</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO59-5"><i class="conum" data-value="5"></i></a> </p></td><td valign="top" align="left"><p>This <code class="literal">bucket_script</code> calculates the duration of the <code class="literal">clientip</code> access based
on the results of the aggregation.</p></td></tr></table></div><p>The preview shows you that the new index would contain data like this for each
client IP:</p><div class="pre_wrapper lang-console"><pre class="programlisting prettyprint lang-console">{
  "preview" : [
    {
      "geo" : {
        "src_dc" : 12.0,
        "dest_dc" : 9.0
      },
      "clientip" : "0.72.176.46",
      "agent_dc" : 3.0,
      "responses" : {
        "total" : 14.0,
        "counts" : {
          "other" : 0,
          "success" : 14,
          "error" : 0
        }
      },
      "bytes_sum" : 74808.0,
      "timestamp" : {
        "duration_ms" : 4.919943239E9,
        "min" : "2019-06-17T07:51:57.333Z",
        "max" : "2019-08-13T06:31:00.572Z"
      },
      "url_dc" : 11.0
    },
    ...
  }</pre></div><div class="console_widget" data-snippet="snippets/83.console"></div><p>This data frame makes it easier to answer questions such as:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">Which client IPs are transferring the most amounts of data?</li><li class="listitem">Which client IPs are interacting with a high number of different URLs?</li><li class="listitem">Which client IPs have high error rates?</li><li class="listitem">Which client IPs are interacting with a high number of destination countries?</li></ul></div></div><div class="navfooter"><span class="prev"><a href="example-airline.html">
              « 
              Finding air carriers with the most delays</a>
           
        </span><span class="next">
           
          <a href="dataframe-troubleshooting.html">Troubleshooting transforms
               »
            </a></span></div></body></html>
